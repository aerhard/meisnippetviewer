(function(n,w,E){var s={},B=s,h={RuntimeError:function(a,b){this.errorcode=a;this.message=b}};h.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""};h.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)};h.EventEnumerator=function(a,b){this.init(a,b)};h.EventEnumerator.prototype.init=function(a,b){if(!a)throw new h.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined");
this.node=a;this.next_evnt=null;this.EoI=!0;this.children=n(this.node).children();this.i_next=-1;this.proportion=b||{num:1,numbase:1};this.outputProportion=b||{num:1,numbase:1};this.read_ahead()};h.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;this.read_ahead();return a}throw new h.RuntimeError("MeiLib.LayerEnum:E01","End of Input.");};h.EventEnumerator.prototype.read_ahead=function(){this.beam_enumerator?this.beam_enumerator.EoI?(this.EoI=!0,this.beam_enumerator=
null,this.step_ahead()):(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1):this.step_ahead()};h.EventEnumerator.prototype.step_ahead=function(){++this.i_next;if(this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var a=n(this.next_evnt).prop("localName");"note"===a||"rest"===a||"mRest"===a||"chord"===a?this.EoI=!1:"beam"===a?(this.beam_enumerator=new h.EventEnumerator(this.next_evnt),this.beam_enumerator.EoI?this.EoI=!0:(this.next_evnt=this.beam_enumerator.nextEvent(),
this.EoI=!1)):"tuplet"===a&&(a={num:this.proportion.num*+this.next_evnt.getAttribute("num")||3,numbase:this.proportion.numbase*+this.next_evnt.getAttribute("numbase")||2},this.beam_enumerator=new h.EventEnumerator(this.next_evnt,a),this.beam_enumerator.EoI?(this.outputProportion=this.proportion,this.EoI=!0):(this.outputProportion=this.beam_enumerator.outputProportion,this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1))}else this.EoI=!0};h.durationOf=function(a,b){var c=function(d,a){return d.hasAttribute("grace")||
"clef"===a};IsSimpleEvent=function(d){return"note"===d||"rest"===d||"space"===d};var f=function(d,a){var l=n(d).attr("dur");if(!l)throw new h.RuntimeError("MeiLib.durationOf:E04","@dur of <b>note</b>, <b>rest</b> or <b>space</b> must be specified.");console.log(h.dotsMult(d)*h.dur2beats(Number(l),a));return h.dotsMult(d)*h.dur2beats(Number(l),a)},g=function(d,a,l){l||(l="1");var b=n(d).attr("dur"),c=h.dotsMult(d);if(b)return c*h.dur2beats(Number(b),a);n(d).find("note").each(function(){lyr_n=n(this).attr("layer");
if(!lyr_n||lyr_n===l){var a=n(this).attr("dur"),t=h.dotsMult(d);if(!b&&a)b=a,c=t;else if(b&&b!=a)throw new h.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.");}});if(b)return c*h.dur2beats(Number(b),a);throw new h.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.");},d=function(a,b){var t=0;n(a).children().each(function(){var a;a=this.localName;if(c(this,a))a=0;else if(IsSimpleEvent(a))a=f(this,
b);else if("chord"===a)a=g(this,b);else if("beam"===a)a=d(this,b);else if("tuplet"===a)a=l(this,b);else throw new h.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+a+"'");t+=a});return t},l=function(a,l){var b=+a.getAttribute("num")||3,c=+a.getAttribute("numbase")||2;return d(a,{count:l.count,unit:l.unit*c/b})},t=n(a).prop("localName");if(c(a,t))return 0;if(IsSimpleEvent(t))return f(a,b);if("mRest"===t)return b.count;if("chord"===t)return g(a,b);if("beam"===t)return d(a,b);if("tuplet"===
t)return l(a,b);throw new h.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+t+"'");};h.tstamp2id=function(a,b,c){a=Number(a);for(var f=0,g=new h.EventEnumerator(b),d,l,t,q;!g.EoI&&(l===E||0<l);)t=d,q=l,d=g.nextEvent(),l=a-(f+1),d.hasAttribute("grace")||"clef"===d.localName||(f+=h.durationOf(d,c)*g.outputProportion.numbase/g.outputProportion.num),m=c,e=d;if(l===E)return E;b=0>l?t&&q<Math.abs(l)?t:d:d;var k=function(d){if(d.hasAttribute("grace")||"clef"===d.localName){var a=g.nextEvent();
return k(a)||d}return d};b=k(b);c=n(b).attr("xml:id");c||(c=h.createPseudoUUID(),n(b).attr("xml:id",c));return c};h.XMLID=function(a){var b=n(a).attr("xml:id");b||(b=h.createPseudoUUID(),n(a).attr("xml:id",b));return b};h.id2tstamp=function(a,b){for(var c,f=0;f<b.length;++f){b[f].meter&&(c=b[f].meter);if(0===f&&!c)throw new h.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified");var g=h.sumUpUntil(a,b[f].layer,c);if(g.found)return f.toString()+"m+"+(g.beats+1).toString()}throw new h.RuntimeError("MeiLib.id2tstamp:E002",
'No event with xml:id="'+a+'" was found in the given MEI context.');};h.dur2beats=function(a,b){return b.unit/a};h.beats2dur=function(a,b){return b.unit/a};h.dotsMult=function(a){a=n(a).attr("dots");a=Number(a||"0");for(var b=1;0<a;--a)b+=1/Math.pow(2,a);return b};h.sumUpUntil=function(a,b,c){var f=function(b){var d,l,t;l=n(b);var q=l.prop("localName");if(b.hasAttribute("grace")||"clef"===q)return{beats:0,found:l.attr("xml:id")===a};if("note"===q||"rest"===q){if(l.attr("xml:id")===a)return{beats:0,
found:!0};d=Number(l.attr("dur"));if(!d)throw new h.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).");l.attr("dots");d=h.dotsMult(l)*h.dur2beats(d,c);return{beats:d,found:!1}}if("mRest"===q)return l.attr("xml:id")===a?{beats:0,found:!0}:{beats:c.count,found:!1};if("layer"===q||"beam"===q||"tuplet"===q){d=0;l=l.children();t=!1;for(b=0;b<l.length&&!t;++b)t=f(l[b]),d+=t.beats,t=t.found;return{beats:d,found:t}}if("chord"===q){l.attr("dur");if(l.attr("xml:id")===
a)return{beats:0,found:!0};if(b=l.attr("dur"))return l.find("[xml\\:id='"+a+"']").length?{beats:0,found:!0}:{beats:h.dur2beats(b,c),found:t};l=l.children();t=!1;for(b=0;b<l.length&&!t;++b)t=f(l[b]),d=t.beats,t=t.found;return{beats:d,found:t}}return{beats:0,found:!1}};return f(b)};h.SliceMEI=function(a,b){var c=function(d,a){n.each(d,function(d,l){a.noClef&&n(l).attr("clef.visible","false");a.noKey&&n(l).attr("key.sig.show","false");a.noMeter&&n(l).attr("meter.rend","false")})},f=b.staves;if(f)for(var g=
"",d="",l="",t=0;t<f.length;t++)g+=l+'[n="'+f[t]+'"]',d+=l+'[staff="'+f[t]+'"]',0===t&&(l=", ");l=a.cloneNode(!0);f&&n(l).find("staffDef").remove(":not("+g+")");if(b.noClef||b.noKey||b.noMeter)t=n(l).find("staffDef"),g=n(l).find("scoreDef"),c(g,b),c(t,b);b.noConnectors&&n(l).find("staffGrp").removeAttr("symbol");var q=n(l).find("section")[0],k=!1;n(q.childNodes).each(function(){k||("measure"===this.localName&&Number(n(this).attr("n"))===b.start_n?k=!0:q.removeChild(this));if(k){if(f){n(this).find("[staff]").remove(":not("+
d+")");var a=n(this).find("staff");n(a).each(function(){-1===n.inArray(Number(n(this).attr("n")),f)&&this.parentNode.removeChild(this)})}"measure"===this.localName&&Number(n(this).attr("n"))===b.end_n&&(k=!1)}});return l};h.Alt=function(a,b,c,f){this.elem=a;this.xmlID=b;this.altitems=[];this.parentID=c;this.tagname=f};h.Alt.prototype.getDefaultItem=function(){var a=function(a,c,f){var g;for(alt in a){if(a[alt].tagname===c)return a[alt];g||a[alt].tagname!==f||(g=a[alt])}return g};if("choice"===this.tagname)return a(this.altitems,
"corr","sic");if("app"===this.tagname)return a(this.altitems,"lem")};h.Variant=function(a,b,c,f,g,d){this.elem=a;this.xmlID=b;this.tagname=c;this.source=f;this.resp=g;this.n=d};h.MeiDoc=function(a){a&&this.init(a)};h.MeiDoc.prototype.init=function(a){this.xmlDoc=a;this.rich_head=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","meiHead")[0];this.rich_music=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","music")[0];this.rich_score=n(this.rich_music).find("score")[0];
this.parseSourceList();this.parseEditorList();this.parseALTs();this.initAltgroups();this.initSectionView()};h.MeiDoc.prototype.getRichScore=function(){return this.rich_score};h.MeiDoc.prototype.getPlainScore=function(){return this.plain_score};h.MeiDoc.prototype.getALTs=function(){return this.ALTs};h.MeiDoc.prototype.getSourceList=function(){return this.sourceList};h.MeiDoc.prototype.getEditorList=function(){return this.editorList};h.MeiDoc.prototype.parseSourceList=function(){return this.sources=
n(this.rich_head).find("sourceDesc").children()};h.MeiDoc.prototype.parseEditorList=function(){return this.editors=n(this.rich_head).find("titleStmt").children("editor")};h.MeiDoc.prototype.parseALTs=function(){var a,b;this.ALTs={};var c=n(this.rich_score).find("app, choice");for(a=0;a<c.length;a++){var f=c[a];b=f.parentNode;var g=n(f).find("rdg, lem, sic, corr"),d=new h.Alt(f,h.XMLID(f),h.XMLID(b),f.localName);d.altitems={};for(b=0;b<g.length;b++){var l=g[b],t=n(l).attr("source"),q=n(l).attr("resp"),
k=n(l).attr("n"),p=n(l).prop("localName"),r=h.XMLID(l);d.altitems[r]=new h.Variant(l,r,p,t,q,k)}this.ALTs[h.XMLID(f)]=d}};h.MeiDoc.prototype.initAltgroups=function(){var a,b;annots=n(this.rich_score).find('annot[type="appGrp"], annot[type="choiceGrp"]');this.altgroups={};for(a=0;a<annots.length;a++){altgroup=[];token_list=n(annots[a]).attr("plist").split(" ");for(b=0;b<token_list.length;b++)altgroup.push(token_list[b].replace("#",""));for(b in altgroup)this.altgroups[altgroup[b]]=altgroup}};h.MeiDoc.prototype.selectDefaultAlternative=
function(a){var b={};if("choice"===a.localName){var c=n(a).find("corr")[0];c?(b.alt_item_xml_id=h.XMLID(c),b.alt_item=c):(a=n(a).find("sic")[0])?(b.alt_item_xml_id=h.XMLID(a),b.alt_item=a):b={}}else(a=n(a).find("lem")[0])?(b.alt_item_xml_id=h.XMLID(a),b.alt_item=a):b={};return b};h.MeiDoc.prototype.initSectionView=function(a){a=a||{};this.sectionview_score=this.rich_score.cloneNode(!0);this.sectionplane={};var b=n(this.sectionview_score).find("app, choice"),c,f=this.sectionview_score,g=this.sectionplane,
d=this.ALTs,l=this.xmlDoc,t=this;n(b).each(function(b,k){var p=h.XMLID(k),r=a[p];if(r){c=r.xmlID;var u=n(f).find(r.tagname+'[xml\\:id="'+c+'"]')[0];if(!u)throw new h.RuntimeError("MeiLib.MeiDoc.prototype.initSectionView():E01","Cannot find <lem>, <rdg>, <sic>, or <corr> with @xml:id '"+c+"'.");}else if(r=t.ALTs[p].getDefaultItem())c=r.xmlID,u=r.elem;var r=k.parentNode,F=l.createProcessingInstruction("MEI2VF",'rdgStart="'+p+'"');r.insertBefore(F,k);if(u)for(u=u.childNodes,b=0;b<u.length;++b)r.insertBefore(u.item(b).cloneNode(!0),
k);u=l.createProcessingInstruction("MEI2VF",'rdgEnd="'+p+'"');r.insertBefore(u,k);r.removeChild(k);g[p]=[];d[p].altitems[c]&&g[p].push(d[p].altitems[c])});return this.sectionview_score};h.MeiDoc.prototype.updateSectionView=function(a){var b=function(d,a){var b=0,c,f;for(f in d){var g=d[f],u=0,F=void 0;for(F in g)g[F]!==E&&g[F]===a[F]&&u++;console.log("vars_match: "+u);M=u;b<M&&(b=M,c=d[f])}return c};for(altID in a){var c=this.ALTs,f=[];"string"===typeof a[altID]&&(a[altID]=[a[altID]]);if(0<a[altID].length)n(a[altID]).each(function(){f.push(c[altID].altitems[this])});
else{var g=this.ALTs[altID].getDefaultItem();g&&f.push(g)}if(altgroup=this.altgroups[altID])for(g=0;g<altgroup.length;g++){altID__=altgroup[g];var d=[];n(f).each(function(){d.push(b(c[altID__].altitems,this))});this.replaceAltInstance({appXmlID:altID__,replaceWith:d})}else this.replaceAltInstance({appXmlID:altID,replaceWith:f})}};h.MeiDoc.prototype.replaceAltInstance=function(a){var b=function(d,a){var l;for(l=0;l<a.length;++l)d.push(a.item(l));return d},c=a.appXmlID,f=n(this.sectionview_score).find("[xml\\:id="+
this.ALTs[c].parentID+"]")[0];if("undefined"!==typeof f){var g=f.childNodes,d=a.replaceWith,l=[],t=this.rich_score;if(d){var q;for(q=0;q<d.length;++q)var k=d[q],p=k.xmlID,k=n(t).find(k.tagname+'[xml\\:id="'+p+'"]')[0],l=b(l,k.childNodes)}console.log(l);var r=function(d,a){d=d.replace("'",'"');a=a.replace("'",'"');return d===a},u=!1,F=!1,h=null;n(g).each(function(){7===this.nodeType?"MEI2VF"===this.nodeName&&r(this.nodeValue,'rdgStart="'+c+'"')?F=u=!0:"MEI2VF"===this.nodeName&&r(this.nodeValue,'rdgEnd="'+
c+'"')&&(u=!1,h=this):u&&f.removeChild(this)});if(!F)throw"processing instruction not found";if(u)throw"Unmatched <?MEI2VF rdgStart?>";var s;s=h?function(d){f.insertBefore(d,h)}:function(d){f.appendChild(d)};n.each(l,function(){s(this.cloneNode(!0))});this.sectionplane[c]=a.replaceWith;return this.sectionview_score}};h.MeiDoc.prototype.getSectionViewSlice=function(a){return h.SliceMEI(this.sectionview_score,a)};h.MeiDoc.prototype.getRichSlice=function(a){var b=new h.MeiDoc;b.xmlDoc=this.xmlDoc;b.rich_head=
this.rich_head.cloneNode(!0);b.rich_music=this.rich_music.cloneNode(!0);b.rich_score=h.SliceMEI(this.rich_score,a);b.sourceList=this.sourceList;b.editorList=this.editorList;b.ALTs=this.ALTs;b.altgroups=this.altgroups;return b};s=function(a,b,c,f,g){a.Converter=function(d){d&&this.initConfig(d);return this};a.Converter.prototype={BOTTOM:c.Annotation.VerticalJustify.BOTTOM,defaults:{page_width:800,page_margin_top:60,page_margin_left:20,page_margin_right:20,systemSpacing:90,staveSpacing:60,autoStaveConnectorLine:!0,
labelMode:null,maxHyphenDistance:75,lyricsFont:{family:"Times",size:15},annotFont:{family:"Times",size:15,weight:"Italic"},dynamFont:{family:"Times",size:18,weight:"bold italic"},tempoFont:{family:"Times",size:17,weight:"bold"},staff:{vertical_bar_width:20,top_text_position:1.5,bottom_text_position:7.5}},initConfig:function(d){this.cfg=f.extend(!0,{},this.defaults,d);this.systemInfo=new a.SystemInfo;this.printSpace={top:this.cfg.page_margin_top-40,left:this.cfg.page_margin_left,right:this.cfg.page_width-
this.cfg.page_margin_right,width:Math.floor(this.cfg.page_width-this.cfg.page_margin_right-this.cfg.page_margin_left)-1};return this},reset:function(){this.systemInfo.init(this.cfg,this.printSpace);this.unresolvedTStamp2=[];this.systems=[];this.allVexMeasureStaffs=[];this.allBeams=[];this.allTuplets=[];this.dynamics=new a.Dynamics(this.systemInfo,this.cfg.dynamFont);this.directives=new a.Directives(this.systemInfo,this.cfg.annotFont);this.fermatas=new a.Fermatas(this.systemInfo);this.ties=new a.Ties(this.systemInfo,
this.unresolvedTStamp2);this.slurs=new a.Ties(this.systemInfo,this.unresolvedTStamp2);this.hairpins=new a.Hairpins(this.systemInfo,this.unresolvedTStamp2);this.hyphenation=new a.Hyphenation(this.cfg.lyricsFont,this.printSpace.right,this.cfg.maxHyphenDistance);this.notes_by_id={};this.currentSystem_n=0;this.currentGraceNotes=[];this.pendingSystemBreak=!1;this.pendingSectionBreak=!0;this.currentVoltaType=null;return this},process:function(d){this.reset();this.systemInfo.processScoreDef(f(d).find("scoreDef")[0]);
this.processSections(d);this.directives.createVexFromInfos(this.notes_by_id);this.dynamics.createVexFromInfos(this.notes_by_id);this.fermatas.createVexFromInfos(this.notes_by_id);this.ties.createVexFromInfos(this.notes_by_id);this.slurs.createVexFromInfos(this.notes_by_id);this.hairpins.createVexFromInfos(this.notes_by_id);return this},draw:function(d){this.drawSystems(d);this.drawVexBeams(this.allBeams,d);this.drawVexTuplets(this.allTuplets,d);this.ties.setContext(d).draw();this.slurs.setContext(d).draw();
this.hairpins.setContext(d).draw();this.hyphenation.setContext(d).draw();return this},getStaffArea:function(){var d,a;d=this.systemInfo.getCurrentLowestY();var b=this.getAllVexMeasureStaffs(),c,f,g,r;a=b.length;for(g=0;a--;)if(b[a]){f=0;for(c=b[a].length;c--;)(r=b[a][c])&&(f=Math.max(f,r.getNoteStartX()));for(c=b[a].length;c--;)(r=b[a][c])&&(g=Math.max(g,f+r.getWidth()))}return{width:g,height:d}},getAllVexMeasureStaffs:function(){return this.allVexMeasureStaffs},getSystems:function(){return this.systems},
getNotes:function(){return this.notes_by_id},createNewSystem:function(){var d;a.L("Converter.createNewSystem()","{enter}");this.pendingSystemBreak=!1;this.currentSystem_n+=1;d={x:this.printSpace.left,y:1===this.currentSystem_n?this.printSpace.top:this.systemInfo.getCurrentLowestY()+this.cfg.systemSpacing,w:this.printSpace.width};d=new a.System({leftMar:this.systemInfo.getLeftMar(),coords:d,staffYs:this.systemInfo.getYs(d.y),labels:this.getStaffLabels()});this.pendingSectionBreak?(this.pendingSectionBreak=
!1,this.systemInfo.forceSectionStartInfos()):this.systemInfo.forceStaveStartInfos();this.hyphenation.addLineBreaks(this.systemInfo.getAllStaffInfos(),{system:d});return this.systems[this.currentSystem_n]=d},processSections:function(d){var a=this;f(d).find("section, ending").each(function(){"ending"===this.localName?a.processEnding(this):a.processSection(this)})},processSection:function(d){var a,b=f(d).children();d=0;for(a=b.length;d<a;d+=1)this.processSectionChild(b[d])},processEnding:function(d){var a,
b,c=f(d).children();a=0;for(b=c.length;a<b;a+=1)this.currentVoltaType={},0===a&&(this.currentVoltaType.start=f(d).attr("n")),a===b-1&&(this.currentVoltaType.end=!0),this.processSectionChild(c[a]);this.currentVoltaType=null},processSectionChild:function(d){switch(d.localName){case "measure":this.processMeasure(d);break;case "scoreDef":this.systemInfo.processScoreDef(d);break;case "staffDef":this.systemInfo.processStaffDef(d);break;case "sb":this.setPendingSystemBreak(d);break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",
"Element <"+d.localName+"> is not supported in <section>");}},setPendingSystemBreak:function(){this.pendingSystemBreak=!0},processMeasure:function(d){var l=this,b,c,k,g,r;l.pendingSectionBreak||l.pendingSystemBreak?(c=l.systems.length,r=l.createNewSystem(),c=!0):(c=l.systems.length-1,r=l.systems[c],c=!1);a.L("Converter.processMeasure()","{enter}");b=+d.getAttribute("n");k=d.getAttribute("left");g=d.getAttribute("right");var u=[],h=[],n=[],s=[],y=[],C=[],A=[],x=[];f(d).find("*").each(function(){switch(this.localName){case "staff":u.push(this);
break;case "dir":h.push(this);break;case "tie":s.push(this);break;case "slur":n.push(this);break;case "hairpin":y.push(this);break;case "tempo":C.push(this);break;case "dynam":A.push(this);break;case "fermata":x.push(this)}});var z=l.initializeMeasureStaffs(r,u,k,g,c);l.allVexMeasureStaffs[b]=z;var J=new a.StaveVoices;f.each(u,function(){l.processStaffEvents(z,this,b,J)});l.directives.createInfos(h,d);l.dynamics.createInfos(A,d);l.fermatas.createInfos(x,d);l.ties.createInfos(s,d,l.systemInfo);l.slurs.createInfos(n,
d,l.systemInfo);l.hairpins.createInfos(y,d,l.systemInfo);r.addMeasure(new a.Measure({element:d,n:b,staffs:z,voices:J,startConnectorCfg:c?{labelMode:l.cfg.labelMode,models:l.systemInfo.startConnectorInfos,staffs:z,system_n:l.currentSystem_n}:null,inlineConnectorCfg:{models:l.systemInfo.inlineConnectorInfos,staffs:z,barline_l:k,barline_r:g},tempoElements:C,tempoFont:l.cfg.tempoFont}))},initializeMeasureStaffs:function(d,l,b,q,k){var g=this,r,u,h,n=!0,s={},y=0,C={},A=0,x;h=[];k||(x=d.getLastMeasure().getStaffs());
f.each(l,function(){u=+f(this).attr("n");if(!u)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".');r=g.createVexStaff(d.getStaffYs()[u]);h[u]=r;r.setBegBarType(b?a.tables.barlines[b]:c.Barline.type.NONE);q&&r.setEndBarType(a.tables.barlines[q]);n&&g.currentVoltaType&&g.addStaffVolta(r);x&&x[u]?(g.addStaffEndClef(x[u],u),y=s[u]=0):(g.addStaffClef(r,u),s[u]=r.getModifierXShift(),y=Math.max(y,s[u]));n=!1});f.each(h,function(d,a){a&&(s[d]!==y?g.addStaffKeySig(a,
d,y-s[d]+10):g.addStaffKeySig(a,d),C[d]=a.getModifierXShift(),A=Math.max(A,C[d]))});f.each(h,function(d,a){a&&(C[d]!==A?g.addStaffTimeSig(a,d,A-C[d]+15):g.addStaffTimeSig(a,d))});return h},createVexStaff:function(d){var a;a=new c.Stave;a.init(0,d,1E3,this.cfg.staff);a.options.bottom_text_position=this.cfg.staff.bottom_text_position;return a},addStaffClef:function(d,a){var b;b=this.systemInfo.getStaffInfo(a);b.showClefCheck()&&d.addClef(b.getClef())},addStaffEndClef:function(d,a){var b;b=this.systemInfo.getStaffInfo(a);
b.showClefCheck()&&d.addEndClef(b.getClef()+"_small")},addStaffKeySig:function(d,a,b){a=this.systemInfo.getStaffInfo(a);a.showKeysigCheck()&&d.addModifier(new Vex.Flow.KeySignature(a.getKeySpec(),b))},addStaffTimeSig:function(d,a,b){a=this.systemInfo.getStaffInfo(a);a.showTimesigCheck()&&(d.hasTimeSig=!0,d.addTimeSignature(a.getTimeSig(),b))},addStaffVolta:function(d){var a=this.currentVoltaType;a.start&&d.setVoltaType(Vex.Flow.Volta.type.BEGIN,a.start+".",30,0);a.end&&d.setVoltaType(Vex.Flow.Volta.type.END,
"",30,0);a.start||a.end||d.setVoltaType(Vex.Flow.Volta.type.MID,"",30,0)},getStaffLabels:function(){var d,a,b,c;d={};if(!this.cfg.labelMode)return d;c="full"===this.cfg.labelMode&&1===this.currentSystem_n?"label":"labelAbbr";b=this.systemInfo.getAllStaffInfos();for(a=b.length;a--;)b[a]&&(d[a]=b[a][c]);return d},processStaffEvents:function(d,a,b,q){var k=this,g,r,u,h,n,s,y;r=+f(a).attr("n");g=d[r];y=k.systemInfo.getStaffInfo(r);d=function(){var d=k.processNoteLikeElement(this,g,r,s,y);return d?d.vexNote||
d:null};a=f(a).find("layer");console.log(h);u=0;for(h=a.length;u<h;u++)s=1<h?0===u?c.StaveNote.STEM_UP:u===h-1?c.StaveNote.STEM_DOWN:null:null,k.resolveUnresolvedTimestamps(a[u],r,b,y.meter),y.checkInitialClef(),n=f(a[u]).children().map(d).get(),q.addVoice(k.createVexVoice(n,y.meter),r);y.removeInitialClefCopy()},createVexVoice:function(d,b){var t;if(!f.isArray(d))throw new a.RUNTIME_ERROR("BadArguments","me.createVexVoice() voice_contents argument must be an array.");t=new c.Voice({num_beats:b.count,
beat_value:b.unit,resolution:c.RESOLUTION});t.setStrict(!1);t.addTickables(d);return t},resolveUnresolvedTimestamps:function(d,b,c,q){var k=this,g;if(isNaN(c))throw new a.RUNTIME_ERROR("MEI2VF.RERR.extract_events","<measure> must have @n specified");g=c+":"+(b||1)+":"+(f(d).attr("n")||"1");k.unresolvedTStamp2[g]&&(f(k.unresolvedTStamp2[g]).each(function(a){this.setContext({layer:d,meter:q});k.unresolvedTStamp2[g][a]=null}),k.unresolvedTStamp2[g]=null)},processNoteLikeElement:function(d,b,c,f,k){switch(d.localName){case "rest":return this.processRest(d,
b,c);case "mRest":return this.processmRest(d,b,c,f,k);case "space":return this.processSpace(d,b);case "note":return this.processNote(d,b,c,f);case "beam":return this.processBeam(d,b,c,f,k);case "tuplet":return this.processTuplet(d,b,c,f,k);case "chord":return this.processChord(d,b,c,f);case "clef":return this.processClef(d,b,c,f,k);case "anchoredText":break;default:throw new a.RUNTIME_ERROR("BadArguments",'Rendering of element "'+d.localName+'" is not supported.');}},processNote:function(d,l,t,g){var k=
this,p,r,u,h,n,s,y,C,A,x,z,w,D;z=a.Util.attsToObj(d);p=+z.dots;r=z.accid;u=z.ho;h=z.pname;n=z.oct;y=z.tie;C=z.slur;A=+z.staff||t;s=b.XMLID(d);try{w={keys:[k.processAttsPitch(d)],clef:k.systemInfo.getClef(t),duration:k.processAttsDuration(d)};k.setStemDir(d,w,g);D=z.grace?new c.GraceNote(w):new c.StaveNote(w);if(A===t)D.setStave(l);else{var v=k.allVexMeasureStaffs[k.allVexMeasureStaffs.length-1][A];if(v)D.setStave(v);else throw new a.RUNTIME_ERROR("Error",'Note has staff attribute "'+A+'", but the staff does not exist.');
}k.processSyllables(D,d,t);try{for(x=0;x<p;x+=1)D.addDotToAll()}catch(B){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the dots of <note>: "+a.Util.attsToString(d));}r&&k.processAttrAccid(r,D,0);u&&k.processAttrHo(u,D,l);f.each(f(d).find("artic"),function(){k.addArticulation(D,this)});z.fermata&&k.fermatas.addFermataToNote(D,z.fermata);if(!h)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have pname attribute");if(!n)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments",
"mei:note must have oct attribute");y&&k.processAttrTie(y,s,h,n);C&&k.processAttrSlur(C,s);k.notes_by_id[s]={meiNote:d,vexNote:D,system:k.currentSystem_n,layerDir:g};if(z.grace)D.slash="1slash"===z["stem.mod"],k.currentGraceNotes.push(D);else return 0<k.currentGraceNotes.length&&(D.addModifier(0,(new Vex.Flow.GraceNoteGroup(k.currentGraceNotes,!1)).beamNotes()),k.currentGraceNotes=[]),{vexNote:D,id:s}}catch(E){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <note>: "+a.Util.attsToString(d)+
"\nORIGINAL ERROR MESSAGE: "+E.toString());}},processChord:function(d,l,t,g){var k=this,p,r,u,h,n=[],s,y=[],w,A,x,z,v;h=f(d).children();v=a.Util.attsToObj(d);w=v.dur;A=b.XMLID(d);u=!!f(d).attr("dots");try{if(w)s=k.translateDuration(+w);else{p=0;for(r=h.length;p<r;p+=1)y.push(+h[p].getAttribute("dur"));s=k.translateDuration(Math.max.apply(Math,y))}p=0;for(r=h.length;p<r;p+=1)n.push(k.processAttsPitch(h[p])),"1"===h[p].getAttribute("dots")&&(u=!0);u&&(s+="d");z={keys:n,clef:k.systemInfo.getClef(t),
duration:s};k.setStemDir(d,z,g);x=v.grace?new c.GraceNote(z):new c.StaveNote(z);x.setStave(l);var D=[];h.each(function(a){k.processNoteInChord(a,this,d,x,g);D.push(a)});u&&x.addDotToAll();v.ho&&k.processAttrHo(v.ho,x,l);v.fermata&&k.fermatas.addFermataToNote(x,v.fermata);k.notes_by_id[A]={meiNote:d,vexNote:x,index:D,system:k.currentSystem_n,layerDir:g};if(v.grace)k.currentGraceNotes.push(x);else return 0<k.currentGraceNotes.length&&(x.addModifier(0,(new Vex.Flow.GraceNoteGroup(k.currentGraceNotes,
!1)).beamNotes()),k.currentGraceNotes=[]),{vexNote:x,id:A}}catch(B){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <chord>:"+B.toString());}},processNoteInChord:function(d,l,c,f,g){var p;p=a.Util.attsToObj(l);l=b.XMLID(l);p.tie&&this.processAttrTie(p.tie,l,p.pname,p.oct);p.slur&&this.processAttrSlur(p.slur,l);this.notes_by_id[l]={meiNote:c,vexNote:f,index:[d],system:this.currentSystem_n,layerDir:g};p.accid&&this.processAttrAccid(p.accid,f,d);p.fermata&&this.fermatas.addFermataToNote(f,
p.fermata,d)},processRest:function(d,l,f){var g,k,p,r;try{r=a.Util.attsToObj(d);g=this.processAttsDuration(d,!0);var h=r.ploc&&r.oloc?{keys:[r.ploc+"/"+r.oloc],clef:this.systemInfo.getClef(f)}:{keys:["w"===g?"d/5":"b/4"]};h.duration=g+"r";k=new c.StaveNote(h);k.drawLedgerLines=function(){};p=b.XMLID(d);r.ho&&this.processAttrHo(r.ho,k,l);k.setStave(l);"1"===r.dots&&k.addDotToAll();r.fermata&&this.fermatas.addFermataToNote(k,r.fermata);this.notes_by_id[p]={meiNote:d,vexNote:k,system:this.currentSystem_n};
return{vexNote:k,id:p}}catch(n){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <rest>: "+a.Util.attsToString(d));}},processmRest:function(d,l,f,g,k){var p,r,h;g=this.systemInfo.getStaffInfo(f).meter;k=new Vex.Flow.Fraction(g.count,g.unit);var n;2==k.value()?(n=a.tables.durations.breve,g=["b/4"]):4==k.value()?(n=a.tables.durations["long"],g=["b/4"]):(n="w",g=["d/5"]);try{return r=a.Util.attsToObj(d),k={duration:n+"r",duration_override:k,align_center:!0},r.ploc&&r.oloc?
(k.keys=[r.ploc+"/"+r.oloc],k.clef=this.systemInfo.getClef(f)):k.keys=g,p=new c.StaveNote(k),h=b.XMLID(d),r.ho&&this.processAttrHo(r.ho,p,l),r.fermata&&this.fermatas.addFermataToNote(p,r.fermata),p.setStave(l),this.notes_by_id[h]={meiNote:d,vexNote:p,system:this.currentSystem_n},{vexNote:p,id:h}}catch(s){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <mRest>: "+a.Util.attsToString(d));}},processSpace:function(d,b){var f;try{return f=new c.GhostNote({duration:this.processAttsDuration(d,
!0)+"r"}),f.setStave(b),{vexNote:f}}catch(g){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <space>: "+a.Util.attsToString(d));}},processClef:function(d,b,f,g,k){var p;d=a.Util.attsToObj(d);d={"clef.line":d.line,"clef.shape":d.shape,"clef.dis":d.dis,"clef.dis.place":d["dis.place"]};try{return p=new c.ClefNote(k.clefChangeInMeasure(d)),p.setStave(b),{vexNote:p}}catch(r){throw r;throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <clef>: "+a.Util.attsToString(d));
}},processBeam:function(d,a,b,g,k){var p=this;d=f(d).children().map(function(){var d=p.processNoteLikeElement(this,a,b,g,k);return d?d.vexNote||d:null}).get();0<d.length&&p.allBeams.push(new c.Beam(d));return d},processTuplet:function(d,a,b,g,k){var p=this,r,h,n;r=f(d).children().map(function(){var d=p.processNoteLikeElement(this,a,b,g,k);return d?d.vexNote||d:null}).get();h=new c.Tuplet(r,{num_notes:+d.getAttribute("num")||3,beats_occupied:+d.getAttribute("numbase")||2});"ratio"===d.getAttribute("num.format")&&
h.setRatioed(!0);(n=d.getAttribute("bracket.visible"))&&h.setBracketed("true"===n?!0:!1);(d=d.getAttribute("bracket.place"))&&h.setTupletLocation("above"===d?1:-1);p.allTuplets.push(h);return r},processAttrAccid:function(d,b,f){var g=a.tables.accidentals[d];if(!g)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+d);b.addAccidental(f,new c.Accidental(g))},processAttrHo:function(d,a,b){a.setExtraLeftPx(+d*b.getSpacingBetweenLines()/2)},processAttrTie:function(d,a,
b,c){var f,g;f=0;for(g=d.length;f<g;++f)"i"===d[f]?this.ties.start_tieslur(a,{pname:b,oct:c}):"t"===d[f]&&this.ties.terminate_tie(a,{pname:b,oct:c})},processAttrSlur:function(d,a){var b=this,c;d&&(c=b.parse_slur_attribute(d),f.each(c,function(){"i"===this.letter?b.slurs.start_tieslur(a,{nesting_level:this.nesting_level}):"t"===this.letter&&b.slurs.terminate_slur(a,{nesting_level:this.nesting_level})}))},parse_slur_attribute:function(d){var b=[],c,f,g,p;d=d.split(" ");f=0;for(g=d.length;f<g;f+=1)if(c=
d[f],1===c.length)b.push({letter:c,nesting_level:0});else if(2===c.length){p=+c[1];if(!p)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");b.push({letter:c[0],nesting_level:p})}else throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");return b},processAttsPitch:function(d){var b;b=f(d).attr("pname");d=f(d).attr("oct");if(!b||!d)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>");
return b+"/"+d},addArticulation:function(d,b){var f=new c.Articulation(a.tables.articulations[b.getAttribute("artic")]),g=b.getAttribute("place");g&&f.setPosition(a.tables.positions[g]);d.addArticulation(0,f)},processSyllables:function(d,a,b){var c;if(c=this.processSyllable(a))a=this.createAnnot(c.text,this.cfg.lyricsFont).setVerticalJustification(this.BOTTOM),d.addAnnotation(0,a),c.wordpos&&this.hyphenation.addSyllable(a,c.wordpos,b)},processSyllable:function(a){if(a=f(a).find("syl")[0])return{text:f(a).text(),
wordpos:f(a).attr("wordpos")}},createAnnot:function(a,b){return(new c.Annotation(a)).setFont(b.family,b.size,b.weight)},getMandatoryAttr:function(d,b){var c=f(d).attr(b);if(!c)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+b+" is mandatory.");return c},translateDuration:function(d){var b=a.tables.durations[d+""];if(b)return b;throw new a.RUNTIME_ERROR("BadArguments",'The MEI duration "'+d+'" is not supported.');},processAttsDuration:function(a,b){var c;c=f(a).attr("dur");c===
g&&alert("Could not get duration from:\n"+JSON.stringify(a,null,"\t"));c=this.translateDuration(c);b||"1"!==f(a).attr("dots")||(c+="d");return c},setStemDir:function(a,b,t){(a={down:c.StaveNote.STEM_DOWN,up:c.StaveNote.STEM_UP}[f(a).attr("stem.dir")])?b.stem_direction=a:t?b.stem_direction=t:b.auto_stem=!0},drawSystems:function(a){for(var b=this.systems.length;b--;)this.systems[b]&&this.systems[b].format(a).draw(a)},drawVexBeams:function(a,b){f.each(a,function(){this.setContext(b).draw()})},drawVexTuplets:function(a,
b){f.each(a,function(){this.setContext(b).draw()})}};return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.EventLink=function(a,b){this.init(a,b)};a.EventLink.prototype={init:function(d,b){this.first_ref=new a.EventReference(d);this.last_ref=new a.EventReference(b);this.params={}},setParams:function(a){this.params=a},setFirstRef:function(a){this.first_ref=a},setLastRef:function(a){this.last_ref=a},setFirstId:function(a){this.first_ref.setId(a)},setLastId:function(a){this.last_ref.setId(a)},setFirstTStamp:function(a){this.first_ref.setTStamp(a)},
setLastTStamp:function(a){this.last_ref.setTStamp(a)},setContext:function(a){this.meicontext=a},getFirstId:function(){return this.first_ref.getId({meicontext:this.meicontext})},getLastId:function(){return this.last_ref.getId({meicontext:this.meicontext})}};return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.EventReference=function(a){this.xmlid=a};a.EventReference.prototype={setId:function(a){this.xmlid=a},setTStamp:function(a){this.tstamp=a;this.xmlid&&this.tryResolveReference(!0)},tryResolveReference:function(){if(!this.tstamp)throw new a.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001",
"EventReference: tstamp must be set in order to resolve reference.");this.xmlid=this.meicontext?b.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter):null},getId:function(a){a&&a.meicontext&&this.setContext(a.meicontext);return this.xmlid?this.xmlid:this.tstamp&&this.meicontext?(this.tryResolveReference(a&&a.strict),this.xmlid):null},setContext:function(a){this.meicontext=a}};return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.Hyphenation=function(a,b,c){this.allSyllables=[];
this.printSpaceRight=b;this.font=a;this.maxHyphenDistance=c};a.Hyphenation.prototype={WORDBOUND:null,addSyllable:function(a,b,c){this.allSyllables[c]||(this.allSyllables[c]=[]);"i"===b&&this.allSyllables[c].push(this.WORDBOUND);this.allSyllables[c].push(a);"t"===b&&this.allSyllables[c].push(this.WORDBOUND)},addLineBreaks:function(a,b){var c,f;c=1;for(f=a.length;c<f;c+=1)this.allSyllables[c]||(this.allSyllables[c]=[]),this.allSyllables[c].push(b)},setContext:function(a){this.ctx=a;return this},draw:function(){var a,
b,f,q,k;this.ctx.setFont(this.font.family,this.font.size,this.font.weight);k=this.ctx.measureText("-").width;for(a=this.allSyllables.length;a--;)if(this.allSyllables[a])for(b=this.allSyllables[a].length;b--;)if(f=this.allSyllables[a][b],q=this.allSyllables[a][b+1],f!==this.WORDBOUND&&q!==this.WORDBOUND){var p={hyphen_width:k,max_hyphen_distance:this.maxHyphenDistance};p.first_annot=f.system?{x:f.system.getMeasures()[0].getX()}:f;p.last_annot=q===g||q.system?{x:this.printSpaceRight}:q;(p.first_annot.y||
p.last_annot.y)&&(new c.Hyphen(p)).setContext(this.ctx).renderHyphen()}}};return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.LinkCollection=function(a,b){this.init(a,b)};a.LinkCollection.prototype={init:function(a,b){this.allVexObjects=[];this.allModels=[];this.systemInfo=a;this.unresolvedTStamp2=b},validateAtts:function(){throw new a.RUNTIME_ERROR("MEI2VF.DEVELOPMENT_ERROR.validateAtts","Developers have to provide a validateAtts method when inheriting MEI2VF.LinkCollection.");},createVexFromInfos:function(){throw new a.RUNTIME_ERROR("MEI2VF.DEVELOPMENT_ERROR.createVexFromInfos",
"Developers have to provide a createVexFromInfos method when inheriting MEI2VF.LinkCollection.");},createInfos:function(d,c,g){var q=this,k=function(a){return{staff_n:f(a).attr("staff")||"1",layer_n:f(a).attr("layer")||"1"}},p=function(d,c,l){c=k(c);var q=f(l).find('staff[n="'+c.staff_n+'"]');l=f(q).find('layer[n="'+c.layer_n+'"]').get(0);if(!l&&((q=f(q).find("layer"))&&!q.attr("n")&&(l=q),!l))throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E01","Cannot find layer");c=g.getStaffInfo(c.staff_n);
if(!c)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E02","Cannot determine staff definition.");c=c.meter;if(!c.count||!c.unit)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");return b.tstamp2id(d,l,c)};f.each(d,function(){var d,b,g;d=new a.EventLink(null,null);b=a.Util.attsToObj(this);q.validateAtts(b);d.setParams(b);if(g=b.startid)d.setFirstId(g);else if(g=b.tstamp)g=p(g,this,c),d.setFirstId(g);if(g=b.endid)d.setLastId(g);
else if(g=b.tstamp2)b=+g.substring(0,g.indexOf("m")),0<b?(d.setLastTStamp(g.substring(g.indexOf("+")+1)),g=k(this),b=(+f(c).attr("n")+b).toString()+":"+g.staff_n+":"+g.layer_n,q.unresolvedTStamp2[b]||(q.unresolvedTStamp2[b]=[]),q.unresolvedTStamp2[b].push(d)):(g=p(g.substring(g.indexOf("+")+1),this,c),d.setLastId(g));q.addModel(d)})},addModel:function(a){this.allModels.push(a)},getModels:function(){return this.allModels},setContext:function(a){this.ctx=a;return this},draw:function(){var a=this.ctx;
f.each(this.allVexObjects,function(){this.setContext(a).draw()})}};a.Hairpins=function(a,b){this.init(a,b)};Vex.Inherit(a.Hairpins,a.LinkCollection,{init:function(d,b){a.Ties.superclass.init.call(this,d,b)},validateAtts:function(d){if(!d.form)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:createInfos","@form is mandatory in <hairpin> - make sure the xml is valid.");},createVexFromInfos:function(a){var b=this,c,q,k;k={height:10,y_shift:0,left_shift_px:0,r_shift_px:0};f.each(b.allModels,function(){c=
a[this.getFirstId()]||{};q=a[this.getLastId()]||{};c.system!==g&&q.system!==g&&c.system!==q.system||b.createSingleHairpin(c,q,this.params,k)});return this},createSingleHairpin:function(d,b,f,g){var k,p;k=a.tables.positions[f.place];p=a.tables.hairpins[f.form];d.vexNote&&b.vexNote?(p=new c.StaveHairpin({first_note:d.vexNote,last_note:b.vexNote},p),p.setRenderOptions(g),p.setPosition(k),this.allVexObjects.push(p)):(a.L("Hairpins","Hairpin cannot be rendered:"),console.log(arguments))}});a.Ties=function(a,
b){this.init(a,b)};Vex.Inherit(a.Ties,a.LinkCollection,{init:function(d,b){a.Ties.superclass.init.call(this,d,b)},validateAtts:function(){},start_tieslur:function(d,b){var c=new a.EventLink(d,null);c.setParams({linkCond:b});this.allModels.push(c)},terminate_tie:function(d,b){var c,f,g,p,h;h=this.getModels();c=function(a,d){return a&&d&&a.pname===d.pname&&a.oct===d.oct};if(!b.pname||!b.oct)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch or octave specified for the tie");f=
!1;for(g=0;!f&&g<h.length;++g)p=h[g],!p.getLastId()&&c(p.params.linkCond,b)&&(f=!0,p.setLastId(d));f||this.addModel(new a.EventLink(null,d))},terminate_slur:function(d,b){var c,f,g,p,h=this.getModels();c=function(a,d){return a.nesting_level===d.nesting_level};f=!1;for(g=0;g<h.length;++g)if((p=h[g])&&!p.getLastId()&&c(p.params.linkCond,b)){p.setLastId(d);f=!0;break}f||this.addModel(new a.EventLink(null,d))},createVexFromInfos:function(a){var b=this,c,q;f.each(b.allModels,function(){var f;c=a[this.getFirstId()]||
{};q=a[this.getLastId()]||{};this.params.curvedir||((f=c.layerDir||q.layerDir)?this.params.curvedir=-1===f?"below":1===f?"above":g:c.vexNote?(f=c.vexNote.keys.length,1<f&&(this.params.curvedir=0===+c.index?"below":+c.index===f-1?"above":g)):q.vexNote&&(f=q.vexNote.keys.length,1<f&&(this.params.curvedir=0===+q.index?"below":+q.index===f-1?"above":g)));c.system!==g&&q.system!==g&&c.system!==q.system?(b.createSingleStaveTie(c,{},this.params),this.params.curvedir||(this.params.curvedir=-1===c.vexNote.getStemDirection()?
"above":"below"),b.createSingleStaveTie({},q,this.params)):b.createSingleStaveTie(c,q,this.params)});return this},createSingleStaveTie:function(a,b,f){var g;(g=f.bezier)?(g=this.bezierStringToCps(g),b=new c.Curve(a.vexNote,b.vexNote,{cps:g,y_shift_start:+f.startvo,y_shift_end:+f.endvo})):(b=new c.StaveTie({first_note:a.vexNote,last_note:b.vexNote,first_indices:a.index,last_indices:b.index}),b.setDir(f.curvedir),a.vexNote instanceof c.GraceNote&&(b.render_options.first_x_shift=-5));this.allVexObjects.push(b)},
bezierStringToCps:function(a){for(var b=[],c=a.split(" ");c[0];)a=c.splice(0,2),b.push({x:+a[0],y:+a[1]});return b}});return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.PointerCollection=function(a,b){this.init(a,b)};a.PointerCollection.prototype={BOTTOM:c.Annotation.VerticalJustify.BOTTOM,init:function(a,b){this.allVexObjects=[];this.allModels=[];this.systemInfo=a;this.font=b},createVexFromInfos:function(){throw new a.RUNTIME_ERROR("MEI2VF.DEVELOPMENT_ERROR.createVexFromInfos","You have to prodide a createVexFromInfos method when inheriting MEI2VF.PointerCollection.");
},createInfos:function(d,c){var g=this;f.each(d,function(){var d,k;d=a.Util.attsToObj(this);k=d.startid;if(!k)if(k=d.tstamp){var p=f(this).attr("staff")||"1",h=f(this).attr("layer")||"1",n=f(c).find('staff[n="'+p+'"]'),h=f(n).find('layer[n="'+h+'"]').get(0);if(!h&&((n=f(n).find("layer"))&&!n.attr("n")&&(h=n),!h))throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E01","Cannot find layer");p=g.systemInfo.getStaffInfo(p);if(!p)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E02","Cannot determine staff definition.");
p=p.meter;if(!p.count||!p.unit)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");k=b.tstamp2id(k,h,p)}else throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos","Neither @startid nor @tstamp are specified");g.allModels.push({element:this,atts:d,startid:k})})},addModel:function(a){this.allModels.push(a)},getModels:function(){return this.allModels}};a.Directives=function(a,b){this.init(a,b)};Vex.Inherit(a.Directives,a.PointerCollection,
{init:function(d,b){a.Directives.superclass.init.call(this,d,b)},createVexFromInfos:function(d){var b,g,q,k;for(b=this.allModels.length;b--;)if(g=this.allModels[b],q=d[g.startid])k=(new c.Annotation(f(g.element).text().trim())).setFont(this.font.family,this.font.size,this.font.weight),k.setWidth(0),"below"===g.atts.place?q.vexNote.addAnnotation(0,k.setVerticalJustification(this.BOTTOM)):q.vexNote.addAnnotation(0,k);else throw new a.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");
}});a.Dynamics=function(a,b){this.init(a,b)};Vex.Inherit(a.Dynamics,a.PointerCollection,{init:function(d,b){a.Dynamics.superclass.init.call(this,d,b)},createVexFromInfos:function(d){var b,g,q,k;for(b=this.allModels.length;b--;)if(g=this.allModels[b],q=d[g.startid])k=(new c.Annotation(f(g.element).text().trim())).setFont(this.font.family,this.font.size,this.font.weight),"above"===g.atts.place?q.vexNote.addAnnotation(0,k):q.vexNote.addAnnotation(0,k.setVerticalJustification(this.BOTTOM));else throw new a.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos",
"The reference in the directive could not be resolved.");}});a.Fermatas=function(a,b){this.init(a,b)};Vex.Inherit(a.Fermatas,a.PointerCollection,{init:function(d,b){a.Fermatas.superclass.init.call(this,d,b)},createVexFromInfos:function(d){var b,c,f;for(b=this.allModels.length;b--;)if(c=this.allModels[b],f=d[c.startid])this.addFermataToNote(f.vexNote,c.atts.place);else throw new a.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");},addFermataToNote:function(d,
b,f){var g=new c.Articulation(a.tables.fermata[b]);g.setPosition(a.tables.positions[b]);d.addArticulation(f||0,g)}});return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.Measure=function(a){this.init(a)};a.Measure.prototype={init:function(d){this.element=d.element;this.n=d.n;this.staffs=d.staffs;this.voices=d.voices;this.startConnectors=new a.Connectors(d.startConnectorCfg);this.inlineConnectors=new a.Connectors(d.inlineConnectorCfg);this.tieElements=d.tieElements;this.slurElements=d.slurElements;
this.hairpinElements=d.hairpinElements;this.tempoElements=d.tempoElements;this.tempoFont=d.tempoFont;this.maxEndModifierW=this.maxNoteStartX=0;this.meiW=this.readMEIW(this.element)},readMEIW:function(a){return+a.getAttribute("width")||null},getStaffs:function(){return this.staffs},getVoices:function(){return this.voices},getX:function(){return this.getFirstDefinedStaff().x},getN:function(){return this.n},getFirstDefinedStaff:function(){var d,b;d=0;for(b=this.staffs.length;d<b;d+=1)if(this.staffs[d])return this.staffs[d];
throw new a.RUNTIME_ERROR("ERROR","getFirstDefinedStaff(): no staff found in the current measure.");},addTempoToStaves:function(){var d=this,b,c,g,k,p;f.each(d.tempoElements,function(){k=a.Util.attsToObj(this);c=d.staffs[k.staff];p=c.getSpacingBetweenLines()/2;g=new Vex.Flow.StaveTempo({name:f(this).text(),duration:k["mm.unit"],dots:+k["mm.dots"],bpm:+k.mm},c.x,5);k.vo&&g.setShiftY(+k.vo*p);b=0<c.getModifierXShift()?-14:14;c.hasTimeSig&&(b-=24);k.ho&&(b+=+k.ho*p);g.setShiftX(b);g.font=d.tempoFont;
c.modifiers.push(g)})},calculateMinWidth:function(){this.calculateMaxNoteStartX();this.calculateMaxEndModifierWidth();this.calculateRepeatPadding();this.minVoicesW=this.voices.preFormat();this.minWidth=this.maxNoteStartX+this.maxEndModifierW+this.minVoicesW+this.repeatPadding},getMinWidth:function(){return this.minWidth},setFinalWidth:function(a){this.w=null===this.meiW?this.minWidth+a:this.meiW},calculateMaxNoteStartX:function(){var a,b,c;b=this.staffs;for(a=b.length;a--;)if(c=b[a])this.maxNoteStartX=
Math.max(this.maxNoteStartX,c.getNoteStartX())},calculateMaxEndModifierWidth:function(){var a,b,c;b=this.staffs;for(a=b.length;a--;)if(c=b[a])this.maxEndModifierW=Math.max(this.maxEndModifierW,c.glyph_end_x-c.end_x)},calculateRepeatPadding:function(){var a=this.getFirstDefinedStaff();this.repeatPadding=a.modifiers[0].barline==Vex.Flow.Barline.type.REPEAT_BEGIN&&2<a.modifiers.length?20:0},format:function(a,b){for(var f=this.w,g=this.staffs.length,k;g--;)this.staffs[g]&&(k=this.staffs[g],b&&"string"===
typeof b[g]&&k.setText(b[g],c.Modifier.Position.LEFT,{shift_y:-3}),k.x+=a,k.glyph_start_x+=a,k.start_x=k.x+this.maxNoteStartX,k.bounds.x+=a,k.setWidth(f),k.end_x-=this.maxEndModifierW,k.modifiers[0].x+=a);this.voices.format(this.getFirstDefinedStaff())},draw:function(a){var b,c,f;c=this.staffs;for(b=c.length;b--;)(f=c[b])&&f.setContext(a).draw();this.voices.draw(a,c);this.startConnectors.setContext(a).draw();this.inlineConnectors.setContext(a).draw()}};return a}(s||{},h,Vex.Flow,jQuery);s=function(a,
b,c,f,g){a.DO_LOG=!1;a.setLogging=function(b){a.DO_LOG=b};a.L=function(){a.DO_LOG&&Vex.L("MEI2VF",arguments)};a.RUNTIME_ERROR=function(a,b){this.error_code=a;this.message=b};a.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message};return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.tables={accidentals:{n:"n",f:"b",s:"#",bb:"ff",ss:"##"},durations:{"long":"l",breve:"d",1:"w",2:"h",4:"q",8:"8",16:"16",32:"32",64:"64"},positions:{above:c.Modifier.Position.ABOVE,
below:c.Modifier.Position.BELOW},hairpins:{cres:c.StaveHairpin.type.CRESC,dim:c.StaveHairpin.type.DECRESC},articulations:{acc:"a>",stacc:"a.",ten:"a-",stacciss:"av",marc:"a^",dnbow:"am",upbow:"a|",snap:"ao",lhpizz:"a+",dot:"a.",stroke:"a|"},fermata:{above:"a@a",below:"a@u"},barlines:{single:c.Barline.type.SINGLE,dbl:c.Barline.type.DOUBLE,end:c.Barline.type.END,rptstart:c.Barline.type.REPEAT_BEGIN,rptend:c.Barline.type.REPEAT_END,rptboth:c.Barline.type.REPEAT_BOTH,invis:c.Barline.type.NONE}};return a}(s||
{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.StaffInfo=function(b,c,f,g){this.renderWith={clef:c,keysig:f,timesig:g};this.spacing=null;this.staffDefObj=a.Util.attsToObj(b);this.updateMeter();this.updateStaveLabels();this.updateSpacing();this.currentClef=this.convertClef(this.staffDefObj)};a.StaffInfo.prototype={updateMeter:function(){this.staffDefObj.hasOwnProperty("meter.count")&&this.staffDefObj.hasOwnProperty("meter.unit")&&(this.meter={count:+this.staffDefObj["meter.count"],unit:+this.staffDefObj["meter.unit"]})},
updateStaveLabels:function(){var a;a=this.staffDefObj.label;"string"===typeof a&&(this.label=a);a=this.staffDefObj["label.abbr"];"string"===typeof a&&(this.labelAbbr=a)},updateSpacing:function(){var a;a=+this.staffDefObj.spacing;isNaN(a)||(this.spacing=a);return this.spacing},forceSectionStartInfo:function(){this.renderWith.clef=!0;this.renderWith.keysig=!0;this.renderWith.timesig=!0},forceStaveStartInfo:function(){this.renderWith.clef=!0;this.renderWith.keysig=!0},showClefCheck:function(){if(this.renderWith.clef&&
"false"!==this.staffDefObj["clef.visible"])return this.renderWith.clef=!1,!0},showKeysigCheck:function(){if(this.renderWith.keysig&&(this.renderWith.keysig=!1,"false"!==this.staffDefObj["key.sig.show"]))return!0},showTimesigCheck:function(){if(this.renderWith.timesig&&(this.renderWith.timesig=!1,"norm"===this.staffDefObj["meter.rend"]||this.staffDefObj["meter.rend"]===g))return!0},initialClefCopy:null,clefChangeInMeasure:function(a){this.initialClefCopy=this.currentClef;this.currentClef=this.convertClef(a);
return this.currentClef+"_small"},checkInitialClef:function(){this.initialClefCopy&&(this.currentClef=this.initialClefCopy)},removeInitialClefCopy:function(){this.initialClefCopy=null},convertClef:function(b){var f,t,q;f=b["clef.shape"];if(!f)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute clef.shape is mandatory.");t=b["clef.line"];q=b["clef.dis"];b=b["clef.dis.place"];if("G"===f&&(!t||"2"===t))return"8"===q&&"below"===b&&c.clefProperties.values.octave!=g?"octave":"treble";if("F"===
f)return"3"===t?"baritone-f":"bass";if("C"===f){if("1"===t)return"soprano";if("2"===t)return"mezzo-soprano";if("3"===t)return"alto";if("4"===t)return"tenor";if("5"===t)return"baritone-c"}throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+f+'" '+(t?'clef.line="'+t+'"':"")+" ]");},getClef:function(){return this.currentClef},getKeySpec:function(){var b,c;if(this.staffDefObj["key.pname"]!==g){b=this.staffDefObj["key.pname"].toUpperCase();c=this.staffDefObj["key.accid"];
if(c!==g)switch(c){case "s":b+="#";break;case "f":b+="b";break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'");}c=this.staffDefObj["key.mode"];c!==g&&(b+="major"===c?"":"m");return b}return"C"},getTimeSig:function(){var a,b;if(a=this.staffDefObj["meter.sym"])return"cut"===a?"C|":"C";a=this.staffDefObj["meter.count"];b=this.staffDefObj["meter.unit"];return a&&b?a+"/"+b:g},updateRenderWith:function(a){var b=this,c,f;c={clef:!1,keysig:!1,
timesig:!1};f=function(c){return b.staffDefObj[c]===a[c]};f("clef.shape")&&f("clef.line")||(c.clef=!0);f("key.pname")&&f("key.accid")&&f("key.mode")||(c.keysig=!0);f("meter.count")&&f("meter.unit")||(c.timesig=!0);b.renderWith=c},updateDef:function(b){b=a.Util.attsToObj(b);this.updateRenderWith(b);this.staffDefObj=b;this.updateMeter();this.updateStaveLabels();this.updateSpacing();this.currentClef=this.convertClef(this.staffDefObj)}};return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.Connectors=
function(a){this.allVexConnectors=[];a&&this.init(a)};a.Connectors.prototype={vexTypes:{line:c.StaveConnector.type.SINGLE_LEFT,brace:c.StaveConnector.type.BRACE,bracket:c.StaveConnector.type.BRACKET,none:null,singleright:c.StaveConnector.type.SINGLE_RIGHT},vexTypesBarlineRight:{single:c.StaveConnector.type.SINGLE_RIGHT,dbl:c.StaveConnector.type.THIN_DOUBLE,end:c.StaveConnector.type.BOLD_DOUBLE_RIGHT,rptend:c.StaveConnector.type.BOLD_DOUBLE_RIGHT,invis:null},vexTypesBarlineLeft:{single:c.StaveConnector.type.SINGLE_LEFT,
dbl:c.StaveConnector.type.THIN_DOUBLE,end:c.StaveConnector.type.BOLD_DOUBLE_LEFT,rptstart:c.StaveConnector.type.BOLD_DOUBLE_LEFT,invis:null},init:function(a){var b=this,g,q,k,p,h,n,s=a.models,w=a.staffs,v=a.barline_l,y=a.barline_r,C=a.system_n;n=a.labelMode;f.each(s,function(){g=y?b.vexTypesBarlineRight[y]:b.vexTypes[this.symbol];q=w[this.top_staff_n];k=w[this.bottom_staff_n];"number"===typeof g&&q&&k&&(p=new c.StaveConnector(q,k),p.setType(g),b.allVexConnectors.push(p),"full"===n?h=1===C?this.label:
this.labelAbbr:"abbr"===n&&(h=this.labelAbbr),h&&p.setText(h));v&&(g=b.vexTypesBarlineLeft[v],"number"===typeof g&&q&&k&&(p=new c.StaveConnector(q,k),p.setType(g),g===c.StaveConnector.type.BOLD_DOUBLE_LEFT&&(p.checkShift=!0),b.allVexConnectors.push(p)))})},getAll:function(){return this.allVexConnectors},setContext:function(a){this.ctx=a;return this},draw:function(){var a,b,c,f;a=0;for(b=this.allVexConnectors.length;a<b;a+=1)c=this.allVexConnectors[a],c.checkShift&&(f=c.top_stave.getModifierXShift(),
0<f&&c.setXShift(f)),c.setContext(this.ctx).draw()}};return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.StaffVoice=function(a,b){this.voice=a;this.staff_n=b};a.StaveVoices=function(){this.all_voices=[];this.formatter=new c.Formatter};a.StaveVoices.prototype={addStaffVoice:function(a){this.all_voices.push(a)},addVoice:function(b,c){this.addStaffVoice(new a.StaffVoice(b,c))},reset:function(){this.all_voices=[]},preFormat:function(){var a,b,c;a=this.all_voices;this.vexVoices=[];this.vexVoicesStaffWise=
{};for(c=a.length;c--;)this.vexVoices.push(a[c].voice),b=a[c].staff_n,this.vexVoicesStaffWise[b]?this.vexVoicesStaffWise[b].push(a[c].voice):this.vexVoicesStaffWise[b]=[a[c].voice];this.formatter.preCalculateMinTotalWidth(this.vexVoices);return this.formatter.getMinTotalWidth()},format:function(a){var b,c;c=this.formatter;for(b in this.vexVoicesStaffWise)c.joinVoices(this.vexVoicesStaffWise[b],{align_rests:!0});c.formatToStave(this.vexVoices,a)},draw:function(a,b){var c,f,g=this.all_voices;for(c=
0;c<g.length;++c)f=g[c],f.voice.draw(a,b[f.staff_n])}};return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.System=function(a){this.init(a)};a.System.prototype={LABEL_PADDING:20,init:function(a){this.leftMar=a.leftMar;this.coords=a.coords;this.staffYs=a.staffYs;this.labels=a.labels;this.measures=[]},getStaffYs:function(){return this.staffYs},addMeasure:function(a){this.measures.push(a)},getMeasure:function(a){return this.measures[a]},getMeasures:function(){return this.measures},getLastMeasure:function(){return this.measures[this.measures.length-
1]},calculateInitialIndent:function(a){var b,c=0,f,g,h;a.setFont("Times",16);for(b in this.labels)f=this.labels[b],"string"===typeof f&&(f=a.measureText(this.labels[b]).width,c<f&&(c=f));g=this.getMeasures()[0].startConnectors.getAll();for(h=g.length;h--;)f=g[h].text,"string"===typeof f&&(f=a.measureText(this.labels[b]).width,c<f&&(c=f));this.leftMar=0===c?0:c+this.LABEL_PADDING},calculateMinMeasureWidths:function(){for(var a=this.measures,b=a.length;b--;)a[b].calculateMinWidth()},setFinalMeasureWidths:function(){var a,
b,c=0,f=0;a=0;for(b=this.measures.length;a<b;a+=1)null===this.measures[a].meiW?(f+=1,c+=this.measures[a].getMinWidth()):c+=this.measures[a].meiW;c=Math.floor((this.coords.w-this.leftMar-c)/f);a=0;for(b=this.measures.length;a<b;a+=1)this.measures[a].setFinalWidth(c)},format:function(a){var b,c,f,g;"number"!==typeof this.leftMar&&this.calculateInitialIndent(a);this.calculateMinMeasureWidths();this.setFinalMeasureWidths();f=this.coords.x+this.leftMar;c=this.getMeasures();a=0;for(b=c.length;a<b;a+=1)c[a]&&
(g=0===a?this.labels:null,c[a].format(f,g),f+=c[a].w),c[a].addTempoToStaves();return this},draw:function(a){for(var b=this.measures.length;b--;)this.measures[b]&&this.measures[b].draw(a)}};return a}(s||{},h,Vex.Flow,jQuery);s=function(a,b,c,f,g){a.SystemInfo=function(){};a.SystemInfo.prototype={STAVE_HEIGHT:40,init:function(a,b){this.cfg=a;this.printSpace=b;this.currentStaffInfos=[];this.systemLeftMar=g;this.currentLowestY=0;this.startConnectorInfos={};this.inlineConnectorInfos={}},setLeftMar:function(a){this.systemLeftMar=
a},getLeftMar:function(){return this.systemLeftMar},setModelForStaveRange:function(a,b,c){a[b.top_staff_n+":"+b.bottom_staff_n+(c||"")]=b},setConnectorModels:function(b,c,g){var h,k,p;k=c.first_n;p=c.last_n;c=f(b).attr("symbol");h=f(b).attr("barthru");a.L("Converter.setConnectorModels() {2}","symbol: "+c," range.first_n: "+k," range.last_n: "+p);this.setModelForStaveRange(this.startConnectorInfos,{top_staff_n:k,bottom_staff_n:p,symbol:c||"line",label:f(b).attr("label"),labelAbbr:f(b).attr("label.abbr")});
!g&&this.cfg.autoStaveConnectorLine&&this.setModelForStaveRange(this.startConnectorInfos,{top_staff_n:k,bottom_staff_n:p,symbol:"none"===c?"none":"line"},"autoline");"true"===h&&this.setModelForStaveRange(this.inlineConnectorInfos,{top_staff_n:k,bottom_staff_n:p,symbol:"singleright"})},getStaffInfo:function(a){return this.currentStaffInfos[a]},getAllStaffInfos:function(){return this.currentStaffInfos},getClef:function(b){var c;c=this.currentStaffInfos[b];if(!c)throw new a.RUNTIME_ERROR("MEI2VF.getClefForStaffNr():E01",
"No staff definition for staff n="+b);return c.getClef()},getCurrentLowestY:function(){return this.currentLowestY},setCurrentLowestY:function(a){this.currentLowestY=a},getYs:function(a){var b,c,f,g=!0,h,r=[];b=0;c=1;for(f=this.currentStaffInfos.length;c<f;c+=1)this.currentStaffInfos[c]&&(h=this.currentStaffInfos[c].spacing,b+=g?0:null!==h?this.STAVE_HEIGHT+this.currentStaffInfos[c].spacing:this.STAVE_HEIGHT+this.cfg.staveSpacing,r[c]=a+b,g=!1);a=a+b+this.STAVE_HEIGHT;a>this.currentLowestY&&(this.currentLowestY=
a);return r},forceSectionStartInfos:function(){for(var a=this.currentStaffInfos.length;a--;)this.currentStaffInfos[a]&&this.currentStaffInfos[a].forceSectionStartInfo()},forceStaveStartInfos:function(){for(var a=this.currentStaffInfos.length;a--;)this.currentStaffInfos[a]&&this.currentStaffInfos[a].forceStaveStartInfo()},processScoreDef:function(a){var b,c;b=f(a).attr("system.leftmar");"string"===typeof b&&this.setLeftMar(+b);c=f(a).children();a=0;for(b=c.length;a<b;a+=1)this.processScoreDef_child(c[a])},
processScoreDef_child:function(b){switch(b.localName){case "staffGrp":this.processStaffGrp(b);break;case "pgHead":break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <scoreDef>");}},processStaffGrp:function(b,c){var g=this,h={};f(b).children().each(function(b,c){var d=g.processStaffGrp_child(c);a.L("Converter.processStaffGrp() {1}.{a}","childRange.first_n: "+d.first_n," childRange.last_n: "+d.last_n);0===b&&(h.first_n=d.first_n);h.last_n=
d.last_n});g.setConnectorModels(b,h,c);return h},processStaffGrp_child:function(b){switch(b.localName){case "staffDef":return b=this.processStaffDef(b),{first_n:b,last_n:b};case "staffGrp":return this.processStaffGrp(b,!0);default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <staffGrp>");}},processStaffDef:function(b){var c,g;c=+f(b).attr("n");(g=this.currentStaffInfos[c])?g.updateDef(b):this.currentStaffInfos[c]=new a.StaffInfo(b,!0,!0,!0);return c}};
return a}(s||{},h,Vex.Flow,jQuery);Vex.Flow.KeySignature=function(){function a(a,c){0<arguments.length&&this.init(a,c)}Vex.Inherit(a,Vex.Flow.StaveModifier,{init:function(b,c){a.superclass.init();this.setPadding(c||10);this.glyphFontScale=38;this.accList=Vex.Flow.keySignature(b)},addAccToStave:function(a,c){var f=new Vex.Flow.Glyph(c.glyphCode,this.glyphFontScale);this.placeGlyphOnLine(f,a,c.line);a.addGlyph(f)},addModifier:function(a){this.convertAccLines(a.clef,this.accList[0].glyphCode);for(var c=
0;c<this.accList.length;++c)this.addAccToStave(a,this.accList[c])},addToStave:function(a,c){if(0===this.accList.length)return this;c||a.addGlyph(this.makeSpacer(this.padding));this.addModifier(a);return this},convertAccLines:function(a,c){var f=0,g="tenor"===a&&"v18"===c?!0:!1;switch(a){case "bass":f=1;break;case "alto":f=.5;break;case "tenor":g||(f=-.5)}if(g)for(f=[3,1,2.5,.5,2,0,1.5],g=0;g<this.accList.length;++g)this.accList[g].line=f[g];else if("treble"!=a)for(g=0;g<this.accList.length;++g)this.accList[g].line+=
f}});return a}();Vex.Flow.Hyphen=function(){function a(a){0<arguments.length&&this.init(a)}a.prototype={init:function(a){this.max_hyphen_distance=a.max_hyphen_distance||75;this.font={family:"Arial",size:10,style:""};this.config=a;this.context=null},setContext:function(a){this.context=a;return this},setFont:function(a){this.font=a;return this},renderHyphen:function(){var a=this.config,c=this.context,f=a.hyphen_width||c.measureText("-").width,g=a.first_annot,d=a.last_annot,a=g.text?g.x+g.text_width:
g.x,l=d.x-a;if(l>f)for(g=g.y&&d.y?(g.y+d.y)/2:g.y||d.y,d=Math.ceil(l/this.max_hyphen_distance),l/=d+1;d--;)a+=l,c.fillText("-",a-f/2,g)},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","No context to render hyphens.");var a=this.context;a.save();a.setFont(this.font.family,this.font.size,this.font.style);this.renderHyphen();a.restore();return!0}};return a}();Vex.Flow.durationToTicks.durations.d||(Vex.Flow.durationToTicks.durations.d=Vex.Flow.RESOLUTION/.5);Vex.Flow.durationToGlyph.duration_codes.d||
(Vex.Flow.durationToGlyph.duration_codes.d={common:{head_width:20,stem:!1,stem_offset:0,flag:!1,dot_shiftY:0,line_above:0,line_below:0},type:{n:{code_head:"noteheadDoubleWholeSquare"},h:{code_head:"v46"},m:{code_head:"v92",stem_offset:-3},r:{code_head:"restDoubleWhole",head_width:12,rest:!0,position:"D/5",dot_shiftY:.5},s:{head_width:15,position:"B/4"}}});Vex.Flow.durationToTicks.durations.l||(Vex.Flow.durationToTicks.durations.l=Vex.Flow.RESOLUTION/.25);Vex.Flow.durationToGlyph.duration_codes.l||
(Vex.Flow.durationToGlyph.duration_codes.l={common:{head_width:20,stem:!1,stem_offset:0,flag:!1,dot_shiftY:0,line_above:0,line_below:0},type:{n:{code_head:"noteheadQuadWholeSquare"},h:{code_head:"v46"},m:{code_head:"v92",stem_offset:-3},r:{code_head:"restDoubleWhole",head_width:12,rest:!0,position:"D/5",dot_shiftY:.5},s:{head_width:15,position:"B/4"}}});Vex.Flow.Font.glyphs.gClef={x_min:0,x_max:948,ha:944,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 948 35 l 948 15 b 693 -328 948 -141 850 -269 b 728 -536 711 -454 728 -536 b 736 -633 734 -571 736 -603 b 489 -920 736 -853 588 -914 b 456 -921 477 -920 466 -921 b 190 -700 225 -921 190 -777 b 196 -650 190 -671 195 -650 b 323 -532 204 -587 259 -536 l 333 -532 b 476 -665 409 -532 469 -592 l 476 -675 b 378 -806 476 -738 435 -788 b 343 -815 365 -812 356 -812 b 330 -826 336 -818 330 -820 b 343 -841 330 -830 335 -836 b 459 -869 372 -862 412 -869 l 486 -869 b 673 -638 503 -869 673 -867 b 665 -543 673 -610 671 -578 l 633 -347 l 626 -347 b 531 -353 595 -351 563 -353 b 10 94 301 -353 36 -245 b 8 136 8 108 8 122 b 445 788 8 406 239 612 l 428 876 b 419 1019 421 925 419 973 b 645 1543 419 1273 511 1484 b 750 1410 645 1543 696 1534 b 811 1141 790 1319 811 1229 b 528 594 811 951 715 767 b 573 354 542 518 557 445 b 591 357 578 357 585 357 l 606 357 b 948 35 785 357 937 216 m 655 1320 b 477 948 545 1315 477 1092 b 480 897 477 930 477 913 b 491 829 480 889 486 862 b 745 1177 641 942 728 1061 b 748 1208 746 1189 748 1198 b 655 1320 748 1284 701 1320 m 120 22 l 120 11 b 531 -302 129 -234 378 -302 b 623 -291 570 -302 602 -298 l 547 157 b 382 -3 455 141 382 95 l 382 -17 b 476 -155 385 -74 448 -143 b 497 -181 487 -161 497 -172 b 480 -192 497 -186 491 -192 b 451 -186 473 -192 463 -190 b 300 0 385 -165 322 -95 b 291 62 294 20 291 41 b 517 344 291 188 391 307 l 482 563 b 120 22 298 427 120 256 m 683 -276 b 833 -64 781 -234 833 -162 l 833 -49 b 609 162 827 69 727 162 l 603 162 b 683 -276 633 4 661 -148 "};
Vex.Flow.Font.glyphs.gClef8vb={x_min:0,x_max:937,ha:930,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 937 46 l 937 24 b 685 -316 937 -130 839 -256 b 717 -521 704 -441 717 -521 b 727 -622 724 -557 727 -591 b 533 -896 727 -799 624 -872 b 588 -963 563 -906 588 -928 b 546 -1030 588 -1008 559 -1016 b 535 -1049 538 -1036 535 -1042 b 540 -1070 535 -1054 538 -1061 b 553 -1116 549 -1085 553 -1100 b 493 -1203 553 -1154 531 -1189 b 435 -1211 473 -1211 455 -1211 b 315 -1133 391 -1211 328 -1183 b 314 -1120 314 -1128 314 -1124 b 382 -1030 314 -1082 349 -1040 b 391 -1023 388 -1029 391 -1026 b 388 -1016 391 -1021 389 -1018 b 365 -963 372 -1000 365 -981 b 396 -903 365 -941 377 -918 b 185 -680 213 -879 185 -750 b 190 -634 185 -652 189 -634 b 319 -518 200 -570 252 -521 l 329 -518 b 468 -650 402 -518 462 -578 l 468 -657 b 371 -790 468 -720 428 -770 b 337 -799 360 -797 350 -797 b 326 -809 330 -801 326 -805 b 337 -825 326 -813 329 -818 b 454 -853 367 -846 407 -853 l 476 -853 b 665 -620 493 -853 665 -850 b 657 -526 665 -592 662 -561 l 626 -336 l 617 -336 b 531 -342 589 -339 560 -342 b 7 102 301 -342 35 -237 b 6 144 6 116 6 130 b 435 792 6 414 234 617 l 423 881 b 413 1025 416 930 413 979 b 637 1541 413 1275 501 1483 b 741 1411 637 1541 689 1532 b 801 1142 780 1320 801 1231 b 522 599 801 953 707 773 b 566 363 533 524 550 452 b 585 365 571 365 577 365 l 601 365 b 937 46 777 365 927 225 m 435 -1196 b 484 -1148 462 -1196 484 -1170 b 482 -1130 484 -1142 484 -1135 b 447 -1082 473 -1110 462 -1095 b 426 -1064 440 -1075 430 -1070 b 406 -1053 420 -1061 413 -1053 b 385 -1064 396 -1053 391 -1061 b 379 -1075 382 -1067 379 -1070 b 364 -1117 370 -1085 364 -1102 b 365 -1127 364 -1120 365 -1124 b 435 -1196 374 -1170 409 -1196 m 540 -966 l 540 -956 b 528 -925 540 -944 535 -930 b 473 -903 514 -911 493 -903 b 430 -937 452 -906 433 -914 b 455 -983 430 -956 442 -970 b 490 -1014 465 -993 476 -1005 b 508 -1021 497 -1018 503 -1021 b 540 -966 531 -1021 538 -986 m 648 1322 b 468 946 538 1315 468 1089 b 470 902 468 930 469 916 b 484 833 470 893 476 867 b 736 1179 634 946 717 1063 b 738 1208 738 1189 738 1198 b 648 1322 738 1284 694 1322 m 116 35 l 116 21 b 522 -290 123 -223 370 -290 b 615 -279 561 -290 594 -286 l 540 165 b 375 8 447 150 375 104 l 375 -6 b 468 -143 379 -62 440 -132 b 489 -168 480 -148 489 -160 b 470 -179 489 -175 483 -179 b 442 -175 463 -179 454 -178 b 293 11 379 -153 315 -83 b 286 70 288 31 286 50 b 508 351 286 195 382 315 l 473 568 b 116 35 293 437 116 266 m 675 -262 b 822 -52 770 -221 822 -150 l 822 -36 b 602 171 816 80 717 171 l 596 171 b 675 -262 626 14 652 -137 "};
Vex.Flow.Font.glyphs.noteheadDoubleWholeSquare={x_min:0,x_max:746,ha:746,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 724 350 b 746 328 736 350 746 340 l 746 -328 b 724 -350 746 -339 736 -350 b 701 -328 711 -350 701 -339 l 701 -270 b 659 -234 701 -253 683 -234 l 83 -234 b 45 -276 67 -234 45 -256 l 45 -328 b 22 -350 45 -339 35 -350 b 0 -328 10 -350 0 -339 l 0 328 b 22 350 0 340 10 350 b 45 328 35 350 45 340 l 45 260 b 77 218 45 260 64 218 l 659 218 b 701 265 679 218 701 232 l 701 328 b 724 350 701 340 711 350 m 45 18 l 45 -36 b 146 -94 45 -70 83 -94 l 606 -94 b 701 -36 664 -94 701 -77 l 701 28 b 606 78 701 57 664 78 l 139 78 b 45 18 71 78 45 59 "};
Vex.Flow.Font.glyphs.noteheadQuadWholeSquare={x_min:0,x_max:746,ha:746,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 724 350 b 746 328 736 350 746 340 l 746 -1428 b 724 -1450 746 -1439 736 -1450 b 701 -1428 711 -1450 701 -1439 l 701 -270 b 659 -234 701 -253 683 -234 l 83 -234 b 45 -276 67 -234 45 -256 l 45 -328 b 22 -350 45 -339 35 -350 b 0 -328 10 -350 0 -339 l 0 328 b 22 350 0 340 10 350 b 45 328 35 350 45 340 l 45 260 b 77 218 45 260 64 218 l 659 218 b 701 265 679 218 701 232 l 701 328 b 724 350 701 340 711 350 m 45 18 l 45 -36 b 146 -94 45 -70 83 -94 l 606 -94 b 701 -36 664 -94 701 -77 l 701 28 b 606 78 701 57 664 78 l 139 78 b 45 18 71 78 45 59 "};
Vex.Flow.Font.glyphs.restDoubleWhole={x_min:0,x_max:640,ha:202,o:"0 0 133 0 1 1 640 640 2 -2 0 -1280 m 200 24 b 173 0 200 11 189 0 l 26 0 b 0 24 11 0 0 11 l 0 376 b 26 400 0 389 11 400 l 173 400 b 200 376 189 400 200 389 l 200 24 "};Vex.Flow.clefProperties.values.octave={line_shift:3.5};Vex.Flow.Clef.types.octave={code:"gClef8vb",point:40,line:3};Vex.Flow.Clef.types.treble={code:"gClef",point:40,line:3};Vex.Flow.Curve.prototype.renderCurve=function(a){var b=this.context,c=this.render_options.cps,
f=this.render_options.x_shift,g=this.render_options.y_shift*a.direction,d=a.first_x+f,l=a.first_y+g+(this.render_options.y_shift_start||0),f=a.last_x-f,g=a.last_y+g+(this.render_options.y_shift_end||0),h=this.render_options.thickness,q=(f-d)/(c.length+2);b.beginPath();b.moveTo(d,l);b.bezierCurveTo(d+q+c[0].x,l+c[0].y*a.direction,f-q+c[1].x,g+c[1].y*a.direction,f,g);b.bezierCurveTo(f-q+c[1].x,g+(c[1].y+h)*a.direction,d+q+c[0].x,l+(c[0].y+h)*a.direction,d,l);b.stroke();b.closePath();b.fill()};Vex.Flow.Annotation=
function(){function a(a){0<arguments.length&&this.init(a)}function b(){a.DEBUG&&Vex.L("Vex.Flow.Annotation",arguments)}a.Justify={LEFT:1,CENTER:2,RIGHT:3,CENTER_STEM:4};a.VerticalJustify={TOP:1,CENTER:2,BOTTOM:3,CENTER_STEM:4};var c=Vex.Flow.Modifier;Vex.Inherit(a,c,{init:function(b){a.superclass.init.call(this);this.index=this.note=null;this.text_line=0;this.text=b;this.justification=a.Justify.CENTER;this.vert_justification=a.VerticalJustify.TOP;this.font={family:"Arial",size:10,weight:""};this.setWidth(Vex.Flow.textWidth(b))},
getCategory:function(){return"annotations"},setTextLine:function(a){this.text_line=a;return this},setFont:function(a,b,c){this.font={family:a,size:b,weight:c};return this},setVerticalJustification:function(a){this.vert_justification=a;return this},getJustification:function(){return this.justification},setJustification:function(a){this.justification=a;return this},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","Can't draw text annotation without a context.");if(!this.note)throw new Vex.RERR("NoNoteForAnnotation",
"Can't draw text annotation without an attached note.");var f=this.note.getModifierStartXY(c.Position.ABOVE,this.index);this.context.save();this.context.setFont(this.font.family,this.font.size,this.font.weight);var g=this.context.measureText(this.text).width,d=this.context.measureText("M").width,l,f=this.justification==a.Justify.LEFT?f.x:this.justification==a.Justify.RIGHT?f.x-g:this.justification==a.Justify.CENTER?f.x-g/2:this.note.getStemX()-g/2,h,q,k=this.note.hasStem();l=this.note.getStave();
k&&(h=this.note.getStemExtents(),q=l.getSpacingBetweenLines());this.vert_justification==a.VerticalJustify.BOTTOM?(l=l.getYForBottomText(this.text_line),k&&(h=1===this.note.getStemDirection()?h.baseY:h.topY,l=Math.max(l,h+q*(this.text_line+2)))):this.vert_justification==a.VerticalJustify.CENTER?(q=this.note.getYForTopText(this.text_line)-1,h=l.getYForBottomText(this.text_line),l=q+(h-q)/2+d/2):this.vert_justification==a.VerticalJustify.TOP?(l=Math.min(l.getYForTopText(this.text_line),this.note.getYs()[0]-
10),k&&(l=Math.min(l,h.topY-5-q*this.text_line))):(q=this.note.getStemExtents(),l=q.topY+(q.baseY-q.topY)/2+d/2);this.x=f;this.y=l;this.text_height=d;this.text_width=g;b("Rendering annotation: ",this.text,f,l);this.context.fillText(this.text,f,l);this.context.restore()}});return a}();Vex.Flow.StaveTie=function(){function a(a,c){0<arguments.length&&this.init(a,c)}a.prototype={init:function(a,c){this.notes=a;this.context=null;this.text=c;this.render_options={cp1:8,cp2:12,text_shift_x:0,first_x_shift:0,
last_x_shift:0,y_shift:7,tie_spacing:0,font:{family:"Arial",size:10,style:""}};this.font=this.render_options.font;this.setNotes(a)},setContext:function(a){this.context=a;return this},setFont:function(a){this.font=a;return this},setNotes:function(a){if(!a.first_note&&!a.last_note)throw new Vex.RuntimeError("BadArguments","Tie needs to have either first_note or last_note set.");a.first_indices||(a.first_indices=[0]);a.last_indices||(a.last_indices=[0]);if(a.first_indices.length!=a.last_indices.length)throw new Vex.RuntimeError("BadArguments",
"Tied notes must have similar index sizes");this.first_note=a.first_note;this.first_indices=a.first_indices;this.last_note=a.last_note;this.last_indices=a.last_indices;return this},isPartial:function(){return!this.first_note||!this.last_note},setDir:function(a){this.curvedir=a},getDir:function(){return this.curvedir},renderTie:function(a){if(0===a.first_ys.length||0===a.last_ys.length)throw new Vex.RERR("BadArguments","No Y-values to render");this.curvedir?a.direction="above"===this.curvedir?-1:1:
this.curvedir=a.direction;var c=this.context,f=this.render_options.cp1,g=this.render_options.cp2;10>Math.abs(a.last_x_px-a.first_x_px)&&(f=2,g=8);for(var d=this.render_options.first_x_shift,l=this.render_options.last_x_shift,h=this.render_options.y_shift*a.direction,q=0;q<this.first_indices.length;++q){var k=(a.last_x_px+l+(a.first_x_px+d))/2,p=a.first_ys[this.first_indices[q]]+h,r=a.last_ys[this.last_indices[q]]+h;if(isNaN(p)||isNaN(r))throw new Vex.RERR("BadArguments","Bad indices for tie rendering.");
var n=(p+r)/2+f*a.direction,s=(p+r)/2+g*a.direction;c.beginPath();c.moveTo(a.first_x_px+d,p);c.quadraticCurveTo(k,n,a.last_x_px+l,r);c.quadraticCurveTo(k,s,a.first_x_px+d,p);c.closePath();c.fill()}},renderText:function(a,c){if(this.text){var f;f=(a+c)/2-this.context.measureText(this.text).width/2;this.context.save();this.context.setFont(this.font.family,this.font.size,this.font.style);this.context.fillText(this.text,f+this.render_options.text_shift_x,(this.first_note||this.last_note).getStave().getYForTopText()-
1);this.context.restore()}},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","No context to render tie.");var a=this.first_note,c=this.last_note,f,g,d,l;a?(f=a.getTieRightX()+this.render_options.tie_spacing,l=a.getStemDirection(),d=a.getYs()):(f=c.getStave().getTieStartX(),d=c.getYs(),this.first_indices=this.last_indices);c?(g=c.getTieLeftX()+this.render_options.tie_spacing,l=c.getStemDirection(),a=c.getYs()):(g=a.getStave().getTieEndX(),a=a.getYs(),this.last_indices=this.first_indices);
this.renderTie({first_x_px:f,last_x_px:g,first_ys:d,last_ys:a,direction:l});this.renderText(f,g);return!0}};return a}();Vex.Flow.NoteHead.prototype.draw=function(){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw without a canvas context.");var a=this.context,b=this.getAbsoluteX(),c=this.y,f=this.stem_direction,g=this.render_options.glyph_font_scale,d=this.line;if((0>=d||6<=d)&&"r"!==this.note_type){var l=c,h=Math.floor(d);0>d&&-.5==h-d?l-=5:6<d&&-.5==h-d&&(l+=5);a.fillRect(b-this.render_options.stroke_px,
l,this.getGlyph().head_width+2*this.render_options.stroke_px,1)}"s"==this.note_type?drawSlashNoteHead(a,this.duration,b,c,f):this.style?(a.save(),this.applyStyle(a),Vex.Flow.renderGlyph(a,b,c,g,this.glyph_code),a.restore()):Vex.Flow.renderGlyph(a,b,c,g,this.glyph_code)};Vex.Flow.Beam.prototype.init=function(a,b){if(!a||a==[])throw new Vex.RuntimeError("BadArguments","No notes provided for beam.");if(1==a.length)throw new Vex.RuntimeError("BadArguments","Too few notes for beam.");this.ticks=a[0].getIntrinsicTicks();
if(this.ticks>=Vex.Flow.durationToTicks("4"))throw new Vex.RuntimeError("BadArguments","Beams can only be applied to notes shorter than a quarter note.");var c,f;this.stem_direction=1;for(c=0;c<a.length;++c)if(f=a[c],f.hasStem()){this.stem_direction=f.getStemDirection();break}var g=-1;if(b&&"stavenotes"===a[0].getCategory()){this.min_line=1E3;for(c=0;c<a.length;++c)f=a[c],f.getKeyProps&&(f=f.getKeyProps(),this.min_line=Math.min((f[0].line+f[f.length-1].line)/2,this.min_line));3>this.min_line&&(g=
1)}else b&&"tabnotes"===a[0].getCategory()&&(g=-1<a.reduce(function(a,b){return a+b.stem_direction},0)?1:-1);for(c=0;c<a.length;++c)f=a[c],b&&(f.setStemDirection(g),this.stem_direction=g),f.setBeam(this);this.postFormatted=!1;this.notes=a;this.beam_count=this.getBeamCount();this.break_on_indices=[];this.render_options={beam_width:5,max_slope:.25,min_slope:-.25,slope_iterations:20,slope_cost:100,show_stemlets:!1,stemlet_extension:7,partial_beam_length:10}};Vex.Flow.Beam.prototype.calculateSlope=function(){for(var a=
this.notes[0],b=a.getStemExtents().topY,a=a.getStemX(),c=(this.render_options.max_slope-this.render_options.min_slope)/this.render_options.slope_iterations,f=Number.MAX_VALUE,g=0,d=0,l=this.render_options.min_slope;l<=this.render_options.max_slope;l+=c){for(var h=0,q=0,k=1;k<this.notes.length;++k){var p=this.notes[k],n=p.getStemX(),p=p.getStemExtents().topY,n=this.getSlopeY(n,a,b,l)+q;p*this.stem_direction<n*this.stem_direction?(n=Math.abs(p-n),q+=n*-this.stem_direction,h+=n*k):h+=(p-n)*this.stem_direction}k=
this.notes[this.notes.length-1];k=(k.getStemExtents().topY-b)/(k.getStemX()-a)/2;k=Math.abs(k-l);h=this.render_options.slope_cost*k+Math.abs(h);h<f&&(f=h,g=l,d=q)}this.slope=g;this.y_shift=d};var s=function(a,b,c,f,g){a.Util={attsToObj:function(a){var b,c={};if(a.hasAttributes())for(b=a.attributes.length;b--;)c[a.attributes[b].nodeName]=a.attributes[b].nodeValue;return c},attsToString:function(a){var b="",c,f,g;if(a.hasAttributes())for(f=a.attributes,a=0,c=f.length;a<c;a+=1)g=f.item(a),b+=" "+g.nodeName+
'="'+g.nodeValue+'"';return b},drawBoundingBoxes:function(a,b){var c,g,k,h,n,s,w;b=b||{};a.save();if(b.staffs&&b.staffs.data)for(c=0,g=b.staffs.data.length;c<g;c+=1)if(n=b.staffs.data[c])for(k=0,h=n.length;k<h;k+=1)n[k]&&(s=n[k],n[k].getBoundingBox().draw(a),w={x:s.getNoteStartX(),y:s.getYForLine(0)-30,w:s.getNoteEndX()-s.getNoteStartX(),h:s.getYForLine(4)-s.getYForLine(0)+60},this.drawRectangle(w,"120, 80, 200",a,b.frame),w={x:s.x,y:s.getYForLine(0)-30,w:s.getModifierXShift(),h:s.getYForLine(4)-
s.getYForLine(0)+60},this.drawRectangle(w,"100, 100, 0",a,b.frame));b.voices&&b.voices.data&&f.each(b.voices.data,function(){this&&this.all_voices&&f.each(this.all_voices,function(){this&&this.voice&&(this.voice.boundingBox&&b.voices.drawFrame&&this.voice.getBoundingBox().draw(a),b.voices.drawTickables&&f.each(this.voice.tickables,function(){this.getBoundingBox().draw(a)}))})});a.restore()},drawRectangle:function(a,b,c,f){f&&(c.strokeStyle="rgba("+b+", 0.5)",c.rect(a.x,a.y,a.w,a.h));c.fillStyle="rgba("+
b+", 0.1)";c.fillRect(a.x,a.y,a.w,a.h);c.stroke()}};return a}(s||{},h,Vex.Flow,jQuery),K={enabled:!1,setEnabled:function(a){this.enabled=a},log:function(){this.enabled&&Vex.L("MEISnippetViewer",arguments)}},G={initXmlDoc:function(a){return"string"===typeof a?this.parseXML(a):a[0]||a},parseXML:function(a){var b;window.DOMParser?(b=new DOMParser,b=b.parseFromString(a,"text/xml")):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a));return b},ascertainDescendantIds:function(a,b){var c,f=
a.getElementsByTagName("*");for(c=f.length;c--;)f[c].hasAttribute("xml:id")||f[c].setAttribute("xml:id",b+c)},getMEIPageConfig:function(a){a=B.Util.attsToObj(a);var b=function(a){return isNaN(a)||0===a.length?E:+a};return{page_scale:parseInt(a["page.scale"],10)/100||E,page_height:b(a["page.height"]),page_width:b(a["page.width"]),page_margin_top:b(a["page.topmar"]),page_margin_left:b(a["page.leftmar"]),page_margin_right:b(a["page.rightmar"])}}},v=function(a,b){this.error_code=a;this.message=b};v.prototype.toString=
function(){return'MSV.RuntimeError, code "'+this.error_code+'": '+this.message};var L=function(){this.init()};L.prototype={init:function(){this.mouseClickHandlers=[];this.mouseMoveHandlers=[];this.vexLayerIndex=null},createLayers:function(a){var b,c,f="",g,d,l=!1,h;this.scale=a.page_scale;d=a.layers;b=a.page_height*a.page_scale;c=a.page_width*a.page_scale;g=d.length;for(h='<canvas width="'+c+'" height="'+b+'" style="position:absolute;background-color:transparent;"></canvas>';g--;)"vex"===d[g].type&&
(l=!0),f+=h;l||(K.log("UI.createLayers()","No VexFlow layer specified. Adding it."),d.push({type:"vex"}),f+=h);f=n('<div class="outer-container" style="margin-left:'+c/2+"px;margin-right:"+c/2+'px;"><div class="inner-container" style="position:relative;width:100%;margin:auto;height:'+b+"px;left:-"+c/2+'px">'+f+"</div></div>").appendTo(a.target).get(0).getElementsByTagName("canvas");for(g=d.length;g--;){b=f[g];if("vex"===d[g].type)this.vexLayerIndex=g,c=this.createVexContext(b,a.backend),d[g].element=
b,d[g].ctx=c;else if("highlighter"===d[g].type)c=b.getContext("2d"),d[g].setElement(b),d[g].setContext(c),d[g].setScale(a.page_scale);else throw new v("Configuration Error",'Layer type "'+d[g].type+'" not valid.');this.scaleContext(c,a)}this.topCanvas=d[d.length-1].element;return d},createVexContext:function(a,b){return(new w.Renderer(a,b||w.Renderer.Backends.CANVAS)).getContext()},scaleContext:function(a,b){var c,f,g;+b.backend===w.Renderer.Backends.RAPHAEL?(c=a.paper,g=b.page_height,f=b.page_width,
c.setSize(f*scale,g*scale),c.setViewBox(0,0,f,g)):a.scale(this.scale,this.scale)},registerMouseClickHandler:function(a){this.mouseClickHandlers.push(a)},registerMouseMoveHandler:function(a){this.mouseMoveHandlers.push(a)},listenMouseClick:function(){var a=this;n(a.topCanvas).on("click",function(b){var c,f;c=n(this).offset();c={x:(b.pageX-c.left)/a.scale,y:(b.pageY-c.top)/a.scale};for(f=a.mouseClickHandlers.length;f--&&!1!==a.mouseClickHandlers[f].onClick(c,a.topCanvas,b););})},listenMouseMove:function(){var a=
this;a.topCanvas.onmouseleave=function(b){for(var c=a.mouseMoveHandlers.length;c--;)a.mouseMoveHandlers[c].removeHighlight(),a.mouseMoveHandlers[c].mouseLeaveHandler&&a.mouseMoveHandlers[c].mouseLeaveHandler(null,a.topCanvas,b)};n(a.topCanvas).mousemove(function(b){var c,f;c=n(this).offset();c={x:(b.pageX-c.left)/a.scale,y:(b.pageY-c.top)/a.scale};for(f=a.mouseMoveHandlers.length;f--&&!1!==a.mouseMoveHandlers[f].onMouseMove(c,a.topCanvas,b););})}};var N=function(a){this.viewer=a};N.prototype={setAreas:function(a,
b){var c,f,g;this.measureAreas=[];this.barlineAreas=[];this.measureModifierAreas=[];this.noteAreas=[];this.variantAreas=[];this.anchoredTextAreas=[];this.pgHeadAreas=[];var d={measures:[],variants:[],notes:[],barlines:[],measure_modifiers:[],anchoredTexts:[],pgHead:[]},l;for(c=b.length;c--;)if(g=b[c],"highlighter"===g.type)for(f=g.content.length;f--;)if(l=d[g.content[f]])l.push(g);else throw new v("Configuration Error",'Area type "'+g.content[f]+'" is not supported');c=d.measures.length;f=d.barlines.length;
g=d.measure_modifiers.length;if(0<c||0<f||0<g){for(this.calculateMeasureAreas(this.viewer.allVexMeasureStaffs);c--;)d.measures[c].addAreas(this.measureAreas);for(;f--;)d.barlines[f].addAreas(this.barlineAreas);for(;g--;)d.measure_modifiers[g].addAreas(this.measureModifierAreas)}c=d.notes.length;if(0<c)for(this.calculateNoteAreas(this.viewer.converter.getNotes());c--;)d.notes[c].addAreas(this.noteAreas);c=d.anchoredTexts.length;if(0<c)for(this.calculateAnchoredTextAreas(this.viewer.anchoredTexts.getAll());c--;)d.anchoredTexts[c].addAreas(this.anchoredTextAreas);
c=d.pgHead.length;if(0<c&&this.viewer.pgHead)for(this.calculatePgHeadAreas(this.viewer.pgHead.getTextsByLine());c--;)d.pgHead[c].addAreas(this.pgHeadAreas);c=d.variants.length;if(0<c)for(this.getVariantCoordinates(a);c--;)d.variants[c].addAreas(this.variantAreas);for(c=b.length;c--;)"highlighter"===b[c].type&&b[c].initHighlights()},calculateMeasureAreas:function(a){var b,c,f,g,d,l,h,n,k;b=0;for(c=a.length;b<c;b+=1)if(a[b])for(f=0,g=a[b].length;f<g;f+=1)if(d=a[b][f])l=d.x,h=d.y,n=d.width,k=d.getBottomY()-
20,this.measureAreas.push({ctx:{x:l,y:h,w:n,h:k-h,x1:l+n,y1:k},measureN:b,staffN:f}),this.calculateBarlineAreas(d,h,k-h),this.calculateStaffModifierAreas(d,h,k-h)},calculateBarlineAreas:function(a){var b,c;b=a.getYForLine(0)-5;c=a.getYForLine(4)-b+10;7!==a.modifiers[0].barline&&this.barlineAreas.push(this.createNoteAreaObj(a.modifiers[0].x-8,b,16,c,null,1));7!==a.modifiers[1].barline&&this.barlineAreas.push(this.createNoteAreaObj(a.modifiers[1].x-8,b,16,c,null,1))},calculateStaffModifierAreas:function(a,
b,c){var f;2<a.modifiers.length&&(f=a.glyph_start_x-4,a=a.start_x-a.glyph_start_x+8,this.measureModifierAreas.push(this.createNoteAreaObj(f,b,a,c,null,void 0)))},calculateNoteAreas:function(a){var b,c,f,g,d,h;for(b in a)c=a[b].vexNote,h=a[b].meiNote,f=c.getBoundingBox(),g=c.getAbsoluteX()-10,d=f.y-10,f=f.h+20,this.noteAreas.push(this.createNoteAreaObj(g,d,30,f,h,b)),this.calculateNoteModifierAreas(c)},createNoteAreaObj:function(a,b,c,f,g,d){return{ctx:{x:a,y:b,w:c,h:f,x1:a+c,y1:b+f},meiElement:g,
xmlid:d}},calculateAnchoredTextAreas:function(a){for(i=a.length;i--;)this.anchoredTextAreas.push(a[i].getArea())},calculatePgHeadAreas:function(a){var b,c,f;for(c=a.length;c--;)for(f=a[c],b=f.length;b--;)this.pgHeadAreas.push(f[b].getArea())},calculateNoteModifierAreas:function(a){a=a.modifiers;var b,c,f,g,d;for(b=a.length;b--;)switch(c=a[b].getCategory(),c){case "annotations":c=a[b].x-6;f=a[b].y-20;g=a[b].text_width+12;d=30;this.noteAreas.push(this.createNoteAreaObj(c,f,g,d,a[b].getMeiElement(),
b));break;case "articulations":d=g=a[b].width+8,c=a[b].x-g/2-a[b].articulation.shift_right,f=a[b].y-d/2-a[b].articulation.shift_down,this.noteAreas.push(this.createNoteAreaObj(c,f,g,d,a[b].getMeiElement(),b))}},calculateNoteModifierArea:function(){},calculateNoteArea:function(a,b){var c,f,g;c=a[b].vexNote;f=c.getBoundingBox();c=c.getAbsoluteX()-10;g=f.y-10;f=f.h+20;return{ctx:{x:c,y:g,w:30,h:f,x1:c+30,y1:g+f},xmlid:b}},getSurroundingArea:function(a){var b=a.length,c,f=[];for(c={x:1E4,y:1E4,x1:0,y1:0};b--;)f.push(a[b].xmlid),
c.x=Math.min(c.x,a[b].ctx.x),c.y=Math.min(c.y,a[b].ctx.y),c.x1=Math.max(c.x1,a[b].ctx.x1),c.y1=Math.max(c.y1,a[b].ctx.y1);c.w=c.x1-c.x;c.h=c.y1-c.y;return{ctx:c,xmlids:f}},getVariantCoordinates:function(a){var b,c,f,g,d;d=[];for(b in a.ALTs)d.push({alt:a.ALTs[b],grp:this.getVariantIds(a.ALTs[b])});for(b=d.length;b--;){a=d[b].grp;g=[];for(c in a)(f=this.getIdCoordinates(c,a[c]))&&g.push(f);a=this.getSurroundingArea(g);a.alt=d[b].alt;this.variantAreas.push(a)}},getVariantIds:function(a){var b,c,f;f=
a.getDefaultItem();a={};if(f)c=f.elem;else for(c in meiDoc.ALTs[b].altitems){c=meiDoc.ALTs[b].altitems[c].elem;break}var g=c.getElementsByTagName("*");b=0;for(c=g.length;b<c;b+=1)if(f=g[b].getAttribute("xml:id"))a[f]=g[b].localName;return a},getIdCoordinates:function(a,b){switch(b){case "note":return this.calculateNoteArea(this.viewer.converter.getNotes(),a);case "rest":return this.calculateNoteArea(this.viewer.converter.getNotes(),a);case "mRest":return this.calculateNoteArea(this.viewer.converter.getNotes(),
a)}}};var H=function(a,b,c,f,g){this.init(a,b,c,f,g)};H.prototype={init:function(a,b,c,f,g){this.meiElement=a;this.meiNodeMatch=g;b=c?b:n.extend({},b,B.Util.attsToObj(a));this.x=+b.x;this.y=+b.y;this.textAlign=b.halign||"left";this.text=f===E?n(a).text():f;this.atts=b},setX:function(a){this.x=a},setY:function(a){this.y=a},setTextAlign:function(a){this.textAlign=a},getArea:function(){return{ctx:{x:this.x-6,y:this.y-this.h,w:this.w+12,h:this.h+8,x1:this.x+this.w+6,y1:this.y+8},meiElement:this.meiElement,
meiNodeMatch:this.meiNodeMatch,xmlid:null}},setContext:function(a){this.ctx=a;return this},preProcess:function(){var a=this.ctx,b=this.atts;this.font=b.fontstyle+" "+b.fontweight+" "+b.fontsize+"px "+b.fontfamily;a.font=this.font;this.h=b.fontsize;this.w=a.measureText(this.text).width;return this},draw:function(){this.ctx.textAlign=this.textAlign;this.ctx.font=this.font;this.ctx.fillText(this.text,this.x,this.y)}};var O=function(a){this.font=a;this.allTexts=[]};O.prototype={getAll:function(){return this.allTexts},
addText:function(a){this.allTexts.push(new H(a,{fontfamily:this.font.family,fontweight:this.font.weight,fontsize:this.font.size,fontstyle:""}))},getAncestor:function(a,b){for(;(a=a.parentElement)&&a.localName!==b;);return a},getContainer:function(a,b){var c,f;if(c=this.getAncestor(a,"staff"))if(f=this.getAncestor(c,"measure"))return f=f.getAttribute("n")||"1",c=c.getAttribute("n")||"1",b[f][c];return null},setContext:function(a){this.ctx=a;return this},draw:function(a){var b=this,c,f=b.ctx;n.each(b.allTexts,
function(){this.y||(c=b.getContainer(this.meiElement,a),this.setY(c.getYForLine(3)-4+(+this.atts.vo*c.getSpacingBetweenLines()/2||0)));this.x||(c||(c=b.getContainer(this.meiElement,a)),this.setX(c.glyph_start_x+(+this.atts.ho*c.getSpacingBetweenLines()/2||0)));this.setContext(f).preProcess().draw()})}};var P=function(a){this.font=a};P.prototype={addToSystemStarts:function(a){var b,c,f;for(b=a.length;b--;)a[b]&&(c=a[b].getMeasure(0),f=c.getN(),1<f&&(c.getFirstDefinedStaff().setMeasure(f).font=this.font))}};
var Q=function(a,b){this.init(a,b)};Q.prototype={init:function(a,b){this.defaultFontSize=25;this.lineHeight=1.3;this.textsByLine=[[]];this.line_n=0;this.htmlToArray(a,{fontsize:this.defaultFontSize,fontweight:"",fontstyle:"",fontfamily:"Times"});this.x=b.x;this.y=b.y;this.w=b.w;this.currentCoords=b},getTextsByLine:function(){return this.textsByLine},htmlToArray:function(a,b){var c,f,g,d,h;h=a.childNodes;g=0;for(d=h.length;g<d;g++)if("#text"===h[g].nodeName){if(c=h[g].textContent.replace(/([\n|\r]+\s*)/g,
""))f=1===d?null:{type:"child",value:g},this.textsByLine[this.line_n].push(new H(a,b,!0,c,f))}else switch(h[g].localName){case E:break;case "lb":this.breakLine();break;case "title":c=B.Util.attsToObj(h[g]);f={halign:"center",fontsize:"sub"===c.type?35:50,fontweight:"Bold"};this.htmlToArray(h[g],n.extend({},b,f,c));this.breakLine();break;default:this.htmlToArray(h[g],n.extend({},b,B.Util.attsToObj(h[g])))}},breakLine:function(){this.line_n+=1;this.textsByLine[this.line_n]=[]},setContext:function(a){this.ctx=
a;return this},draw:function(){var a=this,b,c,f,g;currentCoords=a.currentCoords;n.each(a.textsByLine,function(){b=[];c=[];f=[];g=0;n.each(this,function(){this.setContext(a.ctx).preProcess();this.setTextAlign("left");switch(this.atts.halign){case "center":c.push(this);break;case "right":f.push(this);break;default:b.push(this)}});g=Math.max(a.drawCenterTexts(c,currentCoords),a.drawRightAlignedTexts(f,currentCoords),a.drawLeftAlignedTexts(b,currentCoords));currentCoords.y+=g*a.lineHeight})},drawCenterTexts:function(a,
b){var c=0,f;for(f=a.length;f--;)c+=a[f].w;return this.drawLeftAlignedTexts(a,{x:b.x+b.w/2-c/2,y:b.y,w:b.w},this.ctx)},drawRightAlignedTexts:function(a,b){var c=0,f=0,g,d;for(d=a.length;d--;)g=a[d],f+=g.w,g.setX(b.x+b.w-f),g.setY(b.y),g.draw(),c=Math.max(g.h,c);return c},drawLeftAlignedTexts:function(a,b){var c=0,f=0;n.each(a,function(a,d){d.setX(b.x+f);d.setY(b.y);d.draw();f+=d.w;c=Math.max(d.h,c)});return c}};var R=function(a){this.init(a)};R.prototype={defaults:{page_scale:1,page_height:350,page_width:800,
autoMeasureNumbers:!1,measureNumberFont:{family:"Times",size:14,weight:"Italic"},anchoredTextFont:{family:"Times",size:22,weight:""},staff:{fill_style:"#000000"},useMeiLib:!0,checkXmlIds:!0,xmlIdPrefix:"M2V",layers:[]},init:function(a){var b,c,f;if(!a)throw new v("NoConfig","No config passed to Viewer.");if(!a.xmlDoc)throw new v("MissingData","No XML document passed to Viewer.");b=G.initXmlDoc(a.xmlDoc);window.xx=b;c=b.getElementsByTagName("scoreDef")[0];if(!c)throw new v("BadMEIFile","No <scoreDef> found in config.data.");
this.cfg=n.extend(!0,{},this.defaults,G.getMEIPageConfig(c),a);this.cfg.checkXmlIds&&G.ascertainDescendantIds(b,this.cfg.xmlIdPrefix);this.cfg.useMeiLib?(f=new h.MeiDoc(b),f.initSectionView(),this.convertMEI(f.sectionview_score)):this.convertMEI(b);this.UI=new L;a=this.UI.createLayers(this.cfg);this.drawMEI(a[this.UI.vexLayerIndex].ctx);this.areaHelper=new N(this);this.areaHelper.setAreas(f,a);this.registerMouseHandlers(this.UI,a)},registerMouseHandlers:function(a,b){var c,f;for(c=b.length;c--;)f=
b[c],"highlighter"===f.type&&(f.clickHandler&&a.registerMouseClickHandler(f),("hover"===f.highlightMode||f.mouseEnterHandler&&f.mouseLeaveHandler)&&a.registerMouseMoveHandler(f));a.listenMouseClick();a.listenMouseMove()},convertMEI:function(a,b){this.converter=new B.Converter(this.cfg);this.anchoredTexts=new O(this.cfg.anchoredTextFont);var c=a.getElementsByTagName("pgHead")[0];c&&(this.pgHead=new Q(c,{x:this.converter.printSpace.left,y:200,w:this.converter.printSpace.width}));this.converter.process(a);
this.cfg.autoMeasureNumbers&&(this.measureNumbers=new P(this.cfg.measureNumberFont),this.measureNumbers.addToSystemStarts(this.converter.getSystems()));this.allVexMeasureStaffs=this.converter.getAllVexMeasureStaffs();for(var c=a.getElementsByTagName("anchoredText"),f=0,g=c.length;f<g;f++)this.anchoredTexts.addText(c[f])},drawMEI:function(a){this.converter.draw(a);this.pgHead&&this.pgHead.setContext(a).draw();this.anchoredTexts.setContext(a).draw(this.allVexMeasureStaffs)}};var I=function(a){};I.prototype=
{setElement:function(a){throw new v("AbstractAreaCollection","No override for setElement() provided.");},setContext:function(a){throw new v("AbstractAreaCollection","No override for setContext() provided.");},setScale:function(a){throw new v("AbstractAreaCollection","No override for setScale() provided.");},addAreas:function(a){throw new v("AbstractAreaCollection","No override for addAreas() provided.");},initHighlights:function(){throw new v("AbstractAreaCollection","No override for initHighlights() provided.");
},removeHighlight:function(){throw new v("AbstractAreaCollection","No override for removeHighlight() provided.");},onClick:function(a,b,c){throw new v("AbstractAreaCollection","No override for onClick() provided.");},onMouseMove:function(a,b,c){throw new v("AbstractAreaCollection","No override for onMouseMove() provided.");}};var S=function(a){this.init(a)};Vex.Inherit(S,I,{type:"highlighter",emptyArea:{ctx:{x:0,y:0,w:0,h:0}},init:function(a){this.ctx=a.ctx;this.content=a.content;this.highlightMode=
a.highlightMode;this.fillStyle=a.fillStyle||"rgba(100, 100, 0, 0.5)";this.clickHandler=a.clickHandler;this.mouseEnterHandler=a.mouseEnterHandler;this.mouseLeaveHandler=a.mouseLeaveHandler;this.currentHighlight=this.emptyArea;return this},setElement:function(a){this.element=a},setContext:function(a){this.ctx=a;this.ctx.fillStyle=this.fillStyle},setScale:function(a){this.scale=a},getAreas:function(){return this.areas},addAreas:function(a){this.areas?Array.prototype.push.apply(this.areas,a):this.areas=
a},initHighlights:function(){"static"===this.highlightMode?this.highlightAll():"hover"===this.highlightMode&&(this.highlightOnHover=!0)},removeHighlight:function(){this.ctx.clearRect(this.currentHighlight.ctx.x-1,this.currentHighlight.ctx.y-1,this.currentHighlight.ctx.w+2,this.currentHighlight.ctx.h+2)},highlightAll:function(){var a;for(a=this.areas.length;a--;)this.setHighlight(this.areas[a])},onClick:function(a,b,c){return(a=this.getAreaFromPoint(a))?this.clickHandler(a,b,c):!0},onMouseMove:function(a,
b,c){(a=this.getAreaFromPoint(a))?this.currentHighlight!==a&&(this.highlightOnHover&&(this.removeHighlight(),this.setHighlight(a)),this.mouseEnterHandler&&this.mouseEnterHandler(a,b,c)):this.currentHighlight!==this.emptyArea&&(this.highlightOnHover&&(this.removeHighlight(),this.setHighlight(this.emptyArea)),this.mouseLeaveHandler&&this.mouseLeaveHandler(null,b,c))},setHighlight:function(a){this.roundRect(this.ctx,a.ctx.x,a.ctx.y,a.ctx.w,a.ctx.h,5,!0,!1);this.currentHighlight=a},roundRect:function(a,
b,c,f,g,d,h,n){"undefined"==typeof n&&(n=!0);"undefined"===typeof d&&(d=5);a.beginPath();a.moveTo(b+d,c);a.lineTo(b+f-d,c);a.quadraticCurveTo(b+f,c,b+f,c+d);a.lineTo(b+f,c+g-d);a.quadraticCurveTo(b+f,c+g,b+f-d,c+g);a.lineTo(b+d,c+g);a.quadraticCurveTo(b,c+g,b,c+g-d);a.lineTo(b,c+d);a.quadraticCurveTo(b,c,b+d,c);a.closePath();n&&a.stroke();h&&a.fill()},getAreaFromPoint:function(a){var b,c;b=this.areas;for(c=b.length;c--;)if(this.isPointInRect(a,b[c].ctx))return b[c];return null},isPointInRect:function(a,
b){return!(a.x<b.x||a.x>b.x1||a.y<b.y||a.y>b.y1)}});Vex.Flow.Annotation.prototype.setMeiElement=function(a){this.meiElement=a;return this};Vex.Flow.Annotation.prototype.getMeiElement=function(){return this.meiElement};Vex.Flow.Articulation.prototype.setMeiElement=function(a){this.meiElement=a;return this};Vex.Flow.Articulation.prototype.getMeiElement=function(){return this.meiElement};s.Converter.prototype.dirToObj=function(a){var b=this,c=[];n.each(a,function(){c.push({text:n(this).text().trim(),
startid:b.getMandatoryAttr(this,"startid"),place:b.getMandatoryAttr(this,"place"),element:this})});return c};s.Directives.prototype.createVexFromInfos=function(a){var b,c,f,g;for(b=this.allModels.length;b--;)if(c=this.allModels[b],f=a[c.startid])g=(new w.Annotation(n(c.element).text().trim())).setFont(this.font.family,this.font.size,this.font.weight).setMeiElement(c.element),g.setWidth(0),"below"===c.atts.place?f.vexNote.addAnnotation(0,g.setVerticalJustification(this.BOTTOM)):f.vexNote.addAnnotation(0,
g);else throw new B.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");};s.Dynamics.prototype.createVexFromInfos=function(a){var b,c,f,g;for(b=this.allModels.length;b--;)if(c=this.allModels[b],f=a[c.startid])g=(new w.Annotation(n(c.element).text().trim())).setFont(this.font.family,this.font.size,this.font.weight).setMeiElement(c.element),"above"===c.atts.place?f.vexNote.addAnnotation(0,g):f.vexNote.addAnnotation(0,g.setVerticalJustification(this.BOTTOM));
else throw new B.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");};s.Converter.prototype.processSyllable=function(a){if(a=a.getElementsByTagName("syl")[0])return{text:n(a).text(),wordpos:a.getAttribute("wordpos"),element:a}};s.Converter.prototype.processSyllables=function(a,b,c){var f;if(f=this.processSyllable(b))b=this.createAnnot(f.text,this.cfg.lyricsFont).setMeiElement(f.element).setVerticalJustification(this.BOTTOM),a.addAnnotation(0,b),
f.wordpos&&this.hyphenation.addSyllable(b,f.wordpos,c)};s.Converter.prototype.addArticulation=function(a,b){var c=(new w.Articulation(B.tables.articulations[b.getAttribute("artic")])).setMeiElement(b),f=b.getAttribute("place");f&&c.setPosition(B.tables.positions[f]);a.addArticulation(0,c)};s.Fermatas.prototype.addFermataToNote=function(a,b,c){var f=new w.Articulation(B.tables.fermata[b]);f.setPosition(B.tables.positions[b]);a.addArticulation(c||0,f)};w.Articulation.prototype.draw=function(){var a=
Vex.Flow.Modifier;if(!this.context)throw new Vex.RERR("NoContext","Can't draw Articulation without a context.");if(!this.note||null===this.index)throw new Vex.RERR("NoAttachedNote","Can't draw Articulation without a note and index.");var b=this.note.getStemDirection(),c=this.note.getStave(),f=this.position===a.Position.ABOVE&&b===Vex.Flow.StaveNote.STEM_DOWN||this.position===a.Position.BELOW&&b===Vex.Flow.StaveNote.STEM_UP,g=this.note.getModifierStartXY(this.position,this.index),d=g.y,h=0,d=1,n=c.getSpacingBetweenLines(),
h="tabnotes"===this.note.getCategory(),q=this.note.getStem().getExtents(),k=q.topY,p=q.baseY;b===Vex.Flow.StaveNote.STEM_DOWN&&(k=q.baseY,p=q.topY);h&&(this.note.hasStem()?b===Vex.Flow.StaveNote.STEM_UP?p=c.getYForBottomText(this.text_line-2):b===Vex.Flow.StaveNote.STEM_DOWN&&(k=c.getYForTopText(this.text_line-1.5)):(k=c.getYForTopText(this.text_line-1),p=c.getYForBottomText(this.text_line-2)));b=this.note.getLineNumber(this.position===a.Position.ABOVE?!0:!1);!f&&this.note.beam&&(d+=.5);var h=d,q=
this.position===a.Position.ABOVE?1:-1,r=this.getNote().getDuration();f||"w"===r||"1"===r||(b+=3.5*q);f=b+q*h;1<=f&&5>=f&&0===f%1&&(d+=.5);this.position===a.Position.ABOVE?(h=this.articulation.shift_up,a=k-7-n*(this.text_line+d),d=this.articulation.between_lines?a:Math.min(c.getYForTopText(this.text_line)-3,a)):(h=this.articulation.shift_down-10,a=p+10+n*(this.text_line+d),d=this.articulation.between_lines?a:Math.max(c.getYForBottomText(this.text_line),a));c=g.x+this.articulation.shift_right;d+=h+
this.y_shift;Vex.Flow.renderGlyph(this.context,c,d,this.render_options.font_scale,this.articulation.code);this.x=c;this.y=d};w.TickContext.prototype.init=function(){this.currentTick=new Vex.Flow.Fraction(0,1);this.maxTicks=new Vex.Flow.Fraction(0,1);this.minTicks=null;this.width=0;this.padding=3;this.x=this.pixelsUsed=0;this.tickables=[];this.extraRightPx=this.extraLeftPx=this.notePx=0;this.align_center=!1;this.tContexts=[];this.ignore_ticks=!0;this.postFormatted=this.preFormatted=!1;this.context=
null};w.TickContext.prototype.getCenterAlignedTickables=function(){return this.tickables.filter(function(a){return a.isCenterAligned()})};w.Tickable.prototype.init=function(){this.intrinsicTicks=0;this.tickMultiplier=new Vex.Flow.Fraction(1,1);this.ticks=new Vex.Flow.Fraction(0,1);this.x_shift=this.width=0;this.modifierContext=this.tickContext=this.voice=null;this.modifiers=[];this.postFormatted=this.preFormatted=!1;this.tuplet=null;this.ignore_ticks=this.align_center=!1;this.context=null};w.Tickable.prototype.isCenterAligned=
function(){return this.align_center};w.Tickable.prototype.setCenterAlignment=function(a){this.align_center=a;return this};w.Tickable.prototype.setDuration=function(a){a=Vex.Flow.RESOLUTION/a.denominator*a.numerator;this.ticks=this.tickMultiplier.clone().multiply(a);this.intrinsicTicks=this.ticks.value()};w.Note.prototype.init=function(a){w.Note.superclass.init.call(this);if(!a)throw new Vex.RuntimeError("BadArguments","Note must have valid initialization data to identify duration and type.");var b=
Vex.Flow.parseNoteData(a);if(!b)throw new Vex.RuntimeError("BadArguments","Invalid note initialization object: "+JSON.stringify(a));this.duration=b.duration;this.dots=b.dots;this.noteType=b.type;a.duration_override?this.setDuration(a.duration_override):this.setIntrinsicTicks(b.ticks);this.modifiers=[];this.glyph=Vex.Flow.durationToGlyph(this.duration,this.noteType);if(this.positions&&("object"!=typeof this.positions||!this.positions.length))throw new Vex.RuntimeError("BadArguments","Note keys must be array type.");
this.modifierContext=this.tickContext=this.playNote=null;this.ignore_ticks=!1;this.right_modPx=this.left_modPx=this.x_shift=this.extraRightPx=this.extraLeftPx=this.width=0;this.voice=null;this.preFormatted=!1;this.ys=[];a.align_center&&this.setCenterAlignment(a.align_center);this.stave=this.context=null;this.render_options={annotation_spacing:5,stave_padding:12}};w.Formatter.prototype.preFormat=function(a,b,c,f){var g=this.tContexts,d=g.list,h=g.map;c&&f&&c.forEach(function(a){a.setStave(f);a.preFormat()});
this.pixelsPerTick=a?a/(this.totalTicks.value()*g.resolutionMultiplier):a=0;var n=0,q=0,k=0,p=k=0,r=null,s=a;this.minTotalWidth=0;var w,v;for(c=0;c<d.length;++c){w=d[c];v=h[w];b&&v.setContext(b);v.preFormat();var B=v.getMetrics(),y=v.getWidth();this.minTotalWidth+=y;var C=0,A=y,k=Math.min((w-k)*this.pixelsPerTick,A),x=n+k;null!=r&&(C=n+p-r.extraLeftPx);x=v.shouldIgnoreTicks()?C+v.getWidth():Math.max(x,C);v.shouldIgnoreTicks()&&a&&(a-=v.getWidth(),this.pixelsPerTick=a/(this.totalTicks.value()*g.resolutionMultiplier));
k=B.extraLeftPx;null!=r&&(q=x-n-(p-r.extraLeftPx));0<c&&0<q&&(k=q>=k?0:k-q);x+=k;v.setX(x);v.setPixelsUsed(A);r=B;p=y;k=w;n=x}this.hasMinTotalWidth=!0;if(0<a)for(b=(s-(n+p))/(this.totalTicks.value()*g.resolutionMultiplier),c=k=g=0;c<d.length;++c)w=d[c],v=h[w],k=(w-k)*b,g+=k,v.setX(v.getX()+g),k=w,v.getCenterAlignedTickables().forEach(function(b){b.x_shift=(a-b.getWidth())/2})};window.MSV={Viewer:R,Logger:K,AbstractAreaCollection:I,DefaultAreaCollection:S,Util:s.Util}})(jQuery,Vex.Flow);
