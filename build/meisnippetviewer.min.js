(function(p,t,C){var q={},A=q,g={RuntimeError:function(a,c){this.errorcode=a;this.message=c}};g.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""};g.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)};g.EventEnumerator=function(a,c){this.init(a,c)};g.EventEnumerator.prototype.init=function(a,c){if(!a)throw new g.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined");
this.node=a;this.next_evnt=null;this.EoI=!0;this.children=p(this.node).children();this.i_next=-1;this.proportion=c||{num:1,numbase:1};this.outputProportion=c||{num:1,numbase:1};this.read_ahead()};g.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var a=this.next_evnt;this.read_ahead();return a}throw new g.RuntimeError("MeiLib.LayerEnum:E01","End of Input.");};g.EventEnumerator.prototype.read_ahead=function(){this.beam_enumerator?this.beam_enumerator.EoI?(this.EoI=!0,this.beam_enumerator=
null,this.step_ahead()):(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1):this.step_ahead()};g.EventEnumerator.prototype.step_ahead=function(){++this.i_next;if(this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var a=p(this.next_evnt).prop("localName");"note"===a||"rest"===a||"mRest"===a||"chord"===a?this.EoI=!1:"beam"===a?(this.beam_enumerator=new g.EventEnumerator(this.next_evnt),this.beam_enumerator.EoI?this.EoI=!0:(this.next_evnt=this.beam_enumerator.nextEvent(),
this.EoI=!1)):"tuplet"===a&&(a={num:this.proportion.num*+this.next_evnt.getAttribute("num")||3,numbase:this.proportion.numbase*+this.next_evnt.getAttribute("numbase")||2},this.beam_enumerator=new g.EventEnumerator(this.next_evnt,a),this.beam_enumerator.EoI?(this.outputProportion=this.proportion,this.EoI=!0):(this.outputProportion=this.beam_enumerator.outputProportion,this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1))}else this.EoI=!0};g.durationOf=function(a,c,b){var e=b?function(d,a){return d.hasAttribute("grace")||
"clef"===a}:function(d,a){return"clef"===a},f=function(d){return"note"===d||"rest"===d||"space"===d},d=function(d,a){var h=p(d).attr("dur");if(!h)throw new g.RuntimeError("MeiLib.durationOf:E04","@dur of <b>note</b>, <b>rest</b> or <b>space</b> must be specified.");console.log(g.dotsMult(d)*g.dur2beats(Number(h),a));return g.dotsMult(d)*g.dur2beats(Number(h),a)},h=function(d,a,h){h||(h="1");var b=p(d).attr("dur"),c=g.dotsMult(d);if(b)return c*g.dur2beats(Number(b),a);p(d).find("note").each(function(){lyr_n=
p(this).attr("layer");if(!lyr_n||lyr_n===h){var a=p(this).attr("dur"),e=g.dotsMult(d);if(!b&&a)b=a,c=e;else if(b&&b!=a)throw new g.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.");}});if(b)return c*g.dur2beats(Number(b),a);throw new g.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.");},u=function(a,b){var c=0;p(a).children().each(function(){var a;a=this.localName;if(e(this,a))a=0;else if(f(a))a=
d(this,b);else if("chord"===a)a=h(this,b);else if("beam"===a)a=u(this,b);else if("tuplet"===a)a=m(this,b);else throw new g.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+a+"'");c+=a});return c},m=function(d,a){var h=+d.getAttribute("num")||3,b=+d.getAttribute("numbase")||2;return u(d,{count:a.count,unit:a.unit*b/h})};b=p(a).prop("localName");if(e(a,b))return 0;if(f(b))return d(a,c);if("mRest"===b)return c.count;if("chord"===b)return h(a,c);if("beam"===b)return u(a,c);if("tuplet"===
b)return m(a,c);throw new g.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+b+"'");};g.tstamp2id=function(a,c,b){a=Number(a);for(var e=0,f=new g.EventEnumerator(c),d,h,u,m;!f.EoI&&(h===C||0<h);)u=d,m=h,d=f.nextEvent(),h=a-(e+1),d.hasAttribute("grace")||"clef"===d.localName||(e+=g.durationOf(d,b,!0)*f.outputProportion.numbase/f.outputProportion.num);if(h===C)return C;c=0>h?u&&m<Math.abs(h)?u:d:d;var k=function(d){if(d.hasAttribute("grace")||"clef"===d.localName){var a=f.nextEvent();
return k(a)||d}return d};c=k(c);b=p(c).attr("xml:id");b||(b=g.createPseudoUUID(),p(c).attr("xml:id",b));return b};g.XMLID=function(a){var c=p(a).attr("xml:id");c||(c=g.createPseudoUUID(),p(a).attr("xml:id",c));return c};g.id2tstamp=function(a,c){for(var b,e=0;e<c.length;++e){c[e].meter&&(b=c[e].meter);if(0===e&&!b)throw new g.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified");var f=g.sumUpUntil(a,c[e].layer,b);if(f.found)return e.toString()+"m+"+(f.beats+1).toString()}throw new g.RuntimeError("MeiLib.id2tstamp:E002",
'No event with xml:id="'+a+'" was found in the given MEI context.');};g.dur2beats=function(a,c){return c.unit/a};g.beats2dur=function(a,c){return c.unit/a};g.dotsMult=function(a){a=p(a).attr("dots");a=Number(a||"0");for(var c=1;0<a;--a)c+=1/Math.pow(2,a);return c};g.sumUpUntil=function(a,c,b){var e=function(c){var d,h,u;h=p(c);var m=h.prop("localName");if(c.hasAttribute("grace")||"clef"===m)return{beats:0,found:h.attr("xml:id")===a};if("note"===m||"rest"===m){if(h.attr("xml:id")===a)return{beats:0,
found:!0};d=Number(h.attr("dur"));if(!d)throw new g.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).");h.attr("dots");d=g.dotsMult(h)*g.dur2beats(d,b);return{beats:d,found:!1}}if("mRest"===m)return h.attr("xml:id")===a?{beats:0,found:!0}:{beats:b.count,found:!1};if("layer"===m||"beam"===m||"tuplet"===m){d=0;h=h.children();u=!1;for(c=0;c<h.length&&!u;++c)u=e(h[c]),d+=u.beats,u=u.found;return{beats:d,found:u}}if("chord"===m){h.attr("dur");if(h.attr("xml:id")===
a)return{beats:0,found:!0};if(c=h.attr("dur"))return h.find("[xml\\:id='"+a+"']").length?{beats:0,found:!0}:{beats:g.dur2beats(c,b),found:u};h=h.children();u=!1;for(c=0;c<h.length&&!u;++c)u=e(h[c]),d=u.beats,u=u.found;return{beats:d,found:u}}return{beats:0,found:!1}};return e(c)};g.SliceMEI=function(a,c){var b=function(d,a){p.each(d,function(d,h){a.noClef&&p(h).attr("clef.visible","false");a.noKey&&p(h).attr("key.sig.show","false");a.noMeter&&p(h).attr("meter.rend","false")})},e=c.staves;if(e)for(var f=
"",d="",h="",u=0;u<e.length;u++)f+=h+'[n="'+e[u]+'"]',d+=h+'[staff="'+e[u]+'"]',0===u&&(h=", ");h=a.cloneNode(!0);e&&p(h).find("staffDef").remove(":not("+f+")");if(c.noClef||c.noKey||c.noMeter)u=p(h).find("staffDef"),f=p(h).find("scoreDef"),b(f,c),b(u,c);c.noConnectors&&p(h).find("staffGrp").removeAttr("symbol");var m=p(h).find("section")[0],k=!1;p(m.childNodes).each(function(){k||("measure"===this.localName&&Number(p(this).attr("n"))===c.start_n?k=!0:m.removeChild(this));if(k){if(e){p(this).find("[staff]").remove(":not("+
d+")");var a=p(this).find("staff");p(a).each(function(){-1===p.inArray(Number(p(this).attr("n")),e)&&this.parentNode.removeChild(this)})}"measure"===this.localName&&Number(p(this).attr("n"))===c.end_n&&(k=!1)}});return h};g.Alt=function(a,c,b,e){this.elem=a;this.xmlID=c;this.altitems=[];this.parentID=b;this.tagname=e};g.Alt.prototype.getDefaultItem=function(){var a=function(a,b,e){var f;for(alt in a){if(a[alt].tagname===b)return a[alt];f||a[alt].tagname!==e||(f=a[alt])}return f};if("choice"===this.tagname)return a(this.altitems,
"corr","sic");if("app"===this.tagname)return a(this.altitems,"lem")};g.Variant=function(a,c,b,e,f,d){this.elem=a;this.xmlID=c;this.tagname=b;this.source=e;this.resp=f;this.n=d};g.MeiDoc=function(a){a&&this.init(a)};g.MeiDoc.prototype.init=function(a){this.xmlDoc=a;this.rich_head=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","meiHead")[0];this.rich_music=a.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","music")[0];this.rich_score=p(this.rich_music).find("score")[0];
this.parseSourceList();this.parseEditorList();this.parseALTs();this.initAltgroups();this.initSectionView()};g.MeiDoc.prototype.getRichScore=function(){return this.rich_score};g.MeiDoc.prototype.getPlainScore=function(){return this.plain_score};g.MeiDoc.prototype.getALTs=function(){return this.ALTs};g.MeiDoc.prototype.getSourceList=function(){return this.sourceList};g.MeiDoc.prototype.getEditorList=function(){return this.editorList};g.MeiDoc.prototype.parseSourceList=function(){return this.sources=
p(this.rich_head).find("sourceDesc").children()};g.MeiDoc.prototype.parseEditorList=function(){return this.editors=p(this.rich_head).find("titleStmt").children("editor")};g.MeiDoc.prototype.parseALTs=function(){var a,c;this.ALTs={};var b=p(this.rich_score).find("app, choice");for(a=0;a<b.length;a++){var e=b[a];c=e.parentNode;var f=p(e).find("rdg, lem, sic, corr"),d=new g.Alt(e,g.XMLID(e),g.XMLID(c),e.localName);d.altitems={};for(c=0;c<f.length;c++){var h=f[c],u=p(h).attr("source"),m=p(h).attr("resp"),
k=p(h).attr("n"),l=p(h).prop("localName"),n=g.XMLID(h);d.altitems[n]=new g.Variant(h,n,l,u,m,k)}this.ALTs[g.XMLID(e)]=d}};g.MeiDoc.prototype.initAltgroups=function(){var a,c;annots=p(this.rich_score).find('annot[type="appGrp"], annot[type="choiceGrp"]');this.altgroups={};for(a=0;a<annots.length;a++){altgroup=[];token_list=p(annots[a]).attr("plist").split(" ");for(c=0;c<token_list.length;c++)altgroup.push(token_list[c].replace("#",""));for(c in altgroup)this.altgroups[altgroup[c]]=altgroup}};g.MeiDoc.prototype.selectDefaultAlternative=
function(a){var c={};if("choice"===a.localName){var b=p(a).find("corr")[0];b?(c.alt_item_xml_id=g.XMLID(b),c.alt_item=b):(a=p(a).find("sic")[0])?(c.alt_item_xml_id=g.XMLID(a),c.alt_item=a):c={}}else(a=p(a).find("lem")[0])?(c.alt_item_xml_id=g.XMLID(a),c.alt_item=a):c={};return c};g.MeiDoc.prototype.initSectionView=function(a){a=a||{};this.sectionview_score=this.rich_score.cloneNode(!0);this.sectionplane={};var c=p(this.sectionview_score).find("app, choice"),b,e=this.sectionview_score,f=this.sectionplane,
d=this.ALTs,h=this.xmlDoc,u=this;p(c).each(function(c,k){var l=g.XMLID(k),n=a[l];if(n){b=n.xmlID;var r=p(e).find(n.tagname+'[xml\\:id="'+b+'"]')[0];if(!r)throw new g.RuntimeError("MeiLib.MeiDoc.prototype.initSectionView():E01","Cannot find <lem>, <rdg>, <sic>, or <corr> with @xml:id '"+b+"'.");}else if(n=u.ALTs[l].getDefaultItem())b=n.xmlID,r=n.elem;var n=k.parentNode,z=h.createProcessingInstruction("MEI2VF",'rdgStart="'+l+'"');n.insertBefore(z,k);if(r)for(r=r.childNodes,c=0;c<r.length;++c)n.insertBefore(r.item(c).cloneNode(!0),
k);r=h.createProcessingInstruction("MEI2VF",'rdgEnd="'+l+'"');n.insertBefore(r,k);n.removeChild(k);f[l]=[];d[l].altitems[b]&&f[l].push(d[l].altitems[b])});return this.sectionview_score};g.MeiDoc.prototype.updateSectionView=function(a){var c=function(d,a){var b=0,c,e;for(e in d){var f=d[e],r=0,z=void 0;for(z in f)f[z]!==C&&f[z]===a[z]&&r++;console.log("vars_match: "+r);M=r;b<M&&(b=M,c=d[e])}return c};for(altID in a){var b=this.ALTs,e=[];"string"===typeof a[altID]&&(a[altID]=[a[altID]]);if(0<a[altID].length)p(a[altID]).each(function(){e.push(b[altID].altitems[this])});
else{var f=this.ALTs[altID].getDefaultItem();f&&e.push(f)}if(altgroup=this.altgroups[altID])for(f=0;f<altgroup.length;f++){altID__=altgroup[f];var d=[];p(e).each(function(){d.push(c(b[altID__].altitems,this))});this.replaceAltInstance({appXmlID:altID__,replaceWith:d})}else this.replaceAltInstance({appXmlID:altID,replaceWith:e})}};g.MeiDoc.prototype.replaceAltInstance=function(a){var c=function(d,a){var h;for(h=0;h<a.length;++h)d.push(a.item(h));return d},b=a.appXmlID,e=p(this.sectionview_score).find("[xml\\:id="+
this.ALTs[b].parentID+"]")[0];if("undefined"!==typeof e){var f=e.childNodes,d=a.replaceWith,h=[],u=this.rich_score;if(d){var m;for(m=0;m<d.length;++m)var k=d[m],l=k.xmlID,k=p(u).find(k.tagname+'[xml\\:id="'+l+'"]')[0],h=c(h,k.childNodes)}console.log(h);var n=function(d,a){d=d.replace("'",'"');a=a.replace("'",'"');return d===a},r=!1,z=!1,g=null;p(f).each(function(){7===this.nodeType?"MEI2VF"===this.nodeName&&n(this.nodeValue,'rdgStart="'+b+'"')?z=r=!0:"MEI2VF"===this.nodeName&&n(this.nodeValue,'rdgEnd="'+
b+'"')&&(r=!1,g=this):r&&e.removeChild(this)});if(!z)throw"processing instruction not found";if(r)throw"Unmatched <?MEI2VF rdgStart?>";var q;q=g?function(d){e.insertBefore(d,g)}:function(d){e.appendChild(d)};p.each(h,function(){q(this.cloneNode(!0))});this.sectionplane[b]=a.replaceWith;return this.sectionview_score}};g.MeiDoc.prototype.getSectionViewSlice=function(a){return g.SliceMEI(this.sectionview_score,a)};g.MeiDoc.prototype.getRichSlice=function(a){var c=new g.MeiDoc;c.xmlDoc=this.xmlDoc;c.rich_head=
this.rich_head.cloneNode(!0);c.rich_music=this.rich_music.cloneNode(!0);c.rich_score=g.SliceMEI(this.rich_score,a);c.sourceList=this.sourceList;c.editorList=this.editorList;c.ALTs=this.ALTs;c.altgroups=this.altgroups;return c};q=function(a,c,b,e,f){a.Converter=function(d){d&&this.initConfig(d);return this};a.Converter.prototype={BOTTOM:b.Annotation.VerticalJustify.BOTTOM,defaults:{page_width:800,page_margin_top:60,page_margin_left:20,page_margin_right:20,systemSpacing:90,staveSpacing:60,autoStaveConnectorLine:!0,
labelMode:null,maxHyphenDistance:75,lyricsFont:{family:"Times",size:13,spacing:1.3},annotFont:{family:"Times",size:15,weight:"Italic"},dynamFont:{family:"Times",size:18,weight:"bold italic"},tempoFont:{family:"Times",size:17,weight:"bold"},staff:{vertical_bar_width:20,top_text_position:1.5,bottom_text_position:7.5}},initConfig:function(d){this.cfg=e.extend(!0,{},this.defaults,d);this.systemInfo=new a.SystemInfo;this.printSpace={top:this.cfg.page_margin_top-40,left:this.cfg.page_margin_left,right:this.cfg.page_width-
this.cfg.page_margin_right,width:Math.floor(this.cfg.page_width-this.cfg.page_margin_right-this.cfg.page_margin_left)-1};return this},reset:function(){this.systemInfo.init(this.cfg,this.printSpace);this.unresolvedTStamp2=[];this.systems=[];this.allVexMeasureStaffs=[];this.allBeams=[];this.allTuplets=[];this.dynamics=new a.Dynamics(this.systemInfo,this.cfg.dynamFont);this.directives=new a.Directives(this.systemInfo,this.cfg.annotFont);this.fermatas=new a.Fermatas(this.systemInfo);this.ties=new a.Ties(this.systemInfo,
this.unresolvedTStamp2);this.slurs=new a.Ties(this.systemInfo,this.unresolvedTStamp2);this.hairpins=new a.Hairpins(this.systemInfo,this.unresolvedTStamp2);this.hyphenation=new a.Hyphenation(this.cfg.lyricsFont,this.printSpace.right,this.cfg.maxHyphenDistance);this.verses=new a.Verses(this.cfg.lyricsFont,this.printSpace.right,this.cfg.maxHyphenDistance);this.notes_by_id={};this.currentSystem_n=0;this.pendingSystemBreak=!1;this.pendingSectionBreak=!0;this.currentVoltaType=null;return this},process:function(d){this.reset();
this.systemInfo.processScoreDef(e(d).find("scoreDef")[0]);this.processSections(d);this.directives.createVexFromInfos(this.notes_by_id);this.dynamics.createVexFromInfos(this.notes_by_id);this.fermatas.createVexFromInfos(this.notes_by_id);this.ties.createVexFromInfos(this.notes_by_id);this.slurs.createVexFromInfos(this.notes_by_id);this.hairpins.createVexFromInfos(this.notes_by_id);return this},draw:function(d){this.drawSystems(d);this.drawVexBeams(this.allBeams,d);this.drawVexTuplets(this.allTuplets,
d);this.ties.setContext(d).draw();this.slurs.setContext(d).draw();this.hairpins.setContext(d).draw();this.verses.drawHyphens(d);return this},getStaffArea:function(){var d,a;d=this.systemInfo.getCurrentLowestY();var b=this.getAllVexMeasureStaffs(),c,e,f,n;a=b.length;for(f=0;a--;)if(b[a]){e=0;for(c=b[a].length;c--;)(n=b[a][c])&&(e=Math.max(e,n.getNoteStartX()));for(c=b[a].length;c--;)(n=b[a][c])&&(f=Math.max(f,e+n.getWidth()))}return{width:f,height:d}},getAllVexMeasureStaffs:function(){return this.allVexMeasureStaffs},
getSystems:function(){return this.systems},getNotes:function(){return this.notes_by_id},createNewSystem:function(){var d;a.L("Converter.createNewSystem()","{enter}");this.pendingSystemBreak=!1;this.currentSystem_n+=1;d={x:this.printSpace.left,y:1===this.currentSystem_n?this.printSpace.top:this.systemInfo.getCurrentLowestY()+this.cfg.systemSpacing,w:this.printSpace.width};d=new a.System({leftMar:this.systemInfo.getLeftMar(),coords:d,staffYs:this.systemInfo.getYs(d.y),labels:this.getStaffLabels()});
this.pendingSectionBreak?(this.pendingSectionBreak=!1,this.systemInfo.forceSectionStartInfos()):this.systemInfo.forceStaveStartInfos();this.hyphenation.addLineBreaks(this.systemInfo.getAllStaffInfos(),{system:d});this.verses.addLineBreaks(this.systemInfo.getAllStaffInfos(),{system:d});return this.systems[this.currentSystem_n]=d},processSections:function(d){var a=this;e(d).find("section").each(function(){a.processSection(this)})},processSection:function(d){var a,b=e(d).children();this.verses.initHyphenations(e(d).find("syl"));
d=0;for(a=b.length;d<a;d+=1)this.processSectionChild(b[d])},processEnding:function(d){var a,b,c=e(d).children();a=0;for(b=c.length;a<b;a+=1)this.currentVoltaType={},0===a&&(this.currentVoltaType.start=e(d).attr("n")),a===b-1&&(this.currentVoltaType.end=!0),this.processSectionChild(c[a]);this.currentVoltaType=null},processSectionChild:function(d){switch(d.localName){case "measure":this.processMeasure(d);break;case "scoreDef":this.systemInfo.processScoreDef(d);break;case "staffDef":this.systemInfo.processStaffDef(d);
break;case "sb":this.setPendingSystemBreak(d);break;case "ending":this.processEnding(d);break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+d.localName+"> is not supported in <section>");}},setPendingSystemBreak:function(){this.pendingSystemBreak=!0},processMeasure:function(d){var b=this,c,m,f,l,n;b.pendingSectionBreak||b.pendingSystemBreak?(m=b.systems.length,n=b.createNewSystem(),m=!0):(m=b.systems.length-1,n=b.systems[m],m=!1);a.L("Converter.processMeasure()","{enter}");
c=+d.getAttribute("n");f=d.getAttribute("left");l=d.getAttribute("right");var r=[],z=[],g=[],p=[],q=[],y=[],w=[],v=[];e(d).find("*").each(function(){switch(this.localName){case "staff":r.push(this);break;case "dir":z.push(this);break;case "tie":p.push(this);break;case "slur":g.push(this);break;case "hairpin":q.push(this);break;case "tempo":y.push(this);break;case "dynam":w.push(this);break;case "fermata":v.push(this)}});var x=b.initializeMeasureStaffs(n,r,f,l,m);b.allVexMeasureStaffs[c]=x;var D=new a.StaveVoices;
e.each(r,function(){b.processStaffEvents(x,this,c,D)});b.directives.createInfos(z,d);b.dynamics.createInfos(w,d);b.fermatas.createInfos(v,d);b.ties.createInfos(p,d,b.systemInfo);b.slurs.createInfos(g,d,b.systemInfo);b.hairpins.createInfos(q,d,b.systemInfo);n.addMeasure(new a.Measure({element:d,n:c,staffs:x,voices:D,verses:b.verses,startConnectorCfg:m?{labelMode:b.cfg.labelMode,models:b.systemInfo.startConnectorInfos,staffs:x,system_n:b.currentSystem_n}:null,inlineConnectorCfg:{models:b.systemInfo.inlineConnectorInfos,
staffs:x,barline_l:f,barline_r:l},tempoElements:y,tempoFont:b.cfg.tempoFont}))},initializeMeasureStaffs:function(d,h,c,m,f){var l=this,n,r,z,g=!0,p={},q=0,y={},w=0,v;z=[];f||(v=d.getLastMeasure().getStaffs());e.each(h,function(){r=+e(this).attr("n");if(!r)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".');n=l.createVexStaff(d.getStaffYs()[r]);z[r]=n;n.setBegBarType(c?a.tables.barlines[c]:b.Barline.type.NONE);m&&n.setEndBarType(a.tables.barlines[m]);g&&
l.currentVoltaType&&l.addStaffVolta(n);v&&v[r]?(l.addStaffEndClef(v[r],r),q=p[r]=0):(l.addStaffClef(n,r),p[r]=n.getModifierXShift(),q=Math.max(q,p[r]));g=!1});e.each(z,function(d,a){a&&(p[d]!==q?l.addStaffKeySig(a,d,q-p[d]+10):l.addStaffKeySig(a,d),y[d]=a.getModifierXShift(),w=Math.max(w,y[d]))});e.each(z,function(d,a){a&&(y[d]!==w?l.addStaffTimeSig(a,d,w-y[d]+15):l.addStaffTimeSig(a,d))});return z},createVexStaff:function(d){var a;a=new b.Stave;a.init(0,d,1E3,this.cfg.staff);a.options.bottom_text_position=
this.cfg.staff.bottom_text_position;return a},addStaffClef:function(d,a){var b;b=this.systemInfo.getStaffInfo(a);b.showClefCheck()&&d.addClef(b.getClef())},addStaffEndClef:function(d,a){var b;b=this.systemInfo.getStaffInfo(a);b.showClefCheck()&&d.addEndClef(b.getClef()+"_small")},addStaffKeySig:function(d,a,b){a=this.systemInfo.getStaffInfo(a);a.showKeysigCheck()&&d.addModifier(new Vex.Flow.KeySignature(a.getKeySpec(),b))},addStaffTimeSig:function(d,a,b){a=this.systemInfo.getStaffInfo(a);a.showTimesigCheck()&&
(d.hasTimeSig=!0,d.addTimeSignature(a.getTimeSig(),b))},addStaffVolta:function(d){var a=this.currentVoltaType;a.start?d.setVoltaType(Vex.Flow.Volta.type.BEGIN,a.start+".",30):a.end?d.setVoltaType(Vex.Flow.Volta.type.END,"",30):a.start||a.end||d.setVoltaType(Vex.Flow.Volta.type.MID,"",30)},getStaffLabels:function(){var d,a,b,c;d={};if(!this.cfg.labelMode)return d;c="full"===this.cfg.labelMode&&1===this.currentSystem_n?"label":"labelAbbr";b=this.systemInfo.getAllStaffInfos();for(a=b.length;a--;)b[a]&&
(d[a]=b[a][c]);return d},processStaffEvents:function(d,a,c,m){var f=this,l,n,r,g,p,q,t=[],y=b.GraceNote,w;n=+e(a).attr("n");l=d[n];w=f.systemInfo.getStaffInfo(n);var v=function(d){if(d instanceof y)return t.push(d),null;if(e.isArray(d)){for(var a=[],b=0,h=d.length;b<h;b++){var c=v(d[b]);null!==c&&a.push(c)}return a}0<t.length&&(d.addModifier(0,(new Vex.Flow.GraceNoteGroup(t,!1)).beamNotes()),t=[]);return d};d=function(){var d=f.processNoteLikeElement(this,l,n,q,w);return v(d.vexNote||d)};a=e(a).find("layer");
console.log(g);r=0;for(g=a.length;r<g;r++)q=1<g?0===r?b.StaveNote.STEM_UP:r===g-1?b.StaveNote.STEM_DOWN:null:null,f.resolveUnresolvedTimestamps(a[r],n,c,w.meter),w.checkInitialClef(),p=e(a[r]).children().map(d).get(),m.addVoice(f.createVexVoice(p,w.meter),n);w.removeInitialClefCopy()},createVexVoice:function(d,h){var c;if(!e.isArray(d))throw new a.RUNTIME_ERROR("BadArguments","me.createVexVoice() voice_contents argument must be an array.");c=new b.Voice({num_beats:h.count,beat_value:h.unit,resolution:b.RESOLUTION});
c.setStrict(!1);c.addTickables(d);return c},resolveUnresolvedTimestamps:function(d,b,c,f){var k=this,l;if(isNaN(c))throw new a.RUNTIME_ERROR("MEI2VF.RERR.extract_events","<measure> must have @n specified");l=c+":"+(b||1)+":"+(e(d).attr("n")||"1");k.unresolvedTStamp2[l]&&(e(k.unresolvedTStamp2[l]).each(function(a){this.setContext({layer:d,meter:f});k.unresolvedTStamp2[l][a]=null}),k.unresolvedTStamp2[l]=null)},processNoteLikeElement:function(d,b,c,e,f){switch(d.localName){case "rest":return this.processRest(d,
b,c);case "mRest":return this.processmRest(d,b,c,e,f);case "space":return this.processSpace(d,b);case "note":return this.processNote(d,b,c,e);case "beam":return this.processBeam(d,b,c,e,f);case "tuplet":return this.processTuplet(d,b,c,e,f);case "chord":return this.processChord(d,b,c,e,f);case "clef":return this.processClef(d,b,c,e,f);case "anchoredText":break;default:throw new a.RUNTIME_ERROR("BadArguments",'Rendering of element "'+d.localName+'" is not supported.');}},processNote:function(d,h,u,
f){var k=this,l,n,r,g,p,q,t,y,w,v,x,D,B;x=a.Util.attsToObj(d);l=+x.dots;n=x.accid;r=x.ho;g=x.pname;p=x.oct;t=x.tie;y=x.slur;w=+x.staff||u;q=c.XMLID(d);try{D={keys:[k.processAttsPitch(d)],clef:k.systemInfo.getClef(u),duration:k.processAttsDuration(d)};k.setStemDir(d,D,f);x.grace?(B=new b.GraceNote(D),B.slash="1slash"===x["stem.mod"]):B=new b.StaveNote(D);if(w===u)B.setStave(h);else{var s=k.allVexMeasureStaffs[k.allVexMeasureStaffs.length-1][w];if(s)B.setStave(s);else throw new a.RUNTIME_ERROR("Error",
'Note has staff attribute "'+w+'", but the staff does not exist.');}k.processSyllables(B,d,u);try{for(v=0;v<l;v+=1)B.addDotToAll()}catch(A){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the dots of <note>: "+a.Util.attsToString(d));}n&&k.processAttrAccid(n,B,0);r&&k.processAttrHo(r,B,h);e.each(e(d).find("artic"),function(){k.addArticulation(B,this)});x.fermata&&k.fermatas.addFermataToNote(B,x.fermata);e(d).children().each(function(){e(this).remove()});if(!g)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments",
"mei:note must have pname attribute");if(!p)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have oct attribute");t&&k.processAttrTie(t,q,g,p);y&&k.processAttrSlur(y,q);k.notes_by_id[q]={meiNote:d,vexNote:B,system:k.currentSystem_n,layerDir:f};return{vexNote:B,id:q}}catch(C){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <note>: "+a.Util.attsToString(d)+"\nORIGINAL ERROR MESSAGE: "+C.toString());}},processChord:function(d,h,u,f,k){var l=this,n,r,g,p=
[],q,t=[],y,w,v,x,s;g=e(d).children();s=a.Util.attsToObj(d);y=s.dur;w=c.XMLID(d);k=!!e(d).attr("dots");try{if(y)q=l.translateDuration(+y);else{n=0;for(r=g.length;n<r;n+=1)t.push(+g[n].getAttribute("dur"));q=l.translateDuration(Math.max.apply(Math,t))}n=0;for(r=g.length;n<r;n+=1)p.push(l.processAttsPitch(g[n])),"1"===g[n].getAttribute("dots")&&(k=!0);k&&(q+="d");x={keys:p,clef:l.systemInfo.getClef(u),duration:q};l.setStemDir(d,x,f);s.grace?(v=new b.GraceNote(x),v.slash="1slash"===s["stem.mod"]):v=
new b.StaveNote(x);v.setStave(h);var B=[];g.each(function(a){l.processNoteInChord(a,this,d,v,f);B.push(a)});k&&v.addDotToAll();s.ho&&l.processAttrHo(s.ho,v,h);s.fermata&&l.fermatas.addFermataToNote(v,s.fermata);l.notes_by_id[w]={meiNote:d,vexNote:v,index:B,system:l.currentSystem_n,layerDir:f};return{vexNote:v,id:w}}catch(A){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <chord>:"+A.toString());}},processNoteInChord:function(d,b,e,f,k){var l;l=a.Util.attsToObj(b);b=c.XMLID(b);
l.tie&&this.processAttrTie(l.tie,b,l.pname,l.oct);l.slur&&this.processAttrSlur(l.slur,b);this.notes_by_id[b]={meiNote:e,vexNote:f,index:[d],system:this.currentSystem_n,layerDir:k};l.accid&&this.processAttrAccid(l.accid,f,d);l.fermata&&this.fermatas.addFermataToNote(f,l.fermata,d)},processRest:function(d,h,e){var f,k,l,n;try{n=a.Util.attsToObj(d);f=this.processAttsDuration(d,!0);var r=n.ploc&&n.oloc?{keys:[n.ploc+"/"+n.oloc],clef:this.systemInfo.getClef(e)}:{keys:["w"===f?"d/5":"b/4"]};r.duration=
f+"r";k=new b.StaveNote(r);k.drawLedgerLines=function(){};l=c.XMLID(d);n.ho&&this.processAttrHo(n.ho,k,h);k.setStave(h);"1"===n.dots&&k.addDotToAll();n.fermata&&this.fermatas.addFermataToNote(k,n.fermata);this.notes_by_id[l]={meiNote:d,vexNote:k,system:this.currentSystem_n};return{vexNote:k,id:l}}catch(g){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <rest>: "+a.Util.attsToString(d));}},processmRest:function(d,h,e,f,k){var l,n,r;f=this.systemInfo.getStaffInfo(e).meter;
k=new Vex.Flow.Fraction(f.count,f.unit);var g;2==k.value()?(g=a.tables.durations.breve,f=["b/4"]):4==k.value()?(g=a.tables.durations["long"],f=["b/4"]):(g="w",f=["d/5"]);try{return n=a.Util.attsToObj(d),k={duration:g+"r",duration_override:k,align_center:!0},n.ploc&&n.oloc?(k.keys=[n.ploc+"/"+n.oloc],k.clef=this.systemInfo.getClef(e)):k.keys=f,l=new b.StaveNote(k),r=c.XMLID(d),n.ho&&this.processAttrHo(n.ho,l,h),n.fermata&&this.fermatas.addFermataToNote(l,n.fermata),l.setStave(h),this.notes_by_id[r]=
{meiNote:d,vexNote:l,system:this.currentSystem_n},{vexNote:l,id:r}}catch(p){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <mRest>: "+a.Util.attsToString(d));}},processSpace:function(d,c){var e;try{return e=new b.GhostNote({duration:this.processAttsDuration(d,!0)+"r"}),e.setStave(c),{vexNote:e}}catch(f){throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <space>: "+a.Util.attsToString(d));}},processClef:function(d,c,e,f,k){var l;d=a.Util.attsToObj(d);
d={"clef.line":d.line,"clef.shape":d.shape,"clef.dis":d.dis,"clef.dis.place":d["dis.place"]};try{return l=new b.ClefNote(k.clefChangeInMeasure(d)),l.setStave(c),{vexNote:l}}catch(n){throw n;throw new a.RUNTIME_ERROR("BadArguments","A problem occurred processing the <clef>: "+a.Util.attsToString(d));}},processBeam:function(d,a,c,f,k){var l=this,n=[],r=b.GraceNote;d=e(d).children().map(function(){var d=l.processNoteLikeElement(this,a,c,f,k);return d.vexNote||d}).get();for(var g=0,p=d.length;g<p;g++)d[g]instanceof
r||n.push(d[g]);0<n.length&&l.allBeams.push(new b.Beam(n));return d},processTuplet:function(d,a,c,f,k){var l=this,n,g,p;n=e(d).children().map(function(){var d=l.processNoteLikeElement(this,a,c,f,k);return d.vexNote||d}).get();g=new b.Tuplet(n,{num_notes:+d.getAttribute("num")||3,beats_occupied:+d.getAttribute("numbase")||2});"ratio"===d.getAttribute("num.format")&&g.setRatioed(!0);(p=d.getAttribute("bracket.visible"))?g.setBracketed("true"===p?!0:!1):n[0]instanceof b.GraceNote&&g.setBracketed(!1);
(d=d.getAttribute("bracket.place"))&&g.setTupletLocation("above"===d?1:-1);l.allTuplets.push(g);return n},processAttrAccid:function(d,c,e){var f=a.tables.accidentals[d];if(!f)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+d);c.addAccidental(e,new b.Accidental(f))},processAttrHo:function(d,a,b){a.setExtraLeftPx(+d*b.getSpacingBetweenLines()/2)},processAttrTie:function(d,a,b,c){var e,f;e=0;for(f=d.length;e<f;++e)"i"===d[e]?this.ties.start_tieslur(a,{pname:b,oct:c}):
"t"===d[e]&&this.ties.terminate_tie(a,{pname:b,oct:c})},processAttrSlur:function(d,a){var b=this,c;d&&(c=b.parse_slur_attribute(d),e.each(c,function(){"i"===this.letter?b.slurs.start_tieslur(a,{nesting_level:this.nesting_level}):"t"===this.letter&&b.slurs.terminate_slur(a,{nesting_level:this.nesting_level})}))},parse_slur_attribute:function(d){var b=[],c,e,f,l;d=d.split(" ");e=0;for(f=d.length;e<f;e+=1)if(c=d[e],1===c.length)b.push({letter:c,nesting_level:0});else if(2===c.length){l=+c[1];if(!l)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01",
"badly formed slur attribute");b.push({letter:c[0],nesting_level:l})}else throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");return b},processAttsPitch:function(d){var b;b=e(d).attr("pname");d=e(d).attr("oct");if(!b||!d)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>");return b+"/"+d},addArticulation:function(d,c){var e=new b.Articulation(a.tables.articulations[c.getAttribute("artic")]),f=
c.getAttribute("place");f&&e.setPosition(a.tables.positions[f]);d.addArticulation(0,e)},processSyllables:function(d,a,b){var c,f,l,n=this,g;a=e(a).find("syl");e.each(a,function(a){c=e(this).text();f=e(this).attr("wordpos");l=e(this).parents("verse").attr("n");g=n.createAnnot(c,n.cfg.lyricsFont).setVerticalJustification(n.BOTTOM).setLineSpacing(n.cfg.lyricsFont.spacing);d.addAnnotation(0,g);n.verses.addSyllable(g,f,l,b);f&&n.hyphenation.addSyllable(g,f,b)})},processSyllable:function(d){if(d=e(d).find("syl")[0])return{text:e(d).text(),
wordpos:e(d).attr("wordpos"),verse_n:e(d).parents("verse").attr("n")}},createAnnot:function(d,a){return(new b.Annotation(d)).setFont(a.family,a.size,a.weight)},getMandatoryAttr:function(d,b){var c=e(d).attr(b);if(!c)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+b+" is mandatory.");return c},translateDuration:function(d){var b=a.tables.durations[d+""];if(b)return b;throw new a.RUNTIME_ERROR("BadArguments",'The MEI duration "'+d+'" is not supported.');},processAttsDuration:function(d,
a){var b;b=e(d).attr("dur");b===f&&alert("Could not get duration from:\n"+JSON.stringify(d,null,"\t"));b=this.translateDuration(b);a||"1"!==e(d).attr("dots")||(b+="d");return b},setStemDir:function(d,a,c){(d={down:b.StaveNote.STEM_DOWN,up:b.StaveNote.STEM_UP}[e(d).attr("stem.dir")])?a.stem_direction=d:c?a.stem_direction=c:a.auto_stem=!0},drawSystems:function(d){for(var a=this.systems.length;a--;)this.systems[a]&&this.systems[a].format(d).draw(d)},drawVexBeams:function(d,a){e.each(d,function(){this.setContext(a).draw()})},
drawVexTuplets:function(d,a){e.each(d,function(){this.setContext(a).draw()})}};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.EventLink=function(d,a){this.init(d,a)};a.EventLink.prototype={init:function(d,b){this.first_ref=new a.EventReference(d);this.last_ref=new a.EventReference(b);this.params={}},setParams:function(d){this.params=d},setFirstRef:function(d){this.first_ref=d},setLastRef:function(d){this.last_ref=d},setFirstId:function(d){this.first_ref.setId(d)},setLastId:function(d){this.last_ref.setId(d)},
setFirstTStamp:function(d){this.first_ref.setTStamp(d)},setLastTStamp:function(d){this.last_ref.setTStamp(d)},setContext:function(d){this.meicontext=d},getFirstId:function(){return this.first_ref.getId({meicontext:this.meicontext})},getLastId:function(){return this.last_ref.getId({meicontext:this.meicontext})}};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.EventReference=function(d){this.xmlid=d};a.EventReference.prototype={setId:function(d){this.xmlid=d},setTStamp:function(d){this.tstamp=
d;this.xmlid&&this.tryResolveReference(!0)},tryResolveReference:function(){if(!this.tstamp)throw new a.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001","EventReference: tstamp must be set in order to resolve reference.");this.xmlid=this.meicontext?c.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter):null},getId:function(d){d&&d.meicontext&&this.setContext(d.meicontext);return this.xmlid?this.xmlid:this.tstamp&&this.meicontext?(this.tryResolveReference(d&&d.strict),this.xmlid):null},
setContext:function(d){this.meicontext=d}};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.Hyphenation=function(d,a,b){this.allSyllables=[];this.printSpaceRight=a;this.font=d;this.maxHyphenDistance=b};a.Hyphenation.prototype={WORDBOUND:null,addSyllable:function(d,a,b){this.allSyllables[b]||(this.allSyllables[b]=[]);"i"===a&&this.allSyllables[b].push(this.WORDBOUND);this.allSyllables[b].push(d);"t"===a&&this.allSyllables[b].push(this.WORDBOUND)},addLineBreaks:function(d,a){var b,c;b=1;for(c=
d.length;b<c;b+=1)this.allSyllables[b]||(this.allSyllables[b]=[]),this.allSyllables[b].push(a)},setContext:function(d){this.ctx=d;return this},draw:function(){var d,a,c,e,k;this.ctx.setFont(this.font.family,this.font.size,this.font.weight);k=this.ctx.measureText("-").width;for(d=this.allSyllables.length;d--;)if(this.allSyllables[d])for(a=this.allSyllables[d].length;a--;)if(c=this.allSyllables[d][a],e=this.allSyllables[d][a+1],c!==this.WORDBOUND&&e!==this.WORDBOUND){var l={hyphen_width:k,max_hyphen_distance:this.maxHyphenDistance};
l.first_annot=c.system?{x:c.system.getMeasures()[0].getX()}:c;l.last_annot=e===f||e.system?{x:this.printSpaceRight}:e;(l.first_annot.y||l.last_annot.y)&&(new b.Hyphen(l)).setContext(this.ctx).renderHyphen()}}};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.Verses=function(d,a,b){this.hyphenations={};this.verses={};this.printSpaceRight=a;this.font=d;this.maxHyphenDistance=b};a.Verses.prototype={newHyphenation:function(){return new a.Hyphenation(this.font,this.printSpaceRight,this.maxHyphenDistance)},
addHyphenation:function(d){this.hyphenations[d]||(this.hyphenations[d]=this.newHyphenation());return this},getHyphenation:function(d){var a;a=this.hyphenations[d];a||(a=this.newHyphenation(),this.hyphenations[d]=a);return a},initHyphenations:function(d){var a=this,b;e.each(d,function(c){b=e(d[c]).parents("verse").attr("n")||"1";a.addHyphenation(b)})},drawHyphens:function(d){for(var a in this.hyphenations)this.getHyphenation(a).setContext(d).draw();return this},format:function(){var d,a,b,c,e;a=0;
for(d in this.verses){b=this.verses[d];c=0;for(e=b.length;c<e;c++)b[c].setTextLine(a);a+=1}return this},addLineBreaks:function(d,a){for(verse_n in this.hyphenations)this.hyphenations[verse_n].addLineBreaks(d,a);return this},addSyllable:function(d,a,b,c){b=b||"1";this.verses[b]||(this.verses[b]=[]);this.verses[b].push(d);a&&this.hyphenations[b].addSyllable(d,a,c);return this}};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.LinkCollection=function(a,b){this.init(a,b)};a.LinkCollection.prototype=
{init:function(a,b){this.allVexObjects=[];this.allModels=[];this.systemInfo=a;this.unresolvedTStamp2=b},validateAtts:function(){throw new a.RUNTIME_ERROR("MEI2VF.DEVELOPMENT_ERROR.validateAtts","Developers have to provide a validateAtts method when inheriting MEI2VF.LinkCollection.");},createVexFromInfos:function(){throw new a.RUNTIME_ERROR("MEI2VF.DEVELOPMENT_ERROR.createVexFromInfos","Developers have to provide a createVexFromInfos method when inheriting MEI2VF.LinkCollection.");},createInfos:function(d,
b,f){var m=this,k=function(a){return{staff_n:e(a).attr("staff")||"1",layer_n:e(a).attr("layer")||"1"}},l=function(d,b,h){b=k(b);var m=e(h).find('staff[n="'+b.staff_n+'"]');h=e(m).find('layer[n="'+b.layer_n+'"]').get(0);if(!h&&((m=e(m).find("layer"))&&!m.attr("n")&&(h=m),!h))throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E01","Cannot find layer");b=f.getStaffInfo(b.staff_n);if(!b)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E02","Cannot determine staff definition.");b=b.meter;if(!b.count||
!b.unit)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");return c.tstamp2id(d,h,b)};e.each(d,function(){var d,c,f;d=new a.EventLink(null,null);c=a.Util.attsToObj(this);m.validateAtts(c);d.setParams(c);if(f=c.startid)d.setFirstId(f);else if(f=c.tstamp)f=l(f,this,b),d.setFirstId(f);if(f=c.endid)d.setLastId(f);else if(f=c.tstamp2)c=+f.substring(0,f.indexOf("m")),0<c?(d.setLastTStamp(f.substring(f.indexOf("+")+1)),f=k(this),
c=(+e(b).attr("n")+c).toString()+":"+f.staff_n+":"+f.layer_n,m.unresolvedTStamp2[c]||(m.unresolvedTStamp2[c]=[]),m.unresolvedTStamp2[c].push(d)):(f=l(f.substring(f.indexOf("+")+1),this,b),d.setLastId(f));m.addModel(d)})},addModel:function(d){this.allModels.push(d)},getModels:function(){return this.allModels},setContext:function(d){this.ctx=d;return this},draw:function(){var d=this.ctx;e.each(this.allVexObjects,function(){this.setContext(d).draw()})}};a.Hairpins=function(d,a){this.init(d,a)};Vex.Inherit(a.Hairpins,
a.LinkCollection,{init:function(d,b){a.Ties.superclass.init.call(this,d,b)},validateAtts:function(d){if(!d.form)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:createInfos","@form is mandatory in <hairpin> - make sure the xml is valid.");},createVexFromInfos:function(a){var b=this,c,m,k;k={height:10,y_shift:0,left_shift_px:0,r_shift_px:0};e.each(b.allModels,function(){c=a[this.getFirstId()]||{};m=a[this.getLastId()]||{};c.system!==f&&m.system!==f&&c.system!==m.system||b.createSingleHairpin(c,
m,this.params,k)});return this},createSingleHairpin:function(d,c,e,f){var k,l;k=a.tables.positions[e.place];l=a.tables.hairpins[e.form];d.vexNote&&c.vexNote?(l=new b.StaveHairpin({first_note:d.vexNote,last_note:c.vexNote},l),l.setRenderOptions(f),l.setPosition(k),this.allVexObjects.push(l)):(a.L("Hairpins","Hairpin cannot be rendered:"),console.log(arguments))}});a.Ties=function(a,b){this.init(a,b)};Vex.Inherit(a.Ties,a.LinkCollection,{init:function(d,b){a.Ties.superclass.init.call(this,d,b)},validateAtts:function(){},
start_tieslur:function(d,b){var c=new a.EventLink(d,null);c.setParams({linkCond:b});this.allModels.push(c)},terminate_tie:function(d,b){var c,e,f,l,n;n=this.getModels();c=function(a,d){return a&&d&&a.pname===d.pname&&a.oct===d.oct};if(!b.pname||!b.oct)throw new a.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch or octave specified for the tie");e=!1;for(f=0;!e&&f<n.length;++f)l=n[f],!l.getLastId()&&c(l.params.linkCond,b)&&(e=!0,l.setLastId(d));e||this.addModel(new a.EventLink(null,d))},
terminate_slur:function(d,b){var c,e,f,l,n=this.getModels();c=function(a,d){return a.nesting_level===d.nesting_level};e=!1;for(f=0;f<n.length;++f)if((l=n[f])&&!l.getLastId()&&c(l.params.linkCond,b)){l.setLastId(d);e=!0;break}e||this.addModel(new a.EventLink(null,d))},createVexFromInfos:function(a){var b=this,c,m;e.each(b.allModels,function(){var e;c=a[this.getFirstId()]||{};m=a[this.getLastId()]||{};this.params.curvedir||((e=c.layerDir||m.layerDir)?this.params.curvedir=-1===e?"below":1===e?"above":
f:c.vexNote?(e=c.vexNote.keys.length,1<e&&(this.params.curvedir=0===+c.index?"below":+c.index===e-1?"above":f)):m.vexNote&&(e=m.vexNote.keys.length,1<e&&(this.params.curvedir=0===+m.index?"below":+m.index===e-1?"above":f)));c.system!==f&&m.system!==f&&c.system!==m.system?(b.createSingleStaveTie(c,{},this.params),this.params.curvedir||(this.params.curvedir=-1===c.vexNote.getStemDirection()?"above":"below"),b.createSingleStaveTie({},m,this.params)):b.createSingleStaveTie(c,m,this.params)});return this},
createSingleStaveTie:function(a,c,e){var f;(f=e.bezier)?(f=this.bezierStringToCps(f),c=new b.Curve(a.vexNote,c.vexNote,{cps:f,y_shift_start:+e.startvo,y_shift_end:+e.endvo})):(c=new b.StaveTie({first_note:a.vexNote,last_note:c.vexNote,first_indices:a.index,last_indices:c.index}),c.setDir(e.curvedir),a.vexNote instanceof b.GraceNote&&(c.render_options.first_x_shift=-5));this.allVexObjects.push(c)},bezierStringToCps:function(a){for(var b=[],c=a.split(" ");c[0];)a=c.splice(0,2),b.push({x:+a[0],y:+a[1]});
return b}});return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.PointerCollection=function(a,b){this.init(a,b)};a.PointerCollection.prototype={BOTTOM:b.Annotation.VerticalJustify.BOTTOM,init:function(a,b){this.allVexObjects=[];this.allModels=[];this.systemInfo=a;this.font=b},createVexFromInfos:function(){throw new a.RUNTIME_ERROR("MEI2VF.DEVELOPMENT_ERROR.createVexFromInfos","You have to prodide a createVexFromInfos method when inheriting MEI2VF.PointerCollection.");},createInfos:function(d,
b){var f=this;e.each(d,function(){var d,k;d=a.Util.attsToObj(this);k=d.startid;if(!k)if(k=d.tstamp){var l=e(this).attr("staff")||"1",n=e(this).attr("layer")||"1",g=e(b).find('staff[n="'+l+'"]'),n=e(g).find('layer[n="'+n+'"]').get(0);if(!n&&((g=e(g).find("layer"))&&!g.attr("n")&&(n=g),!n))throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E01","Cannot find layer");l=f.systemInfo.getStaffInfo(l);if(!l)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E02","Cannot determine staff definition.");l=l.meter;
if(!l.count||!l.unit)throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");k=c.tstamp2id(k,n,l)}else throw new a.RUNTIME_ERROR("MEI2VF.RERR.createInfos","Neither @startid nor @tstamp are specified");f.allModels.push({element:this,atts:d,startid:k})})},addModel:function(a){this.allModels.push(a)},getModels:function(){return this.allModels}};a.Directives=function(a,b){this.init(a,b)};Vex.Inherit(a.Directives,a.PointerCollection,
{init:function(d,b){a.Directives.superclass.init.call(this,d,b)},createVexFromInfos:function(d){var c,f,m,k;for(c=this.allModels.length;c--;)if(f=this.allModels[c],m=d[f.startid])k=(new b.Annotation(e(f.element).text().trim())).setFont(this.font.family,this.font.size,this.font.weight),k.setWidth(0),"below"===f.atts.place?m.vexNote.addAnnotation(0,k.setVerticalJustification(this.BOTTOM)):m.vexNote.addAnnotation(0,k);else throw new a.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");
}});a.Dynamics=function(a,b){this.init(a,b)};Vex.Inherit(a.Dynamics,a.PointerCollection,{init:function(d,b){a.Dynamics.superclass.init.call(this,d,b)},createVexFromInfos:function(d){var c,f,m,k;for(c=this.allModels.length;c--;)if(f=this.allModels[c],m=d[f.startid])k=(new b.Annotation(e(f.element).text().trim())).setFont(this.font.family,this.font.size,this.font.weight),"above"===f.atts.place?m.vexNote.addAnnotation(0,k):m.vexNote.addAnnotation(0,k.setVerticalJustification(this.BOTTOM));else throw new a.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos",
"The reference in the directive could not be resolved.");}});a.Fermatas=function(a,b){this.init(a,b)};Vex.Inherit(a.Fermatas,a.PointerCollection,{init:function(d,b){a.Fermatas.superclass.init.call(this,d,b)},createVexFromInfos:function(d){var b,c,e;for(b=this.allModels.length;b--;)if(c=this.allModels[b],e=d[c.startid])this.addFermataToNote(e.vexNote,c.atts.place);else throw new a.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");},addFermataToNote:function(d,
c,e){var f=new b.Articulation(a.tables.fermata[c]);f.setPosition(a.tables.positions[c]);d.addArticulation(e||0,f)}});return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.Measure=function(a){this.init(a)};a.Measure.prototype={init:function(d){this.element=d.element;this.n=d.n;this.staffs=d.staffs;this.voices=d.voices;this.verses=d.verses;this.startConnectors=new a.Connectors(d.startConnectorCfg);this.inlineConnectors=new a.Connectors(d.inlineConnectorCfg);this.tieElements=d.tieElements;this.slurElements=
d.slurElements;this.hairpinElements=d.hairpinElements;this.tempoElements=d.tempoElements;this.tempoFont=d.tempoFont;this.maxEndModifierW=this.maxNoteStartX=0;this.meiW=this.readMEIW(this.element)},readMEIW:function(a){return+a.getAttribute("width")||null},getStaffs:function(){return this.staffs},getVoices:function(){return this.voices},getX:function(){return this.getFirstDefinedStaff().x},getN:function(){return this.n},getFirstDefinedStaff:function(){var d,b;d=0;for(b=this.staffs.length;d<b;d+=1)if(this.staffs[d])return this.staffs[d];
throw new a.RUNTIME_ERROR("ERROR","getFirstDefinedStaff(): no staff found in the current measure.");},addTempoToStaves:function(){var d=this,b,c,f,k,l;e.each(d.tempoElements,function(){k=a.Util.attsToObj(this);c=d.staffs[k.staff];l=c.getSpacingBetweenLines()/2;f=new Vex.Flow.StaveTempo({name:e(this).text(),duration:k["mm.unit"],dots:+k["mm.dots"],bpm:+k.mm},c.x,5);k.vo&&f.setShiftY(+k.vo*l);b=0<c.getModifierXShift()?-14:14;c.hasTimeSig&&(b-=24);k.ho&&(b+=+k.ho*l);f.setShiftX(b);f.font=d.tempoFont;
c.modifiers.push(f)})},calculateMinWidth:function(){this.calculateMaxNoteStartX();this.calculateMaxEndModifierWidth();this.calculateRepeatPadding();this.minVoicesW=this.voices.preFormat();this.minWidth=this.maxNoteStartX+this.maxEndModifierW+this.minVoicesW+this.repeatPadding},getMinWidth:function(){return this.minWidth},setFinalWidth:function(a){this.w=null===this.meiW?this.minWidth+a:this.meiW},calculateMaxNoteStartX:function(){var a,b,c;b=this.staffs;for(a=b.length;a--;)if(c=b[a])this.maxNoteStartX=
Math.max(this.maxNoteStartX,c.getNoteStartX())},calculateMaxEndModifierWidth:function(){var a,b,c;b=this.staffs;for(a=b.length;a--;)if(c=b[a])this.maxEndModifierW=Math.max(this.maxEndModifierW,c.getGlyphEndX()-c.end_x)},calculateRepeatPadding:function(){var a=this.getFirstDefinedStaff();this.repeatPadding=a.modifiers[0].barline==Vex.Flow.Barline.type.REPEAT_BEGIN&&2<a.modifiers.length?20:0},format:function(a,c){for(var e=this.w,f=this.staffs.length,k,l;f--;)if(this.staffs[f]){k=this.staffs[f];c&&
"string"===typeof c[f]&&k.setText(c[f],b.Modifier.Position.LEFT,{shift_y:-3});if("function"==typeof k.setX)k.setX(a);else for(k.x=a,k.glyph_start_x=a+5,k.bounds.x=a,l=0;l<k.modifiers.length;l++)k.modifiers[l].x=a;k.start_x=k.x+this.maxNoteStartX;k.setWidth(e);k.end_x-=this.maxEndModifierW;k.modifiers[0].x+=a}this.voices.format(this.getFirstDefinedStaff());this.verses.format()},draw:function(a){var b,c,e;c=this.staffs;for(b=c.length;b--;)(e=c[b])&&e.setContext(a).draw();this.voices.draw(a,c);this.startConnectors.setContext(a).draw();
this.inlineConnectors.setContext(a).draw()}};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.DO_LOG=!1;a.setLogging=function(d){a.DO_LOG=d};a.L=function(){a.DO_LOG&&Vex.L("MEI2VF",arguments)};a.RUNTIME_ERROR=function(a,b){this.error_code=a;this.message=b};a.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.tables={accidentals:{n:"n",f:"b",s:"#",bb:"ff",ss:"##"},durations:{"long":"l",
breve:"d",1:"w",2:"h",4:"q",8:"8",16:"16",32:"32",64:"64"},positions:{above:b.Modifier.Position.ABOVE,below:b.Modifier.Position.BELOW},hairpins:{cres:b.StaveHairpin.type.CRESC,dim:b.StaveHairpin.type.DECRESC},articulations:{acc:"a>",stacc:"a.",ten:"a-",stacciss:"av",marc:"a^",dnbow:"am",upbow:"a|",snap:"ao",lhpizz:"a+",dot:"a.",stroke:"a|"},fermata:{above:"a@a",below:"a@u"},barlines:{single:b.Barline.type.SINGLE,dbl:b.Barline.type.DOUBLE,end:b.Barline.type.END,rptstart:b.Barline.type.REPEAT_BEGIN,
rptend:b.Barline.type.REPEAT_END,rptboth:b.Barline.type.REPEAT_BOTH,invis:b.Barline.type.NONE}};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.StaffInfo=function(d,b,c,e){this.renderWith={clef:b,keysig:c,timesig:e};this.spacing=null;this.staffDefObj=a.Util.attsToObj(d);this.updateMeter();this.updateStaveLabels();this.updateSpacing();this.currentClef=this.convertClef(this.staffDefObj)};a.StaffInfo.prototype={updateMeter:function(){this.staffDefObj.hasOwnProperty("meter.count")&&this.staffDefObj.hasOwnProperty("meter.unit")&&
(this.meter={count:+this.staffDefObj["meter.count"],unit:+this.staffDefObj["meter.unit"]})},updateStaveLabels:function(){var a;a=this.staffDefObj.label;"string"===typeof a&&(this.label=a);a=this.staffDefObj["label.abbr"];"string"===typeof a&&(this.labelAbbr=a)},updateSpacing:function(){var a;a=+this.staffDefObj.spacing;isNaN(a)||(this.spacing=a);return this.spacing},forceSectionStartInfo:function(){this.renderWith.clef=!0;this.renderWith.keysig=!0;this.renderWith.timesig=!0},forceStaveStartInfo:function(){this.renderWith.clef=
!0;this.renderWith.keysig=!0},showClefCheck:function(){if(this.renderWith.clef&&"false"!==this.staffDefObj["clef.visible"])return this.renderWith.clef=!1,!0},showKeysigCheck:function(){if(this.renderWith.keysig&&(this.renderWith.keysig=!1,"false"!==this.staffDefObj["key.sig.show"]))return!0},showTimesigCheck:function(){if(this.renderWith.timesig&&(this.renderWith.timesig=!1,"norm"===this.staffDefObj["meter.rend"]||this.staffDefObj["meter.rend"]===f))return!0},initialClefCopy:null,clefChangeInMeasure:function(a){this.initialClefCopy=
this.currentClef;this.currentClef=this.convertClef(a);return this.currentClef+"_small"},checkInitialClef:function(){this.initialClefCopy&&(this.currentClef=this.initialClefCopy)},removeInitialClefCopy:function(){this.initialClefCopy=null},convertClef:function(d){var c,e,m;c=d["clef.shape"];if(!c)throw new a.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute clef.shape is mandatory.");e=d["clef.line"];m=d["clef.dis"];d=d["clef.dis.place"];if("G"===c&&(!e||"2"===e))return"8"===m&&"below"===d&&
b.clefProperties.values.octave!=f?"octave":"treble";if("F"===c)return"3"===e?"baritone-f":"bass";if("C"===c){if("1"===e)return"soprano";if("2"===e)return"mezzo-soprano";if("3"===e)return"alto";if("4"===e)return"tenor";if("5"===e)return"baritone-c"}throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+c+'" '+(e?'clef.line="'+e+'"':"")+" ]");},getClef:function(){return this.currentClef},getKeySpec:function(){var d,b;if(this.staffDefObj["key.pname"]!==
f){d=this.staffDefObj["key.pname"].toUpperCase();b=this.staffDefObj["key.accid"];if(b!==f)switch(b){case "s":d+="#";break;case "f":d+="b";break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'");}b=this.staffDefObj["key.mode"];b!==f&&(d+="major"===b?"":"m");return d}return"C"},getTimeSig:function(){var a,b;if(a=this.staffDefObj["meter.sym"])return"cut"===a?"C|":"C";a=this.staffDefObj["meter.count"];b=this.staffDefObj["meter.unit"];return a&&
b?a+"/"+b:f},updateRenderWith:function(a){var b=this,c,e;c={clef:!1,keysig:!1,timesig:!1};e=function(c){return b.staffDefObj[c]===a[c]};e("clef.shape")&&e("clef.line")||(c.clef=!0);e("key.pname")&&e("key.accid")&&e("key.mode")||(c.keysig=!0);e("meter.count")&&e("meter.unit")||(c.timesig=!0);b.renderWith=c},updateDef:function(b){b=a.Util.attsToObj(b);this.updateRenderWith(b);this.staffDefObj=b;this.updateMeter();this.updateStaveLabels();this.updateSpacing();this.currentClef=this.convertClef(this.staffDefObj)}};
return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.Connectors=function(a){this.allVexConnectors=[];a&&this.init(a)};a.Connectors.prototype={vexTypes:{line:b.StaveConnector.type.SINGLE_LEFT,brace:b.StaveConnector.type.BRACE,bracket:b.StaveConnector.type.BRACKET,none:null,singleright:b.StaveConnector.type.SINGLE_RIGHT},vexTypesBarlineRight:{single:b.StaveConnector.type.SINGLE_RIGHT,dbl:b.StaveConnector.type.THIN_DOUBLE,end:b.StaveConnector.type.BOLD_DOUBLE_RIGHT,rptend:b.StaveConnector.type.BOLD_DOUBLE_RIGHT,
invis:null},vexTypesBarlineLeft:{single:b.StaveConnector.type.SINGLE_LEFT,dbl:b.StaveConnector.type.THIN_DOUBLE,end:b.StaveConnector.type.BOLD_DOUBLE_LEFT,rptstart:b.StaveConnector.type.BOLD_DOUBLE_LEFT,invis:null},init:function(a){var c=this,f,m,k,l,n,g,p=a.models,q=a.staffs,t=a.barline_l,s=a.barline_r,y=a.system_n;g=a.labelMode;e.each(p,function(){f=s?c.vexTypesBarlineRight[s]:c.vexTypes[this.symbol];m=q[this.top_staff_n];k=q[this.bottom_staff_n];"number"===typeof f&&m&&k&&(l=new b.StaveConnector(m,
k),l.setType(f),c.allVexConnectors.push(l),"full"===g?n=1===y?this.label:this.labelAbbr:"abbr"===g&&(n=this.labelAbbr),n&&l.setText(n));t&&(f=c.vexTypesBarlineLeft[t],"number"===typeof f&&m&&k&&(l=new b.StaveConnector(m,k),l.setType(f),f===b.StaveConnector.type.BOLD_DOUBLE_LEFT&&(l.checkShift=!0),c.allVexConnectors.push(l)))})},getAll:function(){return this.allVexConnectors},setContext:function(a){this.ctx=a;return this},draw:function(){var a,b,c,e;a=0;for(b=this.allVexConnectors.length;a<b;a+=1)c=
this.allVexConnectors[a],c.checkShift&&(e=c.top_stave.getModifierXShift(),0<e&&c.setXShift(e)),c.setContext(this.ctx).draw()}};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.StaffVoice=function(a,b){this.voice=a;this.staff_n=b};a.StaveVoices=function(){this.all_voices=[];this.formatter=new b.Formatter};a.StaveVoices.prototype={addStaffVoice:function(a){this.all_voices.push(a)},addVoice:function(b,c){this.addStaffVoice(new a.StaffVoice(b,c))},reset:function(){this.all_voices=[]},preFormat:function(){var a,
b,c;a=this.all_voices;this.vexVoices=[];this.vexVoicesStaffWise={};for(c=a.length;c--;)this.vexVoices.push(a[c].voice),b=a[c].staff_n,this.vexVoicesStaffWise[b]?this.vexVoicesStaffWise[b].push(a[c].voice):this.vexVoicesStaffWise[b]=[a[c].voice];this.formatter.preCalculateMinTotalWidth(this.vexVoices);return this.formatter.getMinTotalWidth()},format:function(a){var b,c;c=this.formatter;for(b in this.vexVoicesStaffWise)c.joinVoices(this.vexVoicesStaffWise[b],{align_rests:!0});c.formatToStave(this.vexVoices,
a)},draw:function(a,b){var c,e,f=this.all_voices;for(c=0;c<f.length;++c)e=f[c],e.voice.draw(a,b[e.staff_n])}};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.System=function(a){this.init(a)};a.System.prototype={LABEL_PADDING:20,init:function(a){this.leftMar=a.leftMar;this.coords=a.coords;this.staffYs=a.staffYs;this.labels=a.labels;this.measures=[]},getStaffYs:function(){return this.staffYs},addMeasure:function(a){this.measures.push(a)},getMeasure:function(a){return this.measures[a]},getMeasures:function(){return this.measures},
getLastMeasure:function(){return this.measures[this.measures.length-1]},calculateInitialIndent:function(a){var b,c=0,e,f,l;a.setFont("Times",16);for(b in this.labels)e=this.labels[b],"string"===typeof e&&(e=a.measureText(this.labels[b]).width,c<e&&(c=e));f=this.getMeasures()[0].startConnectors.getAll();for(l=f.length;l--;)e=f[l].text,"string"===typeof e&&(e=a.measureText(this.labels[b]).width,c<e&&(c=e));this.leftMar=0===c?0:c+this.LABEL_PADDING},calculateMinMeasureWidths:function(){for(var a=this.measures,
b=a.length;b--;)a[b].calculateMinWidth()},setFinalMeasureWidths:function(){var a,b,c=0,e=0;a=0;for(b=this.measures.length;a<b;a+=1)null===this.measures[a].meiW?(e+=1,c+=this.measures[a].getMinWidth()):c+=this.measures[a].meiW;c=Math.floor((this.coords.w-this.leftMar-c)/e);a=0;for(b=this.measures.length;a<b;a+=1)this.measures[a].setFinalWidth(c)},format:function(a){var b,c,e,f;"number"!==typeof this.leftMar&&this.calculateInitialIndent(a);this.calculateMinMeasureWidths();this.setFinalMeasureWidths();
e=this.coords.x+this.leftMar;c=this.getMeasures();a=0;for(b=c.length;a<b;a+=1)c[a]&&(f=0===a?this.labels:null,c[a].format(e,f),e+=c[a].w),c[a].addTempoToStaves();return this},draw:function(a){for(var b=this.measures.length;b--;)this.measures[b]&&this.measures[b].draw(a)}};return a}(q||{},g,Vex.Flow,jQuery);q=function(a,c,b,e,f){a.SystemInfo=function(){};a.SystemInfo.prototype={STAVE_HEIGHT:40,init:function(a,b){this.cfg=a;this.printSpace=b;this.currentStaffInfos=[];this.systemLeftMar=f;this.currentLowestY=
0;this.startConnectorInfos={};this.inlineConnectorInfos={}},setLeftMar:function(a){this.systemLeftMar=a},getLeftMar:function(){return this.systemLeftMar},setModelForStaveRange:function(a,b,c){a[b.top_staff_n+":"+b.bottom_staff_n+(c||"")]=b},setConnectorModels:function(b,c,f){var m,k,l;k=c.first_n;l=c.last_n;c=e(b).attr("symbol");m=e(b).attr("barthru");a.L("Converter.setConnectorModels() {2}","symbol: "+c," range.first_n: "+k," range.last_n: "+l);this.setModelForStaveRange(this.startConnectorInfos,
{top_staff_n:k,bottom_staff_n:l,symbol:c||"line",label:e(b).attr("label"),labelAbbr:e(b).attr("label.abbr")});!f&&this.cfg.autoStaveConnectorLine&&this.setModelForStaveRange(this.startConnectorInfos,{top_staff_n:k,bottom_staff_n:l,symbol:"none"===c?"none":"line"},"autoline");"true"===m&&this.setModelForStaveRange(this.inlineConnectorInfos,{top_staff_n:k,bottom_staff_n:l,symbol:"singleright"})},getStaffInfo:function(a){return this.currentStaffInfos[a]},getAllStaffInfos:function(){return this.currentStaffInfos},
getClef:function(b){var c;c=this.currentStaffInfos[b];if(!c)throw new a.RUNTIME_ERROR("MEI2VF.getClefForStaffNr():E01","No staff definition for staff n="+b);return c.getClef()},getCurrentLowestY:function(){return this.currentLowestY},setCurrentLowestY:function(a){this.currentLowestY=a},getYs:function(a){var b,c,e,f=!0,l,g=[];b=0;c=1;for(e=this.currentStaffInfos.length;c<e;c+=1)this.currentStaffInfos[c]&&(l=this.currentStaffInfos[c].spacing,b+=f?0:null!==l?this.STAVE_HEIGHT+this.currentStaffInfos[c].spacing:
this.STAVE_HEIGHT+this.cfg.staveSpacing,g[c]=a+b,f=!1);a=a+b+this.STAVE_HEIGHT;a>this.currentLowestY&&(this.currentLowestY=a);return g},forceSectionStartInfos:function(){for(var a=this.currentStaffInfos.length;a--;)this.currentStaffInfos[a]&&this.currentStaffInfos[a].forceSectionStartInfo()},forceStaveStartInfos:function(){for(var a=this.currentStaffInfos.length;a--;)this.currentStaffInfos[a]&&this.currentStaffInfos[a].forceStaveStartInfo()},processScoreDef:function(a){var b,c;b=e(a).attr("system.leftmar");
"string"===typeof b&&this.setLeftMar(+b);c=e(a).children();a=0;for(b=c.length;a<b;a+=1)this.processScoreDef_child(c[a])},processScoreDef_child:function(b){switch(b.localName){case "staffGrp":this.processStaffGrp(b);break;case "pgHead":break;default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <scoreDef>");}},processStaffGrp:function(b,c){var f=this,m={};e(b).children().each(function(b,c){var d=f.processStaffGrp_child(c);a.L("Converter.processStaffGrp() {1}.{a}",
"childRange.first_n: "+d.first_n," childRange.last_n: "+d.last_n);0===b&&(m.first_n=d.first_n);m.last_n=d.last_n});f.setConnectorModels(b,m,c);return m},processStaffGrp_child:function(b){switch(b.localName){case "staffDef":return b=this.processStaffDef(b),{first_n:b,last_n:b};case "staffGrp":return this.processStaffGrp(b,!0);default:throw new a.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+b.localName+"> is not supported in <staffGrp>");}},processStaffDef:function(b){var c,f;c=+e(b).attr("n");
(f=this.currentStaffInfos[c])?f.updateDef(b):this.currentStaffInfos[c]=new a.StaffInfo(b,!0,!0,!0);return c}};return a}(q||{},g,Vex.Flow,jQuery);Vex.Flow.KeySignature=function(){function a(a,b){0<arguments.length&&this.init(a,b)}Vex.Inherit(a,Vex.Flow.StaveModifier,{init:function(c,b){a.superclass.init();this.setPadding(b||10);this.glyphFontScale=38;this.accList=Vex.Flow.keySignature(c)},addAccToStave:function(a,b){var e=new Vex.Flow.Glyph(b.glyphCode,this.glyphFontScale);this.placeGlyphOnLine(e,
a,b.line);a.addGlyph(e)},addModifier:function(a){this.convertAccLines(a.clef,this.accList[0].glyphCode);for(var b=0;b<this.accList.length;++b)this.addAccToStave(a,this.accList[b])},addToStave:function(a,b){if(0===this.accList.length)return this;b||a.addGlyph(this.makeSpacer(this.padding));this.addModifier(a);return this},convertAccLines:function(a,b){var e=0,f="tenor"===a&&"v18"===b?!0:!1;switch(a){case "bass":e=1;break;case "alto":e=.5;break;case "tenor":f||(e=-.5)}if(f)for(e=[3,1,2.5,.5,2,0,1.5],
f=0;f<this.accList.length;++f)this.accList[f].line=e[f];else if("treble"!=a)for(f=0;f<this.accList.length;++f)this.accList[f].line+=e}});return a}();Vex.Flow.Hyphen=function(){function a(a){0<arguments.length&&this.init(a)}a.prototype={init:function(a){this.max_hyphen_distance=a.max_hyphen_distance||75;this.font={family:"Arial",size:10,style:""};this.config=a;this.context=null},setContext:function(a){this.context=a;return this},setFont:function(a){this.font=a;return this},renderHyphen:function(){var a=
this.config,b=this.context,e=a.hyphen_width||b.measureText("-").width,f=a.first_annot,d=a.last_annot,a=f.text?f.x+f.text_width:f.x,h=d.x-a;if(h>e)for(f=f.y&&d.y?(f.y+d.y)/2:f.y||d.y,d=Math.ceil(h/this.max_hyphen_distance),h/=d+1;d--;)a+=h,b.fillText("-",a-e/2,f)},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","No context to render hyphens.");var a=this.context;a.save();a.setFont(this.font.family,this.font.size,this.font.style);this.renderHyphen();a.restore();return!0}};return a}();
Vex.Flow.durationToTicks.durations.d||(Vex.Flow.durationToTicks.durations.d=Vex.Flow.RESOLUTION/.5);Vex.Flow.durationToGlyph.duration_codes.d||(Vex.Flow.durationToGlyph.duration_codes.d={common:{head_width:20,stem:!1,stem_offset:0,flag:!1,dot_shiftY:0,line_above:0,line_below:0},type:{n:{code_head:"noteheadDoubleWholeSquare"},h:{code_head:"v46"},m:{code_head:"v92",stem_offset:-3},r:{code_head:"restDoubleWhole",head_width:12,rest:!0,position:"D/5",dot_shiftY:.5},s:{head_width:15,position:"B/4"}}});
Vex.Flow.durationToTicks.durations.l||(Vex.Flow.durationToTicks.durations.l=Vex.Flow.RESOLUTION/.25);Vex.Flow.durationToGlyph.duration_codes.l||(Vex.Flow.durationToGlyph.duration_codes.l={common:{head_width:20,stem:!1,stem_offset:0,flag:!1,dot_shiftY:0,line_above:0,line_below:0},type:{n:{code_head:"noteheadQuadWholeSquare"},h:{code_head:"v46"},m:{code_head:"v92",stem_offset:-3},r:{code_head:"restDoubleWhole",head_width:12,rest:!0,position:"D/5",dot_shiftY:.5},s:{head_width:15,position:"B/4"}}});Vex.Flow.Font.glyphs.gClef=
{x_min:0,x_max:948,ha:944,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 948 35 l 948 15 b 693 -328 948 -141 850 -269 b 728 -536 711 -454 728 -536 b 736 -633 734 -571 736 -603 b 489 -920 736 -853 588 -914 b 456 -921 477 -920 466 -921 b 190 -700 225 -921 190 -777 b 196 -650 190 -671 195 -650 b 323 -532 204 -587 259 -536 l 333 -532 b 476 -665 409 -532 469 -592 l 476 -675 b 378 -806 476 -738 435 -788 b 343 -815 365 -812 356 -812 b 330 -826 336 -818 330 -820 b 343 -841 330 -830 335 -836 b 459 -869 372 -862 412 -869 l 486 -869 b 673 -638 503 -869 673 -867 b 665 -543 673 -610 671 -578 l 633 -347 l 626 -347 b 531 -353 595 -351 563 -353 b 10 94 301 -353 36 -245 b 8 136 8 108 8 122 b 445 788 8 406 239 612 l 428 876 b 419 1019 421 925 419 973 b 645 1543 419 1273 511 1484 b 750 1410 645 1543 696 1534 b 811 1141 790 1319 811 1229 b 528 594 811 951 715 767 b 573 354 542 518 557 445 b 591 357 578 357 585 357 l 606 357 b 948 35 785 357 937 216 m 655 1320 b 477 948 545 1315 477 1092 b 480 897 477 930 477 913 b 491 829 480 889 486 862 b 745 1177 641 942 728 1061 b 748 1208 746 1189 748 1198 b 655 1320 748 1284 701 1320 m 120 22 l 120 11 b 531 -302 129 -234 378 -302 b 623 -291 570 -302 602 -298 l 547 157 b 382 -3 455 141 382 95 l 382 -17 b 476 -155 385 -74 448 -143 b 497 -181 487 -161 497 -172 b 480 -192 497 -186 491 -192 b 451 -186 473 -192 463 -190 b 300 0 385 -165 322 -95 b 291 62 294 20 291 41 b 517 344 291 188 391 307 l 482 563 b 120 22 298 427 120 256 m 683 -276 b 833 -64 781 -234 833 -162 l 833 -49 b 609 162 827 69 727 162 l 603 162 b 683 -276 633 4 661 -148 "};
Vex.Flow.Font.glyphs.gClef8vb={x_min:0,x_max:937,ha:930,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 937 46 l 937 24 b 685 -316 937 -130 839 -256 b 717 -521 704 -441 717 -521 b 727 -622 724 -557 727 -591 b 533 -896 727 -799 624 -872 b 588 -963 563 -906 588 -928 b 546 -1030 588 -1008 559 -1016 b 535 -1049 538 -1036 535 -1042 b 540 -1070 535 -1054 538 -1061 b 553 -1116 549 -1085 553 -1100 b 493 -1203 553 -1154 531 -1189 b 435 -1211 473 -1211 455 -1211 b 315 -1133 391 -1211 328 -1183 b 314 -1120 314 -1128 314 -1124 b 382 -1030 314 -1082 349 -1040 b 391 -1023 388 -1029 391 -1026 b 388 -1016 391 -1021 389 -1018 b 365 -963 372 -1000 365 -981 b 396 -903 365 -941 377 -918 b 185 -680 213 -879 185 -750 b 190 -634 185 -652 189 -634 b 319 -518 200 -570 252 -521 l 329 -518 b 468 -650 402 -518 462 -578 l 468 -657 b 371 -790 468 -720 428 -770 b 337 -799 360 -797 350 -797 b 326 -809 330 -801 326 -805 b 337 -825 326 -813 329 -818 b 454 -853 367 -846 407 -853 l 476 -853 b 665 -620 493 -853 665 -850 b 657 -526 665 -592 662 -561 l 626 -336 l 617 -336 b 531 -342 589 -339 560 -342 b 7 102 301 -342 35 -237 b 6 144 6 116 6 130 b 435 792 6 414 234 617 l 423 881 b 413 1025 416 930 413 979 b 637 1541 413 1275 501 1483 b 741 1411 637 1541 689 1532 b 801 1142 780 1320 801 1231 b 522 599 801 953 707 773 b 566 363 533 524 550 452 b 585 365 571 365 577 365 l 601 365 b 937 46 777 365 927 225 m 435 -1196 b 484 -1148 462 -1196 484 -1170 b 482 -1130 484 -1142 484 -1135 b 447 -1082 473 -1110 462 -1095 b 426 -1064 440 -1075 430 -1070 b 406 -1053 420 -1061 413 -1053 b 385 -1064 396 -1053 391 -1061 b 379 -1075 382 -1067 379 -1070 b 364 -1117 370 -1085 364 -1102 b 365 -1127 364 -1120 365 -1124 b 435 -1196 374 -1170 409 -1196 m 540 -966 l 540 -956 b 528 -925 540 -944 535 -930 b 473 -903 514 -911 493 -903 b 430 -937 452 -906 433 -914 b 455 -983 430 -956 442 -970 b 490 -1014 465 -993 476 -1005 b 508 -1021 497 -1018 503 -1021 b 540 -966 531 -1021 538 -986 m 648 1322 b 468 946 538 1315 468 1089 b 470 902 468 930 469 916 b 484 833 470 893 476 867 b 736 1179 634 946 717 1063 b 738 1208 738 1189 738 1198 b 648 1322 738 1284 694 1322 m 116 35 l 116 21 b 522 -290 123 -223 370 -290 b 615 -279 561 -290 594 -286 l 540 165 b 375 8 447 150 375 104 l 375 -6 b 468 -143 379 -62 440 -132 b 489 -168 480 -148 489 -160 b 470 -179 489 -175 483 -179 b 442 -175 463 -179 454 -178 b 293 11 379 -153 315 -83 b 286 70 288 31 286 50 b 508 351 286 195 382 315 l 473 568 b 116 35 293 437 116 266 m 675 -262 b 822 -52 770 -221 822 -150 l 822 -36 b 602 171 816 80 717 171 l 596 171 b 675 -262 626 14 652 -137 "};
Vex.Flow.Font.glyphs.noteheadDoubleWholeSquare={x_min:0,x_max:746,ha:746,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 724 350 b 746 328 736 350 746 340 l 746 -328 b 724 -350 746 -339 736 -350 b 701 -328 711 -350 701 -339 l 701 -270 b 659 -234 701 -253 683 -234 l 83 -234 b 45 -276 67 -234 45 -256 l 45 -328 b 22 -350 45 -339 35 -350 b 0 -328 10 -350 0 -339 l 0 328 b 22 350 0 340 10 350 b 45 328 35 350 45 340 l 45 260 b 77 218 45 260 64 218 l 659 218 b 701 265 679 218 701 232 l 701 328 b 724 350 701 340 711 350 m 45 18 l 45 -36 b 146 -94 45 -70 83 -94 l 606 -94 b 701 -36 664 -94 701 -77 l 701 28 b 606 78 701 57 664 78 l 139 78 b 45 18 71 78 45 59 "};
Vex.Flow.Font.glyphs.noteheadQuadWholeSquare={x_min:0,x_max:746,ha:746,o:"0 0 117 0 1 1 560 560 1 -1 0 -1120 m 724 350 b 746 328 736 350 746 340 l 746 -1428 b 724 -1450 746 -1439 736 -1450 b 701 -1428 711 -1450 701 -1439 l 701 -270 b 659 -234 701 -253 683 -234 l 83 -234 b 45 -276 67 -234 45 -256 l 45 -328 b 22 -350 45 -339 35 -350 b 0 -328 10 -350 0 -339 l 0 328 b 22 350 0 340 10 350 b 45 328 35 350 45 340 l 45 260 b 77 218 45 260 64 218 l 659 218 b 701 265 679 218 701 232 l 701 328 b 724 350 701 340 711 350 m 45 18 l 45 -36 b 146 -94 45 -70 83 -94 l 606 -94 b 701 -36 664 -94 701 -77 l 701 28 b 606 78 701 57 664 78 l 139 78 b 45 18 71 78 45 59 "};
Vex.Flow.Font.glyphs.restDoubleWhole={x_min:0,x_max:640,ha:202,o:"0 0 133 0 1 1 640 640 2 -2 0 -1280 m 200 24 b 173 0 200 11 189 0 l 26 0 b 0 24 11 0 0 11 l 0 376 b 26 400 0 389 11 400 l 173 400 b 200 376 189 400 200 389 l 200 24 "};Vex.Flow.clefProperties.values.octave={line_shift:3.5};Vex.Flow.Clef.types.octave={code:"gClef8vb",point:40,line:3};Vex.Flow.Clef.types.treble={code:"gClef",point:40,line:3};Vex.Flow.Curve.prototype.renderCurve=function(a){var c=this.context,b=this.render_options.cps,
e=this.render_options.x_shift,f=this.render_options.y_shift*a.direction,d=a.first_x+e,h=a.first_y+f+(this.render_options.y_shift_start||0),e=a.last_x-e,f=a.last_y+f+(this.render_options.y_shift_end||0),g=this.render_options.thickness,m=(e-d)/(b.length+2);c.beginPath();c.moveTo(d,h);c.bezierCurveTo(d+m+b[0].x,h+b[0].y*a.direction,e-m+b[1].x,f+b[1].y*a.direction,e,f);c.bezierCurveTo(e-m+b[1].x,f+(b[1].y+g)*a.direction,d+m+b[0].x,h+(b[0].y+g)*a.direction,d,h);c.stroke();c.closePath();c.fill()};Vex.Flow.Annotation=
function(){function a(a){0<arguments.length&&this.init(a)}function c(){a.DEBUG&&Vex.L("Vex.Flow.Annotation",arguments)}a.Justify={LEFT:1,CENTER:2,RIGHT:3,CENTER_STEM:4};a.VerticalJustify={TOP:1,CENTER:2,BOTTOM:3,CENTER_STEM:4};a.DEFAULT_FONT_SIZE=10;var b=Vex.Flow.Modifier;Vex.Inherit(a,b,{init:function(b){a.superclass.init.call(this);this.index=this.note=null;this.text_line=0;this.text=b;this.justification=a.Justify.CENTER;this.vert_justification=a.VerticalJustify.TOP;this.font={family:"Arial",size:a.DEFAULT_FONT_SIZE,
weight:""};this.line_spacing=1.1;this.setWidth(Vex.Flow.textWidth(b))},setLineSpacing:function(a){this.line_spacing=a;return this},getCategory:function(){return"annotations"},setTextLine:function(a){this.text_line=a;return this},setFont:function(a,b,c){this.font={family:a,size:b,weight:c};return this},setVerticalJustification:function(a){this.vert_justification=a;return this},getJustification:function(){return this.justification},setJustification:function(a){this.justification=a;return this},draw:function(){if(!this.context)throw new Vex.RERR("NoContext",
"Can't draw text annotation without a context.");if(!this.note)throw new Vex.RERR("NoNoteForAnnotation","Can't draw text annotation without an attached note.");var e=this.note.getModifierStartXY(b.Position.ABOVE,this.index);this.context.save();this.context.setFont(this.font.family,this.font.size,this.font.weight);var f=this.context.measureText(this.text).width,d=this.context.measureText("M").width,h,e=this.justification==a.Justify.LEFT?e.x:this.justification==a.Justify.RIGHT?e.x-f:this.justification==
a.Justify.CENTER?e.x-f/2:this.note.getStemX()-f/2,g,m,k,l=this.note.hasStem();h=this.note.getStave();l&&(g=this.note.getStemExtents(),m=h.getSpacingBetweenLines());k=this.font.size/a.DEFAULT_FONT_SIZE*this.line_spacing;this.vert_justification==a.VerticalJustify.BOTTOM?(h=h.getYForBottomText(this.text_line,k),l&&(g=1===this.note.getStemDirection()?g.baseY:g.topY,h=Math.max(h,g+(m*(this.text_line+1)*k+m*this.text_line)))):this.vert_justification==a.VerticalJustify.CENTER?(m=this.note.getYForTopText(this.text_line)-
1,g=h.getYForBottomText(this.text_line),h=m+(g-m)/2+d/2):this.vert_justification==a.VerticalJustify.TOP?(h=Math.min(h.getYForTopText(this.text_line),this.note.getYs()[0]-10),l&&(h=Math.min(h,g.topY-5-m*this.text_line))):(m=this.note.getStemExtents(),h=m.topY+(m.baseY-m.topY)/2+d/2);this.x=e;this.y=h;this.text_height=d;this.text_width=f;c("Rendering annotation: ",this.text,e,h);this.context.fillText(this.text,e,h);this.context.restore()}});return a}();Vex.Flow.StaveTie=function(){function a(a,b){0<
arguments.length&&this.init(a,b)}a.prototype={init:function(a,b){this.notes=a;this.context=null;this.text=b;this.render_options={cp1:8,cp2:12,text_shift_x:0,first_x_shift:0,last_x_shift:0,y_shift:7,tie_spacing:0,font:{family:"Arial",size:10,style:""}};this.font=this.render_options.font;this.setNotes(a)},setContext:function(a){this.context=a;return this},setFont:function(a){this.font=a;return this},setNotes:function(a){if(!a.first_note&&!a.last_note)throw new Vex.RuntimeError("BadArguments","Tie needs to have either first_note or last_note set.");
a.first_indices||(a.first_indices=[0]);a.last_indices||(a.last_indices=[0]);if(a.first_indices.length!=a.last_indices.length)throw new Vex.RuntimeError("BadArguments","Tied notes must have similar index sizes");this.first_note=a.first_note;this.first_indices=a.first_indices;this.last_note=a.last_note;this.last_indices=a.last_indices;return this},isPartial:function(){return!this.first_note||!this.last_note},setDir:function(a){this.curvedir=a},getDir:function(){return this.curvedir},renderTie:function(a){if(0===
a.first_ys.length||0===a.last_ys.length)throw new Vex.RERR("BadArguments","No Y-values to render");this.curvedir?a.direction="above"===this.curvedir?-1:1:this.curvedir=a.direction;var b=this.context,e=this.render_options.cp1,f=this.render_options.cp2;10>Math.abs(a.last_x_px-a.first_x_px)&&(e=2,f=8);for(var d=this.render_options.first_x_shift,h=this.render_options.last_x_shift,g=this.render_options.y_shift*a.direction,m=0;m<this.first_indices.length;++m){var k=(a.last_x_px+h+(a.first_x_px+d))/2,l=
a.first_ys[this.first_indices[m]]+g,n=a.last_ys[this.last_indices[m]]+g;if(isNaN(l)||isNaN(n))throw new Vex.RERR("BadArguments","Bad indices for tie rendering.");var p=(l+n)/2+e*a.direction,q=(l+n)/2+f*a.direction;b.beginPath();b.moveTo(a.first_x_px+d,l);b.quadraticCurveTo(k,p,a.last_x_px+h,n);b.quadraticCurveTo(k,q,a.first_x_px+d,l);b.closePath();b.fill()}},renderText:function(a,b){if(this.text){var e;e=(a+b)/2-this.context.measureText(this.text).width/2;this.context.save();this.context.setFont(this.font.family,
this.font.size,this.font.style);this.context.fillText(this.text,e+this.render_options.text_shift_x,(this.first_note||this.last_note).getStave().getYForTopText()-1);this.context.restore()}},draw:function(){if(!this.context)throw new Vex.RERR("NoContext","No context to render tie.");var a=this.first_note,b=this.last_note,e,f,d,h;a?(e=a.getTieRightX()+this.render_options.tie_spacing,h=a.getStemDirection(),d=a.getYs()):(e=b.getStave().getTieStartX(),d=b.getYs(),this.first_indices=this.last_indices);b?
(f=b.getTieLeftX()+this.render_options.tie_spacing,h=b.getStemDirection(),a=b.getYs()):(f=a.getStave().getTieEndX(),a=a.getYs(),this.last_indices=this.first_indices);this.renderTie({first_x_px:e,last_x_px:f,first_ys:d,last_ys:a,direction:h});this.renderText(e,f);return!0}};return a}();Vex.Flow.NoteHead.prototype.draw=function(){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw without a canvas context.");var a=this.context,c=this.getAbsoluteX(),b=this.y,e=this.stem_direction,f=this.render_options.glyph_font_scale,
d=this.line;if((0>=d||6<=d)&&"r"!==this.note_type){var h=b,g=Math.floor(d);0>d&&-.5==g-d?h-=5:6<d&&-.5==g-d&&(h+=5);a.fillRect(c-this.render_options.stroke_px,h,this.getGlyph().head_width+2*this.render_options.stroke_px,1)}"s"==this.note_type?drawSlashNoteHead(a,this.duration,c,b,e):this.style?(a.save(),this.applyStyle(a),Vex.Flow.renderGlyph(a,c,b,f,this.glyph_code),a.restore()):Vex.Flow.renderGlyph(a,c,b,f,this.glyph_code)};Vex.Flow.Beam.prototype.init=function(a,c){if(!a||a==[])throw new Vex.RuntimeError("BadArguments",
"No notes provided for beam.");if(1==a.length)throw new Vex.RuntimeError("BadArguments","Too few notes for beam.");this.ticks=a[0].getIntrinsicTicks();if(this.ticks>=Vex.Flow.durationToTicks("4"))throw new Vex.RuntimeError("BadArguments","Beams can only be applied to notes shorter than a quarter note.");var b,e;this.stem_direction=1;for(b=0;b<a.length;++b)if(e=a[b],e.hasStem()){this.stem_direction=e.getStemDirection();break}var f=-1;if(c&&"stavenotes"===a[0].getCategory()){this.min_line=1E3;for(b=
0;b<a.length;++b)e=a[b],e.getKeyProps&&(e=e.getKeyProps(),this.min_line=Math.min((e[0].line+e[e.length-1].line)/2,this.min_line));3>this.min_line&&(f=1)}else c&&"tabnotes"===a[0].getCategory()&&(f=-1<a.reduce(function(a,b){return a+b.stem_direction},0)?1:-1);for(b=0;b<a.length;++b)e=a[b],c&&(e.setStemDirection(f),this.stem_direction=f),e.setBeam(this);this.postFormatted=!1;this.notes=a;this.beam_count=this.getBeamCount();this.break_on_indices=[];this.render_options={beam_width:5,max_slope:.25,min_slope:-.25,
slope_iterations:20,slope_cost:100,show_stemlets:!1,stemlet_extension:7,partial_beam_length:10}};Vex.Flow.Beam.prototype.calculateSlope=function(){for(var a=this.notes[0],c=a.getStemExtents().topY,a=a.getStemX(),b=(this.render_options.max_slope-this.render_options.min_slope)/this.render_options.slope_iterations,e=Number.MAX_VALUE,f=0,d=0,h=this.render_options.min_slope;h<=this.render_options.max_slope;h+=b){for(var g=0,m=0,k=1;k<this.notes.length;++k){var l=this.notes[k],n=l.getStemX(),l=l.getStemExtents().topY,
n=this.getSlopeY(n,a,c,h)+m;l*this.stem_direction<n*this.stem_direction?(n=Math.abs(l-n),m+=n*-this.stem_direction,g+=n*k):g+=(l-n)*this.stem_direction}k=this.notes[this.notes.length-1];k=(k.getStemExtents().topY-c)/(k.getStemX()-a)/2;k=Math.abs(k-h);g=this.render_options.slope_cost*k+Math.abs(g);g<e&&(e=g,f=h,d=m)}this.slope=f;this.y_shift=d};Vex.Flow.Stave=function(){function a(a,c,f,d){0<arguments.length&&this.init(a,c,f,d)}var c=1<Vex.Flow.STAVE_LINE_THICKNESS?Vex.Flow.STAVE_LINE_THICKNESS:0;
a.prototype={init:function(a,c,f,d){this.x=a;this.y=c;this.width=f;this.start_x=this.getGlyphStartX();this.end_x=this.getGlyphEndX();this.context=null;this.glyphs=[];this.end_glyphs=[];this.modifiers=[];this.measure=0;this.clef="treble";this.font={family:"sans-serif",size:8,weight:""};this.options={vertical_bar_width:10,glyph_spacing_px:10,num_lines:5,fill_style:"#999999",spacing_between_lines_px:10,space_above_staff_ln:4,space_below_staff_ln:4,top_text_position:1};this.bounds={x:this.x,y:this.y,
w:this.width,h:0};Vex.Merge(this.options,d);this.resetLines();this.modifiers.push(new Vex.Flow.Barline(Vex.Flow.Barline.type.SINGLE,this.x));this.modifiers.push(new Vex.Flow.Barline(Vex.Flow.Barline.type.SINGLE,this.x+this.width))},getGlyphStartX:function(){return this.x+5},getGlyphEndX:function(){return this.x+this.width},resetLines:function(){this.options.line_config=[];for(var a=0;a<this.options.num_lines;a++)this.options.line_config.push({visible:!0});this.height=(this.options.num_lines+this.options.space_above_staff_ln)*
this.options.spacing_between_lines_px;this.options.bottom_text_position=this.options.num_lines+1},setNoteStartX:function(a){this.start_x=a;return this},getNoteStartX:function(){var a=this.start_x;this.modifiers[0].barline==Vex.Flow.Barline.type.REPEAT_BEGIN&&2<this.modifiers.length&&(a+=20);return a},getNoteEndX:function(){return this.end_x},getTieStartX:function(){return this.start_x},getTieEndX:function(){return this.x+this.width},setContext:function(a){this.context=a;return this},getContext:function(){return this.context},
setX:function(a){var c;c="number"==typeof this.x?a-this.x:0;console.log("dx: "+c.toString());this.x=a;this.bounds.x=a;this.start_x+=c;for(c=0;c<this.modifiers.length;c++)this.modifiers[c].x=a;return this},getX:function(){return this.x},getNumLines:function(){return this.options.num_lines},setNumLines:function(a){this.options.num_lines=parseInt(a,10);this.resetLines();return this},setY:function(a){this.y=a;return this},setWidth:function(a){this.width=a;this.end_x=this.getGlyphEndX();this.modifiers[1].setX(this.end_x);
return this},getWidth:function(){return this.width},setMeasure:function(a){this.measure=a;return this},setBegBarType:function(a){if(a==Vex.Flow.Barline.type.SINGLE||a==Vex.Flow.Barline.type.REPEAT_BEGIN||a==Vex.Flow.Barline.type.NONE)this.modifiers[0]=new Vex.Flow.Barline(a,this.x);return this},setEndBarType:function(a){a!=Vex.Flow.Barline.type.REPEAT_BEGIN&&(this.modifiers[1]=new Vex.Flow.Barline(a,this.x+this.width));return this},getModifierXShift:function(a){"undefined"===typeof a&&(a=this.glyphs.length-
1);"number"!==typeof a&&new Vex.RERR("InvalidIndex","Must be of number type");for(var c=this.getGlyphStartX(),f=0,d=0;d<a+1;++d)var h=this.glyphs[d],c=c+h.getMetrics().width,f=f+h.getMetrics().width;0<f&&(f+=this.options.vertical_bar_width+10);return f},setRepetitionTypeLeft:function(a,c){this.modifiers.push(new Vex.Flow.Repetition(a,this.x,c));return this},setRepetitionTypeRight:function(a,c){this.modifiers.push(new Vex.Flow.Repetition(a,this.x,c));return this},setVoltaType:function(a,c,f){this.modifiers.push(new Vex.Flow.Volta(a,
c,this.x,f));return this},setSection:function(a,c){this.modifiers.push(new Vex.Flow.StaveSection(a,this.x,c));return this},setTempo:function(a,c){this.modifiers.push(new Vex.Flow.StaveTempo(a,this.x,c));return this},setText:function(a,c,f){this.modifiers.push(new Vex.Flow.StaveText(a,c,f));return this},getHeight:function(){return this.height},getSpacingBetweenLines:function(){return this.options.spacing_between_lines_px},getBoundingBox:function(){return new Vex.Flow.BoundingBox(this.x,this.y,this.width,
this.getBottomY()-this.y)},getBottomY:function(){var a=this.options,c=a.spacing_between_lines_px;return this.getYForLine(a.num_lines)+a.space_below_staff_ln*c},getBottomLineY:function(){return this.getYForLine(this.options.num_lines)},getYForLine:function(a){var e=this.options,f=e.spacing_between_lines_px;return this.y+(a*f+e.space_above_staff_ln*f)-c/2},getYForTopText:function(a,c){return this.getYForLine(-((a||0)*(c||1))-this.options.top_text_position)},getYForBottomText:function(a,c){return this.getYForLine(this.options.bottom_text_position+
(a||0)*(c||1))},getYForNote:function(a){var c=this.options,f=c.spacing_between_lines_px;return this.y+c.space_above_staff_ln*f+5*f-a*f},getYForGlyphs:function(){return this.getYForLine(3)},addGlyph:function(a){a.setStave(this);this.glyphs.push(a);this.start_x+=a.getMetrics().width;return this},addEndGlyph:function(a){a.setStave(this);this.end_glyphs.push(a);this.end_x-=a.getMetrics().width;return this},addModifier:function(a){this.modifiers.push(a);a.addToStave(this,0===this.glyphs.length);return this},
addEndModifier:function(a){this.modifiers.push(a);a.addToStaveEnd(this,0===this.end_glyphs.length);return this},addKeySignature:function(a){this.addModifier(new Vex.Flow.KeySignature(a));return this},addClef:function(a){this.clef=a;this.addModifier(new Vex.Flow.Clef(a));return this},addEndClef:function(a){this.addEndModifier(new Vex.Flow.Clef(a));return this},addTimeSignature:function(a,c){this.addModifier(new Vex.Flow.TimeSignature(a,c));return this},addEndTimeSignature:function(a,c){this.addEndModifier(new Vex.Flow.TimeSignature(a,
c))},addTrebleGlyph:function(){this.clef="treble";this.addGlyph(new Vex.Flow.Glyph("v83",40));return this},draw:function(){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw stave without canvas context.");for(var a=this.options.num_lines,c=this.width,f=this.x,d,h=0;h<a;h++)d=this.getYForLine(h),this.context.save(),this.context.setFillStyle(this.options.fill_style),this.context.setStrokeStyle(this.options.fill_style),this.options.line_config[h].visible&&this.context.fillRect(f,d,c,
Vex.Flow.STAVE_LINE_THICKNESS),this.context.restore();f=this.getGlyphStartX();for(a=0;a<this.glyphs.length;++a)d=this.glyphs[a],d.getContext()||d.setContext(this.context),d.renderToStave(f),f+=d.getMetrics().width;f=this.getGlyphEndX();for(a=0;a<this.end_glyphs.length;++a)d=this.end_glyphs[a],d.getContext()||d.setContext(this.context),f-=d.getMetrics().width,d.renderToStave(f);for(a=0;a<this.modifiers.length;a++)"function"==typeof this.modifiers[a].draw&&this.modifiers[a].draw(this,this.getModifierXShift());
0<this.measure&&(this.context.save(),this.context.setFont(this.font.family,this.font.size,this.font.weight),f=this.context.measureText(""+this.measure).width,d=this.getYForTopText(0)+3,this.context.fillText(""+this.measure,this.x-f/2,d),this.context.restore());return this},drawVertical:function(a,c){this.drawVerticalFixed(this.x+a,c)},drawVerticalFixed:function(a,c){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw stave without canvas context.");var f=this.getYForLine(0),d=this.getYForLine(this.options.num_lines-
1);c&&this.context.fillRect(a-3,f,1,d-f+1);this.context.fillRect(a,f,1,d-f+1)},drawVerticalBar:function(a){this.drawVerticalBarFixed(this.x+a,!1)},drawVerticalBarFixed:function(a){if(!this.context)throw new Vex.RERR("NoCanvasContext","Can't draw stave without canvas context.");var c=this.getYForLine(0),f=this.getYForLine(this.options.num_lines-1);this.context.fillRect(a,c,1,f-c+1)},getConfigForLines:function(){return this.options.line_config},setConfigForLine:function(a,c){if(a>=this.options.num_lines||
0>a)throw new Vex.RERR("StaveConfigError","The line number must be within the range of the number of lines in the Stave.");if(!c.hasOwnProperty("visible"))throw new Vex.RERR("StaveConfigError","The line configuration object is missing the 'visible' property.");if("boolean"!==typeof c.visible)throw new Vex.RERR("StaveConfigError","The line configuration objects 'visible' property must be true or false.");this.options.line_config[a]=c;return this},setConfigForLines:function(a){if(a.length!==this.options.num_lines)throw new Vex.RERR("StaveConfigError",
"The length of the lines configuration array must match the number of lines in the Stave");for(var c in a)a[c]||(a[c]=this.options.line_config[c]),Vex.Merge(this.options.line_config[c],a[c]);this.options.line_config=a;return this}};return a}();var q=function(a,c,b,e,f){a.Util={attsToObj:function(a){var b,c={};if(a.hasAttributes())for(b=a.attributes.length;b--;)c[a.attributes[b].nodeName]=a.attributes[b].nodeValue;return c},attsToString:function(a){var b="",c,e,f;if(a.hasAttributes())for(e=a.attributes,
a=0,c=e.length;a<c;a+=1)f=e.item(a),b+=" "+f.nodeName+'="'+f.nodeValue+'"';return b},drawBoundingBoxes:function(a,b){var c,f,k,g,n,p,q;b=b||{};a.save();if(b.staffs&&b.staffs.data)for(c=0,f=b.staffs.data.length;c<f;c+=1)if(n=b.staffs.data[c])for(k=0,g=n.length;k<g;k+=1)n[k]&&(p=n[k],n[k].getBoundingBox().draw(a),q={x:p.getNoteStartX(),y:p.getYForLine(0)-30,w:p.getNoteEndX()-p.getNoteStartX(),h:p.getYForLine(4)-p.getYForLine(0)+60},this.drawRectangle(q,"120, 80, 200",a,b.frame),q={x:p.x,y:p.getYForLine(0)-
30,w:p.getModifierXShift(),h:p.getYForLine(4)-p.getYForLine(0)+60},this.drawRectangle(q,"100, 100, 0",a,b.frame));b.voices&&b.voices.data&&e.each(b.voices.data,function(){this&&this.all_voices&&e.each(this.all_voices,function(){this&&this.voice&&(this.voice.boundingBox&&b.voices.drawFrame&&this.voice.getBoundingBox().draw(a),b.voices.drawTickables&&e.each(this.voice.tickables,function(){this.getBoundingBox().draw(a)}))})});a.restore()},drawRectangle:function(a,b,c,e){e&&(c.strokeStyle="rgba("+b+", 0.5)",
c.rect(a.x,a.y,a.w,a.h));c.fillStyle="rgba("+b+", 0.1)";c.fillRect(a.x,a.y,a.w,a.h);c.stroke()}};return a}(q||{},g,Vex.Flow,jQuery),H={enabled:!1,setEnabled:function(a){this.enabled=a},log:function(){this.enabled&&Vex.L("MEISnippetViewer",arguments)}},E={initXmlDoc:function(a){return"string"===typeof a?this.parseXML(a):a[0]||a},parseXML:function(a){var c;window.DOMParser?(c=new DOMParser,c=c.parseFromString(a,"text/xml")):(c=new ActiveXObject("Microsoft.XMLDOM"),c.async=!1,c.loadXML(a));return c},
ascertainDescendantIds:function(a,c){var b,e=a.getElementsByTagName("*");for(b=e.length;b--;)e[b].hasAttribute("xml:id")||e[b].setAttribute("xml:id",c+b)},getMEIPageConfig:function(a){a=A.Util.attsToObj(a);var c=function(a){return isNaN(a)||0===a.length?C:+a};return{page_scale:parseInt(a["page.scale"],10)/100||C,page_height:c(a["page.height"]),page_width:c(a["page.width"]),page_margin_top:c(a["page.topmar"]),page_margin_left:c(a["page.leftmar"]),page_margin_right:c(a["page.rightmar"])}}},s=function(a,
c){this.error_code=a;this.message=c};s.prototype.toString=function(){return'MSV.RuntimeError, code "'+this.error_code+'": '+this.message};var I=function(){this.init()};I.prototype={init:function(){this.mouseClickHandlers=[];this.mouseMoveHandlers=[];this.vexLayerIndex=null},createLayers:function(a){var c,b,e,f,d,h,g,m;e=!1;this.scale=a.page_scale;var k=a.target[0]||a.target;m=a.layers;c=a.page_height*a.page_scale;b=a.page_width*a.page_scale;for(h=m.length;h--;)"vex"===m[h].type&&(e=!0);e||(H.log("UI.createLayers()",
"No VexFlow layer specified. Adding it."),m.push({type:"vex"}));g=this.createOuterDiv(b);g.appendChild(innerDiv=this.createInnerDiv(b,c));d=0;for(h=m.length;d<h;d++){e=this.createCanvas(b,c);innerDiv.appendChild(e);if("vex"===m[d].type)this.vexLayerIndex=d,f=this.createVexContext(e,a.backend),m[d].element=e,m[d].ctx=f;else if("highlighter"===m[d].type)f=e.getContext("2d"),m[d].setElement(e),m[d].setContext(f),m[d].setScale(a.page_scale);else throw new s("Configuration Error",'Layer type "'+m[d].type+
'" not valid.');this.scaleContext(f,a)}k.appendChild(g);this.topCanvas=m[m.length-1].element;return m},createCanvas:function(a,c){var b=document.createElement("canvas");b.width=a;b.height=c;b.style.position="absolute";b.style.background="transparent";return b},createOuterDiv:function(a){var c=document.createElement("div");c.className="outer-container";c.style.marginLeft=a/2+"px";c.style.marginRight=a/2+"px";return c},createInnerDiv:function(a,c){var b=document.createElement("div");b.className="inner-container";
b.style.position="relative";b.style.width="100%";b.style.margin="auto";b.style.height=c+"px";b.style.left=-a/2+"px";return b},createVexContext:function(a,c){return(new t.Renderer(a,c||t.Renderer.Backends.CANVAS)).getContext()},scaleContext:function(a,c){var b,e,f;+c.backend===t.Renderer.Backends.RAPHAEL?(b=a.paper,f=c.page_height,e=c.page_width,b.setSize(e*scale,f*scale),b.setViewBox(0,0,e,f)):a.scale(this.scale,this.scale)},registerMouseClickHandler:function(a){this.mouseClickHandlers.push(a)},registerMouseMoveHandler:function(a){this.mouseMoveHandlers.push(a)},
listenMouseClick:function(){var a=this;p(a.topCanvas).on("click",function(c){var b,e;b=p(this).offset();b={x:(c.pageX-b.left)/a.scale,y:(c.pageY-b.top)/a.scale};for(e=a.mouseClickHandlers.length;e--&&!1!==a.mouseClickHandlers[e].onClick(b,a.topCanvas,c););})},listenMouseMove:function(){var a=this;a.topCanvas.onmouseleave=function(c){for(var b=a.mouseMoveHandlers.length;b--;)a.mouseMoveHandlers[b].removeHighlight(),a.mouseMoveHandlers[b].mouseLeaveHandler&&a.mouseMoveHandlers[b].mouseLeaveHandler(null,
a.topCanvas,c)};a.topCanvas.addEventListener("mousemove",function(c){var b,e;b=p(this).offset();b={x:(c.pageX-b.left)/a.scale,y:(c.pageY-b.top)/a.scale};for(e=a.mouseMoveHandlers.length;e--&&!1!==a.mouseMoveHandlers[e].onMouseMove(b,a.topCanvas,c););})}};var J=function(a){this.viewer=a};J.prototype={setAreas:function(a,c){var b,e,f;this.measureAreas=[];this.barlineAreas=[];this.measureModifierAreas=[];this.noteAreas=[];this.variantAreas=[];this.anchoredTextAreas=[];this.pgHeadAreas=[];var d={measures:[],
variants:[],notes:[],barlines:[],measure_modifiers:[],anchoredTexts:[],pgHead:[]},h;for(b=c.length;b--;)if(f=c[b],"highlighter"===f.type)for(e=f.content.length;e--;)if(h=d[f.content[e]])h.push(f);else throw new s("Configuration Error",'Area type "'+f.content[e]+'" is not supported');b=d.measures.length;e=d.barlines.length;f=d.measure_modifiers.length;if(0<b||0<e||0<f){for(this.calculateMeasureAreas(this.viewer.allVexMeasureStaffs);b--;)d.measures[b].addAreas(this.measureAreas);for(;e--;)d.barlines[e].addAreas(this.barlineAreas);
for(;f--;)d.measure_modifiers[f].addAreas(this.measureModifierAreas)}b=d.notes.length;if(0<b)for(this.calculateNoteAreas(this.viewer.converter.getNotes());b--;)d.notes[b].addAreas(this.noteAreas);b=d.anchoredTexts.length;if(0<b)for(this.calculateAnchoredTextAreas(this.viewer.anchoredTexts.getAll());b--;)d.anchoredTexts[b].addAreas(this.anchoredTextAreas);b=d.pgHead.length;if(0<b&&this.viewer.pgHead)for(this.calculatePgHeadAreas(this.viewer.pgHead.getTextsByLine());b--;)d.pgHead[b].addAreas(this.pgHeadAreas);
b=d.variants.length;if(0<b)for(this.getVariantCoordinates(a);b--;)d.variants[b].addAreas(this.variantAreas);for(b=c.length;b--;)"highlighter"===c[b].type&&c[b].initHighlights()},calculateMeasureAreas:function(a){var c,b,e,f,d,h,g,m,k;c=0;for(b=a.length;c<b;c+=1)if(a[c])for(e=0,f=a[c].length;e<f;e+=1)if(d=a[c][e])h=d.x,g=d.y,m=d.width,k=d.getBottomY()-20,this.measureAreas.push({ctx:{x:h,y:g,w:m,h:k-g,x1:h+m,y1:k},measureN:c,staffN:e}),h=d.getYForLine(0)-5,g=d.getYForLine(4)-h+10,this.calculateBarlineAreas(d,
h,g),this.calculateStaffModifierAreas(d,h,g)},calculateBarlineAreas:function(a,c,b){7!==a.modifiers[0].barline&&this.barlineAreas.push(this.createNoteAreaObj(a.modifiers[0].x-8,c,16,b,null,1));7!==a.modifiers[1].barline&&this.barlineAreas.push(this.createNoteAreaObj(a.modifiers[1].x-8,c,16,b,null,1))},calculateStaffModifierAreas:function(a,c,b){var e=a.modifiers,f,d,h;d=e.length;console.log(a);2<a.modifiers.length&&a.getGlyphStartX();for(f=2;f<d;f+=1)e[f]instanceof t.Clef?console.log("clef:"):e[f]instanceof
t.KeySignature?console.log("keysig:"):e[f]instanceof t.TimeSignature&&console.log("timesig:"),console.log(e[f]);d=a.glyphs.length;var e=a.getGlyphStartX(),g;for(f=0;f<d;f++)g=a.glyphs[f],h=g.getMetrics().width,console.log(g.getMetrics()),g.code&&this.measureModifierAreas.push(this.createNoteAreaObj(e,c-15,h,b+30,null,f)),e+=h;d=a.end_glyphs.length;e=a.getGlyphEndX();for(f=0;f<d;f++)g=a.end_glyphs[f],g.code&&(h=g.getMetrics().width,e-=h,this.measureModifierAreas.push(this.createNoteAreaObj(e,c-15,
h,b+30,null,f)))},calculateNoteAreas:function(a){var c,b,e,f,d,h;for(c in a)b=a[c].vexNote,h=a[c].meiNote,e=b.getBoundingBox(),f=b.getAbsoluteX()-10,d=e.y-10,e=e.h+20,this.noteAreas.push(this.createNoteAreaObj(f,d,30,e,h,c)),this.calculateNoteModifierAreas(b)},createNoteAreaObj:function(a,c,b,e,f,d){return{ctx:{x:a,y:c,w:b,h:e,x1:a+b,y1:c+e},meiElement:f,xmlid:d}},calculateAnchoredTextAreas:function(a){for(i=a.length;i--;)this.anchoredTextAreas.push(a[i].getArea())},calculatePgHeadAreas:function(a){var c,
b,e;for(b=a.length;b--;)for(e=a[b],c=e.length;c--;)this.pgHeadAreas.push(e[c].getArea())},calculateNoteModifierAreas:function(a){a=a.modifiers;var c,b,e,f,d;for(c=a.length;c--;)switch(b=a[c].getCategory(),b){case "annotations":b=a[c].x-6;e=a[c].y-20;f=a[c].text_width+12;d=30;this.noteAreas.push(this.createNoteAreaObj(b,e,f,d,a[c].getMeiElement(),c));break;case "articulations":d=f=a[c].width+8,b=a[c].x-f/2-a[c].articulation.shift_right,e=a[c].y-d/2-a[c].articulation.shift_down,this.noteAreas.push(this.createNoteAreaObj(b,
e,f,d,a[c].getMeiElement(),c))}},calculateNoteModifierArea:function(){},calculateNoteArea:function(a,c){var b,e,f;b=a[c].vexNote;e=b.getBoundingBox();b=b.getAbsoluteX()-10;f=e.y-10;e=e.h+20;return{ctx:{x:b,y:f,w:30,h:e,x1:b+30,y1:f+e},xmlid:c}},getSurroundingArea:function(a){var c=a.length,b,e=[];for(b={x:1E4,y:1E4,x1:0,y1:0};c--;)e.push(a[c].xmlid),b.x=Math.min(b.x,a[c].ctx.x),b.y=Math.min(b.y,a[c].ctx.y),b.x1=Math.max(b.x1,a[c].ctx.x1),b.y1=Math.max(b.y1,a[c].ctx.y1);b.w=b.x1-b.x;b.h=b.y1-b.y;return{ctx:b,
xmlids:e}},getVariantCoordinates:function(a){var c,b,e,f,d;d=[];for(c in a.ALTs)d.push({alt:a.ALTs[c],grp:this.getVariantIds(a.ALTs[c])});for(c=d.length;c--;){a=d[c].grp;f=[];for(b in a)(e=this.getIdCoordinates(b,a[b]))&&f.push(e);a=this.getSurroundingArea(f);a.alt=d[c].alt;this.variantAreas.push(a)}},getVariantIds:function(a){var c,b,e;e=a.getDefaultItem();a={};if(e)b=e.elem;else for(b in meiDoc.ALTs[c].altitems){b=meiDoc.ALTs[c].altitems[b].elem;break}var f=b.getElementsByTagName("*");c=0;for(b=
f.length;c<b;c+=1)if(e=f[c].getAttribute("xml:id"))a[e]=f[c].localName;return a},getIdCoordinates:function(a,c){switch(c){case "note":return this.calculateNoteArea(this.viewer.converter.getNotes(),a);case "rest":return this.calculateNoteArea(this.viewer.converter.getNotes(),a);case "mRest":return this.calculateNoteArea(this.viewer.converter.getNotes(),a)}}};var F=function(a,c,b,e,f){this.init(a,c,b,e,f)};F.prototype={init:function(a,c,b,e,f){this.meiElement=a;this.meiNodeMatch=f;c=b?c:p.extend({},
c,A.Util.attsToObj(a));this.x=+c.x;this.y=+c.y;this.textAlign=c.halign||"left";this.text=e===C?p(a).text():e;this.atts=c},setX:function(a){this.x=a},setY:function(a){this.y=a},setTextAlign:function(a){this.textAlign=a},getArea:function(){return{ctx:{x:this.x-6,y:this.y-this.h,w:this.w+12,h:this.h+8,x1:this.x+this.w+6,y1:this.y+8},meiElement:this.meiElement,meiNodeMatch:this.meiNodeMatch,xmlid:null}},setContext:function(a){this.ctx=a;return this},preProcess:function(){var a=this.ctx,c=this.atts;this.font=
c.fontstyle+" "+c.fontweight+" "+c.fontsize+"px "+c.fontfamily;a.font=this.font;this.h=c.fontsize;this.w=a.measureText(this.text).width;return this},draw:function(){this.ctx.textAlign=this.textAlign;this.ctx.font=this.font;this.ctx.fillText(this.text,this.x,this.y)}};var K=function(a){this.font=a;this.allTexts=[]};K.prototype={getAll:function(){return this.allTexts},addText:function(a){this.allTexts.push(new F(a,{fontfamily:this.font.family,fontweight:this.font.weight,fontsize:this.font.size,fontstyle:""}))},
getAncestor:function(a,c){for(;(a=a.parentElement)&&a.localName!==c;);return a},getContainer:function(a,c){var b,e;if(b=this.getAncestor(a,"staff"))if(e=this.getAncestor(b,"measure"))return e=e.getAttribute("n")||"1",b=b.getAttribute("n")||"1",c[e][b];return null},setContext:function(a){this.ctx=a;return this},draw:function(a){var c=this,b,e=c.ctx;p.each(c.allTexts,function(){this.y||(b=c.getContainer(this.meiElement,a),this.setY(b.getYForLine(3)-4+(+this.atts.vo*b.getSpacingBetweenLines()/2||0)));
this.x||(b||(b=c.getContainer(this.meiElement,a)),this.setX(b.getGlyphStartX()+(+this.atts.ho*b.getSpacingBetweenLines()/2||0)));this.setContext(e).preProcess().draw()})}};var L=function(a){this.font=a};L.prototype={addToSystemStarts:function(a){var c,b,e;for(c=a.length;c--;)a[c]&&(b=a[c].getMeasure(0),e=b.getN(),1<e&&(b.getFirstDefinedStaff().setMeasure(e).font=this.font))}};var N=function(a,c){this.init(a,c)};N.prototype={init:function(a,c){this.defaultFontSize=25;this.lineHeight=1.3;this.textsByLine=
[[]];this.line_n=0;this.htmlToArray(a,{fontsize:this.defaultFontSize,fontweight:"",fontstyle:"",fontfamily:"Times"});this.x=c.x;this.y=c.y;this.w=c.w;this.currentCoords=c},getTextsByLine:function(){return this.textsByLine},htmlToArray:function(a,c){var b,e,f,d,h;h=a.childNodes;f=0;for(d=h.length;f<d;f++)if("#text"===h[f].nodeName){if(b=h[f].textContent.replace(/([\n|\r]+\s*)/g,""))e=1===d?null:{type:"child",value:f},this.textsByLine[this.line_n].push(new F(a,c,!0,b,e))}else switch(h[f].localName){case C:break;
case "lb":this.breakLine();break;case "title":b=A.Util.attsToObj(h[f]);e={halign:"center",fontsize:"sub"===b.type?35:50,fontweight:"Bold"};this.htmlToArray(h[f],p.extend({},c,e,b));this.breakLine();break;default:this.htmlToArray(h[f],p.extend({},c,A.Util.attsToObj(h[f])))}},breakLine:function(){this.line_n+=1;this.textsByLine[this.line_n]=[]},setContext:function(a){this.ctx=a;return this},draw:function(){var a=this,c,b,e,f;currentCoords=a.currentCoords;p.each(a.textsByLine,function(){c=[];b=[];e=
[];f=0;p.each(this,function(){this.setContext(a.ctx).preProcess();this.setTextAlign("left");switch(this.atts.halign){case "center":b.push(this);break;case "right":e.push(this);break;default:c.push(this)}});f=Math.max(a.drawCenterTexts(b,currentCoords),a.drawRightAlignedTexts(e,currentCoords),a.drawLeftAlignedTexts(c,currentCoords));currentCoords.y+=f*a.lineHeight})},drawCenterTexts:function(a,c){var b=0,e;for(e=a.length;e--;)b+=a[e].w;return this.drawLeftAlignedTexts(a,{x:c.x+c.w/2-b/2,y:c.y,w:c.w},
this.ctx)},drawRightAlignedTexts:function(a,c){var b=0,e=0,f,d;for(d=a.length;d--;)f=a[d],e+=f.w,f.setX(c.x+c.w-e),f.setY(c.y),f.draw(),b=Math.max(f.h,b);return b},drawLeftAlignedTexts:function(a,c){var b=0,e=0;p.each(a,function(a,d){d.setX(c.x+e);d.setY(c.y);d.draw();e+=d.w;b=Math.max(d.h,b)});return b}};var O=function(a){this.init(a)};O.prototype={defaults:{page_scale:1,page_height:350,page_width:800,autoMeasureNumbers:!1,measureNumberFont:{family:"Times",size:14,weight:"Italic"},anchoredTextFont:{family:"Times",
size:22,weight:""},staff:{fill_style:"#000000"},useMeiLib:!0,checkXmlIds:!0,xmlIdPrefix:"M2V",layers:[]},init:function(a){var c,b,e;if(!a)throw new s("NoConfig","No config passed to Viewer.");if(!a.xmlDoc)throw new s("MissingData","No XML document passed to Viewer.");c=E.initXmlDoc(a.xmlDoc);window.xx=c;b=c.getElementsByTagName("scoreDef")[0];if(!b)throw new s("BadMEIFile","No <scoreDef> found in config.data.");this.cfg=p.extend(!0,{},this.defaults,E.getMEIPageConfig(b),a);this.cfg.checkXmlIds&&E.ascertainDescendantIds(c,
this.cfg.xmlIdPrefix);this.cfg.useMeiLib?(e=new g.MeiDoc(c),e.initSectionView(),this.convertMEI(e.sectionview_score)):this.convertMEI(c);this.UI=new I;a=this.UI.createLayers(this.cfg);this.drawMEI(a[this.UI.vexLayerIndex].ctx);this.areaHelper=new J(this);this.areaHelper.setAreas(e,a);this.registerMouseHandlers(this.UI,a)},registerMouseHandlers:function(a,c){var b,e;for(b=c.length;b--;)e=c[b],"highlighter"===e.type&&(e.clickHandler&&a.registerMouseClickHandler(e),("hover"===e.highlightMode||e.mouseEnterHandler&&
e.mouseLeaveHandler)&&a.registerMouseMoveHandler(e));a.listenMouseClick();a.listenMouseMove()},convertMEI:function(a,c){this.converter=new A.Converter(this.cfg);this.anchoredTexts=new K(this.cfg.anchoredTextFont);var b=a.getElementsByTagName("pgHead")[0];b&&(this.pgHead=new N(b,{x:this.converter.printSpace.left,y:200,w:this.converter.printSpace.width}));this.converter.process(a);this.cfg.autoMeasureNumbers&&(this.measureNumbers=new L(this.cfg.measureNumberFont),this.measureNumbers.addToSystemStarts(this.converter.getSystems()));
this.allVexMeasureStaffs=this.converter.getAllVexMeasureStaffs();for(var b=a.getElementsByTagName("anchoredText"),e=0,f=b.length;e<f;e++)this.anchoredTexts.addText(b[e])},drawMEI:function(a){this.converter.draw(a);this.pgHead&&this.pgHead.setContext(a).draw();this.anchoredTexts.setContext(a).draw(this.allVexMeasureStaffs)}};var G=function(a){};G.prototype={setElement:function(a){throw new s("AbstractAreaCollection","No override for setElement() provided.");},setContext:function(a){throw new s("AbstractAreaCollection",
"No override for setContext() provided.");},setScale:function(a){throw new s("AbstractAreaCollection","No override for setScale() provided.");},addAreas:function(a){throw new s("AbstractAreaCollection","No override for addAreas() provided.");},initHighlights:function(){throw new s("AbstractAreaCollection","No override for initHighlights() provided.");},removeHighlight:function(){throw new s("AbstractAreaCollection","No override for removeHighlight() provided.");},onClick:function(a,c,b){throw new s("AbstractAreaCollection",
"No override for onClick() provided.");},onMouseMove:function(a,c,b){throw new s("AbstractAreaCollection","No override for onMouseMove() provided.");}};var P=function(a){this.init(a)};Vex.Inherit(P,G,{type:"highlighter",emptyArea:{ctx:{x:0,y:0,w:0,h:0}},init:function(a){this.ctx=a.ctx;this.content=a.content;this.highlightMode=a.highlightMode;this.fillStyle=a.fillStyle||"rgba(100, 100, 0, 0.5)";this.clickHandler=a.clickHandler;this.mouseEnterHandler=a.mouseEnterHandler;this.mouseLeaveHandler=a.mouseLeaveHandler;
this.currentHighlight=this.emptyArea;return this},setElement:function(a){this.element=a},setContext:function(a){this.ctx=a;this.ctx.fillStyle=this.fillStyle},setScale:function(a){this.scale=a},getAreas:function(){return this.areas},addAreas:function(a){this.areas?Array.prototype.push.apply(this.areas,a):this.areas=a},initHighlights:function(){"static"===this.highlightMode?this.highlightAll():"hover"===this.highlightMode&&(this.highlightOnHover=!0)},removeHighlight:function(){this.ctx.clearRect(this.currentHighlight.ctx.x-
1,this.currentHighlight.ctx.y-1,this.currentHighlight.ctx.w+2,this.currentHighlight.ctx.h+2)},highlightAll:function(){var a;for(a=this.areas.length;a--;)this.setHighlight(this.areas[a])},onClick:function(a,c,b){return(a=this.getAreaFromPoint(a))?this.clickHandler(a,c,b):!0},onMouseMove:function(a,c,b){(a=this.getAreaFromPoint(a))?this.currentHighlight!==a&&(this.highlightOnHover&&(this.removeHighlight(),this.setHighlight(a)),this.mouseEnterHandler&&this.mouseEnterHandler(a,c,b)):this.currentHighlight!==
this.emptyArea&&(this.highlightOnHover&&(this.removeHighlight(),this.setHighlight(this.emptyArea)),this.mouseLeaveHandler&&this.mouseLeaveHandler(null,c,b))},setHighlight:function(a){this.roundRect(this.ctx,a.ctx.x,a.ctx.y,a.ctx.w,a.ctx.h,5,!0,!1);this.currentHighlight=a},roundRect:function(a,c,b,e,f,d,h,g){"undefined"==typeof g&&(g=!0);"undefined"===typeof d&&(d=5);a.beginPath();a.moveTo(c+d,b);a.lineTo(c+e-d,b);a.quadraticCurveTo(c+e,b,c+e,b+d);a.lineTo(c+e,b+f-d);a.quadraticCurveTo(c+e,b+f,c+e-
d,b+f);a.lineTo(c+d,b+f);a.quadraticCurveTo(c,b+f,c,b+f-d);a.lineTo(c,b+d);a.quadraticCurveTo(c,b,c+d,b);a.closePath();g&&a.stroke();h&&a.fill()},getAreaFromPoint:function(a){var c,b;c=this.areas;for(b=c.length;b--;)if(this.isPointInRect(a,c[b].ctx))return c[b];return null},isPointInRect:function(a,c){return!(a.x<c.x||a.x>c.x1||a.y<c.y||a.y>c.y1)}});Vex.Flow.Annotation.prototype.setMeiElement=function(a){this.meiElement=a;return this};Vex.Flow.Annotation.prototype.getMeiElement=function(){return this.meiElement};
Vex.Flow.Articulation.prototype.setMeiElement=function(a){this.meiElement=a;return this};Vex.Flow.Articulation.prototype.getMeiElement=function(){return this.meiElement};q.Directives.prototype.createVexFromInfos=function(a){var c,b,e,f;for(c=this.allModels.length;c--;)if(b=this.allModels[c],e=a[b.startid])f=(new t.Annotation(p(b.element).text().trim())).setFont(this.font.family,this.font.size,this.font.weight).setMeiElement(b.element),f.setWidth(0),"below"===b.atts.place?e.vexNote.addAnnotation(0,
f.setVerticalJustification(this.BOTTOM)):e.vexNote.addAnnotation(0,f);else throw new A.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");};q.Dynamics.prototype.createVexFromInfos=function(a){var c,b,e,f;for(c=this.allModels.length;c--;)if(b=this.allModels[c],e=a[b.startid])f=(new t.Annotation(p(b.element).text().trim())).setFont(this.font.family,this.font.size,this.font.weight).setMeiElement(b.element),"above"===b.atts.place?e.vexNote.addAnnotation(0,
f):e.vexNote.addAnnotation(0,f.setVerticalJustification(this.BOTTOM));else throw new A.RUNTIME_ERROR("MEI2VF.RERR.createVexFromInfos","The reference in the directive could not be resolved.");};q.Fermatas.prototype.addFermataToNote=function(a,c,b){var e=new t.Articulation(A.tables.fermata[c]);e.setPosition(A.tables.positions[c]);a.addArticulation(b||0,e)};q.Converter.prototype.addArticulation=function(a,c){var b=(new t.Articulation(A.tables.articulations[c.getAttribute("artic")])).setMeiElement(c),
e=c.getAttribute("place");e&&b.setPosition(A.tables.positions[e]);a.addArticulation(0,b)};q.Converter.prototype.processSyllables=function(a,c,b){var e,f,d,h=this,g;c=p(c).find("syl");p.each(c,function(c){e=p(this).text();f=p(this).attr("wordpos");d=p(this).parents("verse").attr("n");g=h.createAnnot(e,h.cfg.lyricsFont).setMeiElement(this).setVerticalJustification(h.BOTTOM).setLineSpacing(h.cfg.lyricsFont.spacing);a.addAnnotation(0,g);h.verses.addSyllable(g,f,d,b);f&&h.hyphenation.addSyllable(g,f,b)})};
t.Articulation.prototype.draw=function(){var a=Vex.Flow.Modifier;if(!this.context)throw new Vex.RERR("NoContext","Can't draw Articulation without a context.");if(!this.note||null===this.index)throw new Vex.RERR("NoAttachedNote","Can't draw Articulation without a note and index.");var c=this.note.getStemDirection(),b=this.note.getStave(),e=this.position===a.Position.ABOVE&&c===Vex.Flow.StaveNote.STEM_DOWN||this.position===a.Position.BELOW&&c===Vex.Flow.StaveNote.STEM_UP,f=this.note.getModifierStartXY(this.position,
this.index),d=f.y,g=0,d=1,p=b.getSpacingBetweenLines(),g="tabnotes"===this.note.getCategory(),m=this.note.getStem().getExtents(),k=m.topY,l=m.baseY;c===Vex.Flow.StaveNote.STEM_DOWN&&(k=m.baseY,l=m.topY);g&&(this.note.hasStem()?c===Vex.Flow.StaveNote.STEM_UP?l=b.getYForBottomText(this.text_line-2):c===Vex.Flow.StaveNote.STEM_DOWN&&(k=b.getYForTopText(this.text_line-1.5)):(k=b.getYForTopText(this.text_line-1),l=b.getYForBottomText(this.text_line-2)));c=this.note.getLineNumber(this.position===a.Position.ABOVE?
!0:!1);!e&&this.note.beam&&(d+=.5);var g=d,m=this.position===a.Position.ABOVE?1:-1,n=this.getNote().getDuration();e||"w"===n||"1"===n||(c+=3.5*m);e=c+m*g;1<=e&&5>=e&&0===e%1&&(d+=.5);this.position===a.Position.ABOVE?(g=this.articulation.shift_up,a=k-7-p*(this.text_line+d),d=this.articulation.between_lines?a:Math.min(b.getYForTopText(this.text_line)-3,a)):(g=this.articulation.shift_down-10,a=l+10+p*(this.text_line+d),d=this.articulation.between_lines?a:Math.max(b.getYForBottomText(this.text_line),
a));b=f.x+this.articulation.shift_right;d+=g+this.y_shift;Vex.Flow.renderGlyph(this.context,b,d,this.render_options.font_scale,this.articulation.code);this.x=b;this.y=d};t.TickContext.prototype.init=function(){this.currentTick=new Vex.Flow.Fraction(0,1);this.maxTicks=new Vex.Flow.Fraction(0,1);this.minTicks=null;this.width=0;this.padding=3;this.x=this.pixelsUsed=0;this.tickables=[];this.extraRightPx=this.extraLeftPx=this.notePx=0;this.align_center=!1;this.tContexts=[];this.ignore_ticks=!0;this.postFormatted=
this.preFormatted=!1;this.context=null};t.TickContext.prototype.getCenterAlignedTickables=function(){return this.tickables.filter(function(a){return a.isCenterAligned()})};t.Tickable.prototype.init=function(){this.intrinsicTicks=0;this.tickMultiplier=new Vex.Flow.Fraction(1,1);this.ticks=new Vex.Flow.Fraction(0,1);this.x_shift=this.width=0;this.modifierContext=this.tickContext=this.voice=null;this.modifiers=[];this.postFormatted=this.preFormatted=!1;this.tuplet=null;this.ignore_ticks=this.align_center=
!1;this.context=null};t.Tickable.prototype.isCenterAligned=function(){return this.align_center};t.Tickable.prototype.setCenterAlignment=function(a){this.align_center=a;return this};t.Tickable.prototype.setDuration=function(a){a=Vex.Flow.RESOLUTION/a.denominator*a.numerator;this.ticks=this.tickMultiplier.clone().multiply(a);this.intrinsicTicks=this.ticks.value()};t.Note.prototype.init=function(a){t.Note.superclass.init.call(this);if(!a)throw new Vex.RuntimeError("BadArguments","Note must have valid initialization data to identify duration and type.");
var c=Vex.Flow.parseNoteData(a);if(!c)throw new Vex.RuntimeError("BadArguments","Invalid note initialization object: "+JSON.stringify(a));this.duration=c.duration;this.dots=c.dots;this.noteType=c.type;a.duration_override?this.setDuration(a.duration_override):this.setIntrinsicTicks(c.ticks);this.modifiers=[];this.glyph=Vex.Flow.durationToGlyph(this.duration,this.noteType);if(this.positions&&("object"!=typeof this.positions||!this.positions.length))throw new Vex.RuntimeError("BadArguments","Note keys must be array type.");
this.modifierContext=this.tickContext=this.playNote=null;this.ignore_ticks=!1;this.right_modPx=this.left_modPx=this.x_shift=this.extraRightPx=this.extraLeftPx=this.width=0;this.voice=null;this.preFormatted=!1;this.ys=[];a.align_center&&this.setCenterAlignment(a.align_center);this.stave=this.context=null;this.render_options={annotation_spacing:5,stave_padding:12}};t.Formatter.prototype.preFormat=function(a,c,b,e){var f=this.tContexts,d=f.list,g=f.map;b&&e&&b.forEach(function(a){a.setStave(e);a.preFormat()});
this.pixelsPerTick=a?a/(this.totalTicks.value()*f.resolutionMultiplier):a=0;var p=0,m=0,k=0,l=k=0,n=null,q=a;this.minTotalWidth=0;var t,s;for(b=0;b<d.length;++b){t=d[b];s=g[t];c&&s.setContext(c);s.preFormat();var A=s.getMetrics(),C=s.getWidth();this.minTotalWidth+=C;var y=0,w=C,k=Math.min((t-k)*this.pixelsPerTick,w),v=p+k;null!=n&&(y=p+l-n.extraLeftPx);v=s.shouldIgnoreTicks()?y+s.getWidth():Math.max(v,y);s.shouldIgnoreTicks()&&a&&(a-=s.getWidth(),this.pixelsPerTick=a/(this.totalTicks.value()*f.resolutionMultiplier));
k=A.extraLeftPx;null!=n&&(m=v-p-(l-n.extraLeftPx));0<b&&0<m&&(k=m>=k?0:k-m);v+=k;s.setX(v);s.setPixelsUsed(w);n=A;l=C;k=t;p=v}this.hasMinTotalWidth=!0;if(0<a)for(c=(q-(p+l))/(this.totalTicks.value()*f.resolutionMultiplier),b=k=f=0;b<d.length;++b)t=d[b],s=g[t],k=(t-k)*c,f+=k,s.setX(s.getX()+f),k=t,s.getCenterAlignedTickables().forEach(function(b){b.x_shift=(a-b.getWidth())/2})};window.MSV={Viewer:O,Logger:H,AbstractAreaCollection:G,DefaultAreaCollection:P,Util:q.Util}})(jQuery,Vex.Flow);
